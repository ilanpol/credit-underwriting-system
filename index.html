<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×—×™×ª×•× ××©×¨××™</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            direction: rtl; 
            color: #2c3e50;
            padding: 20px;
        }

        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }

        .header { 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px; 
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .section { 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .file-upload {
            border: 2px dashed #3498db;
            padding: 20px;
            margin: 10px 0;
            border-radius: 10px;
            text-align: center;
        }

        .file-upload input[type="file"] {
            margin: 10px 0;
            padding: 10px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        .status.empty { background: #e74c3c; color: white; }
        .status.loaded { background: #27ae60; color: white; }
        .status.loading { background: #f39c12; color: white; }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }

        .btn:hover { background: #2980b9; }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }

        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #229954; }

        .results {
            display: none;
            margin-top: 20px;
        }

        .rating-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .rating-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .rating-score {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .rating-AAA { color: #27ae60; }
        .rating-AA { color: #2ecc71; }
        .rating-A { color: #f39c12; }
        .rating-BBB { color: #e67e22; }
        .rating-BB { color: #e74c3c; }
        .rating-B { color: #c0392b; }

        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 9999;
            font-weight: bold;
        }

        .notification.success { background: #27ae60; }
        .notification.error { background: #e74c3c; }
        .notification.warning { background: #f39c12; }

        .debug {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .rating-cards { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦ ××¢×¨×›×ª ×—×™×ª×•× ××©×¨××™</h1>
            <p>×’×¨×¡×” ×¤×©×•×˜×” ×©×¢×•×‘×“×ª</p>
        </div>

        <div class="section">
            <h2>ğŸ“Š ×¡×˜×˜×•×¡ ×§×‘×¦×™×</h2>
            <div>
                <span id="mainStatus" class="status empty">×¢×¡×§××•×ª: ×œ× × ×˜×¢×Ÿ</span>
                <span id="creditStatus" class="status empty">D&B: ×œ× × ×˜×¢×Ÿ</span>
                <span id="warningsStatus" class="status empty">×‘×™×˜×•×œ×™×: ×œ× × ×˜×¢×Ÿ</span>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“ ×”×¢×œ××ª ×§×‘×¦×™×</h2>
            
            <div class="file-upload">
                <h4>ğŸ“ˆ ×§×•×‘×¥ ×¢×¡×§××•×ª ×¨××©×™</h4>
                <input type="file" id="mainFile" accept=".xlsx,.xls,.csv" onchange="loadFile('main')">
            </div>

            <div class="file-upload">
                <h4>ğŸ¢ ×§×•×‘×¥ D&B (scoreM_N)</h4>
                <input type="file" id="creditFile" accept=".xlsx,.xls" onchange="loadFile('credit')">
            </div>

            <div class="file-upload">
                <h4>âš ï¸ ×§×•×‘×¥ ×‘×™×˜×•×œ×™× (××•×¤×¦×™×•× ×œ×™)</h4>
                <input type="file" id="warningsFile" accept=".xlsx,.xls,.csv" onchange="loadFile('warnings')">
            </div>
        </div>

        <div class="section">
            <h2>ğŸ’¼ ×¤×¨×˜×™ ×¢×¡×§×”</h2>
            
            <div class="form-group">
                <label>×©× ××•×©×š (×—×‘×¨×”)</label>
                <input type="text" id="payerName" placeholder="×©× ×”×—×‘×¨×” ×”××•×©×›×ª">
            </div>

            <div class="form-group">
                <label>×—.×¤. ××•×©×š</label>
                <input type="text" id="payerID" placeholder="××¡×¤×¨ ×—.×¤. ×©×œ ×”×—×‘×¨×”">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>×¡×›×•× ×”×©×™×§ (â‚ª)</label>
                    <input type="number" id="checkAmount" placeholder="0" min="0">
                </div>
                <div class="form-group">
                    <label>×™××™ ××©×¨××™</label>
                    <input type="number" id="creditDays" placeholder="30" value="30" min="0">
                </div>
            </div>

            <button class="btn" onclick="calculateRating()" id="calculateBtn" disabled>
                ğŸ§® ×—×©×‘ ×“×™×¨×•×’
            </button>

            <button class="btn btn-success" onclick="loadSampleData()">
                ğŸ“‹ ×˜×¢×Ÿ ×“×•×’××”
            </button>
        </div>

        <div class="section results" id="results">
            <h2>ğŸ“Š ×ª×•×¦××•×ª</h2>
            <div class="rating-cards" id="ratingCards"></div>
            <div id="recommendation"></div>
        </div>

        <div id="debug" class="debug" style="display: none;"></div>
    </div>

    <script>
        let payersData = new Map();
        let dnbData = new Map();
        let mainFileLoaded = false;
        let creditFileLoaded = false;

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
            
            console.log(`${type.toUpperCase()}: ${message}`);
        }

        function updateDebug(message) {
            const debugDiv = document.getElementById('debug');
            debugDiv.style.display = 'block';
            debugDiv.textContent += message + '\n';
            console.log(message);
        }

        async function loadFile(type) {
            const fileInput = document.getElementById(type + 'File');
            const statusElement = document.getElementById(type + 'Status');
            
            if (!fileInput.files[0]) {
                showNotification('×œ× × ×‘×—×¨ ×§×•×‘×¥', 'warning');
                return;
            }

            const file = fileInput.files[0];
            updateDebug(`ğŸ”„ ×˜×•×¢×Ÿ ×§×•×‘×¥ ${type}: ${file.name}`);
            
            statusElement.textContent = `${getTypeName(type)}: ×˜×•×¢×Ÿ...`;
            statusElement.className = 'status loading';

            try {
                const workbook = await readExcelFile(file);
                updateDebug(`âœ… ×§×•×‘×¥ × ×§×¨×: ${workbook.SheetNames.length} ×’×™×œ×™×•× ×•×ª`);
                
                if (type === 'main') {
                    processMainFile(workbook);
                    mainFileLoaded = true;
                    statusElement.textContent = `×¢×¡×§××•×ª: âœ“ × ×˜×¢×Ÿ`;
                    statusElement.className = 'status loaded';
                } else if (type === 'credit') {
                    processCreditFile(workbook);
                    creditFileLoaded = true;
                    statusElement.textContent = `D&B: âœ“ × ×˜×¢×Ÿ`;
                    statusElement.className = 'status loaded';
                } else if (type === 'warnings') {
                    statusElement.textContent = `×‘×™×˜×•×œ×™×: âœ“ × ×˜×¢×Ÿ`;
                    statusElement.className = 'status loaded';
                }
                
                updateCalculateButton();
                showNotification(`×§×•×‘×¥ ${getTypeName(type)} × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”`, 'success');
                
            } catch (error) {
                updateDebug(`âŒ ×©×’×™××”: ${error.message}`);
                statusElement.textContent = `${getTypeName(type)}: ×©×’×™××”`;
                statusElement.className = 'status empty';
                showNotification(`×©×’×™××” ×‘×˜×¢×™× ×ª ×§×•×‘×¥: ${error.message}`, 'error');
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        resolve(workbook);
                    } catch (error) {
                        reject(new Error('×œ× ×”×¦×œ×—×ª×™ ×œ×§×¨×•× ××ª ×”×§×•×‘×¥: ' + error.message));
                    }
                };
                reader.onerror = () => reject(new Error('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥'));
                reader.readAsArrayBuffer(file);
            });
        }

        function processMainFile(workbook) {
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            updateDebug(`ğŸ“Š ××¢×‘×“ ×§×•×‘×¥ ×¢×¡×§××•×ª: ${data.length} ×©×•×¨×•×ª`);
            
            if (data.length < 2) {
                throw new Error('×§×•×‘×¥ ×¨×™×§ ××• ×—×¡×¨×•×ª ×©×•×¨×•×ª × ×ª×•× ×™×');
            }
            
            const headers = data[0];
            const rows = data.slice(1);
            
            // ×—×™×¤×•×© ×¢××•×“×•×ª
            const payerNameIndex = findColumn(headers, ['×©× ××•×©×š', '×—×‘×¨×”', '××•×©×š']);
            const payerIdIndex = findColumn(headers, ['×—.×¤', '×–×”×•×ª ××•×©×š', '××¡×¤×¨ ×–×”×•×ª']);
            const amountIndex = findColumn(headers, ['×¡×›×•×', '×¡×›×•× ×©×™×§']);
            
            updateDebug(`ğŸ“‹ × ××¦××• ×¢××•×“×•×ª: ×©×=${payerNameIndex}, ×—.×¤=${payerIdIndex}, ×¡×›×•×=${amountIndex}`);
            
            payersData.clear();
            
            rows.forEach(row => {
                const payerName = payerNameIndex >= 0 ? row[payerNameIndex] : '';
                const payerId = payerIdIndex >= 0 ? row[payerIdIndex] : '';
                const amount = parseFloat(row[amountIndex]) || 0;
                
                if (payerName && amount > 0) {
                    const id = payerId || payerName;
                    if (!payersData.has(id)) {
                        payersData.set(id, {
                            name: payerName,
                            id: payerId,
                            totalAmount: 0,
                            transactionCount: 0
                        });
                    }
                    
                    const payer = payersData.get(id);
                    payer.totalAmount += amount;
                    payer.transactionCount++;
                }
            });
            
            updateDebug(`âœ… ×¢×•×‘×“×• ${payersData.size} ×—×‘×¨×•×ª ××•×©×›×•×ª`);
        }

        function processCreditFile(workbook) {
            let sheetName = workbook.SheetNames.find(name => 
                name.toLowerCase().includes('score')
            ) || workbook.SheetNames[0];
            
            const worksheet = workbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            updateDebug(`ğŸ¢ ××¢×‘×“ D&B ××’×™×œ×™×•×Ÿ "${sheetName}": ${data.length} ×©×•×¨×•×ª`);
            
            if (data.length < 2) {
                throw new Error('×§×•×‘×¥ D&B ×¨×™×§');
            }
            
            const headers = data[0];
            const rows = data.slice(1);
            
            const companyNameIndex = findColumn(headers, ['×©×', '×—×‘×¨×”']);
            const companyIdIndex = findColumn(headers, ['×—.×¤', '×–×”×•×ª']);
            const scoreIndex = findColumn(headers, ['×¡×§×•×¨']);
            
            updateDebug(`ğŸ“‹ ×¢××•×“×•×ª D&B: ×©×=${companyNameIndex}, ×—.×¤=${companyIdIndex}, ×¡×§×•×¨=${scoreIndex}`);
            
            dnbData.clear();
            
            rows.forEach(row => {
                const name = companyNameIndex >= 0 ? row[companyNameIndex] : '';
                const id = companyIdIndex >= 0 ? row[companyIdIndex] : '';
                const score = parseFloat(row[scoreIndex]) || 0;
                
                if ((name || id) && score > 0) {
                    const record = { name, id, score };
                    if (id) dnbData.set(id, record);
                    if (name) dnbData.set(name, record);
                }
            });
            
            updateDebug(`âœ… ×¢×•×‘×“×• ${dnbData.size} ×¨×©×•××•×ª D&B`);
        }

        function findColumn(headers, searchTerms) {
            for (let term of searchTerms) {
                const index = headers.findIndex(header => 
                    header && header.toString().toLowerCase().includes(term.toLowerCase())
                );
                if (index >= 0) return index;
            }
            return -1;
        }

        function updateCalculateButton() {
            const btn = document.getElementById('calculateBtn');
            btn.disabled = !mainFileLoaded;
        }

        function calculateRating() {
            const payerName = document.getElementById('payerName').value.trim();
            const payerId = document.getElementById('payerID').value.trim();
            const amount = parseFloat(document.getElementById('checkAmount').value) || 0;
            const days = parseInt(document.getElementById('creditDays').value) || 30;
            
            if (!payerName && !payerId) {
                showNotification('× × ×œ×”×–×™×Ÿ ×©× ××• ×—.×¤. ×©×œ ×”××•×©×š', 'warning');
                return;
            }
            
            if (amount <= 0) {
                showNotification('× × ×œ×”×–×™×Ÿ ×¡×›×•× ×ª×§×™×Ÿ', 'warning');
                return;
            }
            
            updateDebug(`ğŸ§® ××—×©×‘ ×“×™×¨×•×’ ×¢×‘×•×¨: ${payerName || payerId}, ×¡×›×•×: ${amount}`);
            
            // ×—×™×¤×•×© ×”×—×‘×¨×”
            const payer = findPayer(payerName, payerId);
            const dnb = findDnbRecord(payerName, payerId);
            
            let score = 50; // ×¦×™×•×Ÿ ×‘×¡×™×¡
            
            // ×¦×™×•×Ÿ ×¢×œ ×‘×¡×™×¡ ×”×™×¡×˜×•×¨×™×”
            if (payer) {
                if (payer.transactionCount >= 10) score += 20;
                else if (payer.transactionCount >= 5) score += 10;
                
                if (payer.totalAmount >= 1000000) score += 15;
                else if (payer.totalAmount >= 500000) score += 10;
                else if (payer.totalAmount >= 100000) score += 5;
            }
            
            // ×¦×™×•×Ÿ D&B
            if (dnb) {
                if (dnb.score >= 80) score += 20;
                else if (dnb.score >= 60) score += 15;
                else if (dnb.score >= 40) score += 10;
                else score -= 10;
            }
            
            // ×”×ª×××ª ×¦×™×•×Ÿ ×œ×’×•×“×œ ×¢×¡×§×”
            if (amount > 500000) score -= 5;
            if (days > 60) score -= 10;
            
            score = Math.max(0, Math.min(100, score));
            
            let rating = 'B';
            if (score >= 85) rating = 'AAA';
            else if (score >= 75) rating = 'AA';
            else if (score >= 65) rating = 'A';
            else if (score >= 55) rating = 'BBB';
            else if (score >= 45) rating = 'BB';
            
            displayResults({
                score: Math.round(score),
                rating,
                payer,
                dnb,
                amount,
                days
            });
        }

        function findPayer(name, id) {
            if (id && payersData.has(id)) return payersData.get(id);
            if (name && payersData.has(name)) return payersData.get(name);
            
            for (let [key, payer] of payersData.entries()) {
                if (name && payer.name && payer.name.includes(name)) return payer;
            }
            return null;
        }

        function findDnbRecord(name, id) {
            if (id && dnbData.has(id)) return dnbData.get(id);
            if (name && dnbData.has(name)) return dnbData.get(name);
            return null;
        }

        function displayResults(result) {
            const resultsDiv = document.getElementById('results');
            const cardsDiv = document.getElementById('ratingCards');
            const recommendationDiv = document.getElementById('recommendation');
            
            cardsDiv.innerHTML = `
                <div class="rating-card">
                    <div class="rating-score rating-${result.rating}">${result.rating}</div>
                    <div>×“×™×¨×•×’ ××©×¨××™</div>
                </div>
                <div class="rating-card">
                    <div class="rating-score">${result.score}</div>
                    <div>×¦×™×•×Ÿ ×›×•×œ×œ</div>
                </div>
                <div class="rating-card">
                    <div class="rating-score">${result.payer ? result.payer.transactionCount : 0}</div>
                    <div>×¢×¡×§××•×ª ×§×•×“××•×ª</div>
                </div>
                <div class="rating-card">
                    <div class="rating-score">${result.dnb ? result.dnb.score : 0}</div>
                    <div>×¦×™×•×Ÿ D&B</div>
                </div>
            `;
            
            let recommendation = '';
            if (result.score >= 75) {
                recommendation = 'âœ… ××•××œ×¥ ×œ××™×©×•×¨';
                recommendationDiv.style.background = '#27ae60';
            } else if (result.score >= 55) {
                recommendation = 'âš ï¸ ×“×•×¨×© ×‘×“×™×§×” × ×•×¡×¤×ª';
                recommendationDiv.style.background = '#f39c12';
            } else {
                recommendation = 'âŒ ×œ× ××•××œ×¥ ×œ××™×©×•×¨';
                recommendationDiv.style.background = '#e74c3c';
            }
            
            recommendationDiv.innerHTML = `
                <h3>${recommendation}</h3>
                <p>×¢×‘×•×¨ ×¢×¡×§×” ×©×œ â‚ª${result.amount.toLocaleString()} ×œ-${result.days} ×™××™×</p>
            `;
            recommendationDiv.style.color = 'white';
            recommendationDiv.style.padding = '20px';
            recommendationDiv.style.borderRadius = '10px';
            recommendationDiv.style.textAlign = 'center';
            recommendationDiv.style.margin = '20px 0';
            
            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
            
            updateDebug(`âœ… ×ª×•×¦××”: ${result.rating} (${result.score} × ×§×•×“×•×ª)`);
        }

        function loadSampleData() {
            // × ×ª×•× ×™ ×“×•×’××”
            payersData.clear();
            dnbData.clear();
            
            // ×—×‘×¨×•×ª ×œ×“×•×’××”
            payersData.set('123456789', {
                name: '××‘×’ ×˜×›× ×•×œ×•×’×™×•×ª ×‘×¢"×',
                id: '123456789',
                totalAmount: 750000,
                transactionCount: 12
            });
            
            payersData.set('987654321', {
                name: '×“×¤×§× ×©×™×¨×•×ª×™× ×‘×¢"×',
                id: '987654321',
                totalAmount: 420000,
                transactionCount: 8
            });
            
            // × ×ª×•× ×™ D&B ×œ×“×•×’××”
            dnbData.set('123456789', { name: '××‘×’ ×˜×›× ×•×œ×•×’×™×•×ª ×‘×¢"×', id: '123456789', score: 85 });
            dnbData.set('987654321', { name: '×“×¤×§× ×©×™×¨×•×ª×™× ×‘×¢"×', id: '987654321', score: 72 });
            
            mainFileLoaded = true;
            creditFileLoaded = true;
            
            document.getElementById('mainStatus').textContent = '×¢×¡×§××•×ª: âœ“ ×“×•×’××”';
            document.getElementById('mainStatus').className = 'status loaded';
            document.getElementById('creditStatus').textContent = 'D&B: âœ“ ×“×•×’××”';
            document.getElementById('creditStatus').className = 'status loaded';
            
            updateCalculateButton();
            showNotification('× ×ª×•× ×™ ×“×•×’××” × ×˜×¢× ×• ×‘×”×¦×œ×—×”', 'success');
            updateDebug('âœ… × ×˜×¢× ×• × ×ª×•× ×™ ×“×•×’××”');
        }

        function getTypeName(type) {
            const names = {
                'main': '×¢×¡×§××•×ª',
                'credit': 'D&B', 
                'warnings': '×‘×™×˜×•×œ×™×'
            };
            return names[type] || type;
        }

        // ××ª×—×•×œ
        document.addEventListener('DOMContentLoaded', function() {
            updateDebug('ğŸ¦ ××¢×¨×›×ª ×—×™×ª×•× ××©×¨××™ ×”×•×¤×¢×œ×”');
            
            if (typeof XLSX === 'undefined') {
                showNotification('×©×’×™××”: ×¡×¤×¨×™×™×ª Excel ×œ× × ×˜×¢× ×”', 'error');
                updateDebug('âŒ ×¡×¤×¨×™×™×ª XLSX ×œ× ×–××™× ×”');
            } else {
                updateDebug('âœ… ×¡×¤×¨×™×™×ª XLSX ×–××™× ×”');
            }
        });
    </script>
</body>
</html>
