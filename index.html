/**
 * מערכת טעינת קבצים מתקדמת
 * מטפל בהעלאה, אימות ועיבוד של קבצי נתונים עסקיים מורכבים
 */

class EnhancedFileLoader {
    constructor() {
        this.supportedFormats = ['.xlsx', '.xls', '.csv'];
        this.maxFileSize = 100 * 1024 * 1024; // 100MB למערכות עסקיות
        this.currentFile = null;
        this.uploadProgress = 0;
        this.expectedHeaders = this.initializeExpectedHeaders();
        this.init();
    }

    // 🚀 אתחול
    init() {
        this.setupEventListeners();
        this.setupDragAndDrop();
        console.log('📁 מערכת טעינת קבצים מתקדמת הותחלה');
    }

    // 📋 רשימת כותרות צפויות
    initializeExpectedHeaders() {
        return [
            // עמודות בסיסיות
            'סוג עיסקה', 'שם לקוח', 'מ.זהות', 'תחום עיסוק לקוח',
            'מספר שיק', 'מזהה שיק', 'ב-ס-ח', 'שם מושך', 'מספר זהות מושך',
            
            // פרטי קשר
            'טלפון 1 מושך', 'טלפון 2 מושך', 'כתובת מושך',
            
            // תאריכים
            'ת.פירעון', 'ת.פרעון בפועל', 'תאריך הפקדה/מסירה', 'תאריך השבה',
            
            // נתונים פיננסיים
            'סכום', 'יתרה', 'עמלה', 'אחוז עמלה', 'אחוז עמלה - חלקי',
            'אחוז השתתפות', 'אחוז רווח',
            
            // מידע נוסף
            'שם מוטב', 'סטטוס', 'יעד', 'איש מכירות', 'קטגוריה',
            'תחום עיסוק מושך', 'מומלץ לגבייה', 'נציג שירות'
        ];
    }

    // 🎯 הגדרת מאזיני אירועים
    setupEventListeners() {
        // אירועי קבצים מרובים
        const fileInputs = [
            'mainExcelFile', 'scoresFile', 'returnedFile', 'warningsFile'
        ];
        
        fileInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('change', (e) => this.handleFileInput(e, inputId));
            }
        });
    }

    // 🖱️ הגדרת Drag & Drop
    setupDragAndDrop() {
        const uploadAreas = document.querySelectorAll('.upload-area, .excel-upload-section');
        
        uploadAreas.forEach(area => {
            area.addEventListener('dragover', (e) => this.handleDragOver(e));
            area.addEventListener('drop', (e) => this.handleDrop(e));
            area.addEventListener('dragenter', (e) => this.handleDragEnter(e));
            area.addEventListener('dragleave', (e) => this.handleDragLeave(e));
        });
    }

    // 📤 העלאת קובץ עם תמיכה בפורמטים מרובים
    async uploadFile(file, progressCallback = null, fileType = 'main') {
        try {
            // אימות קובץ
            const validation = this.validateFile(file);
            if (!validation.isValid) {
                throw new Error(validation.error);
            }

            this.currentFile = file;
            this.uploadProgress = 0;

            console.log(`📁 מתחיל בטעינת קובץ: ${file.name} (${fileType})`);

            // עדכון תצוגת התקדמות
            if (progressCallback) {
                progressCallback(0, `מתחיל בטעינת ${file.name}...`);
            }

            // קריאת הקובץ
            const fileData = await this.readFile(file, progressCallback);
            
            // זיהוי סוג קובץ ועיבוד מתאים
            if (progressCallback) {
                progressCallback(70, 'מעבד נתונים...');
            }

            const processedData = await this.processFileData(fileData, file, fileType);
            
            // אימות נתונים
            const validation_result = this.validateProcessedData(processedData);
            if (!validation_result.isValid) {
                console.warn('⚠️ אזהרות באימות נתונים:', validation_result.warnings);
            }

            if (progressCallback) {
                progressCallback(100, 'הטעינה הושלמה בהצלחה!');
            }

            // רישום פעילות
            if (window.authManager) {
                window.authManager.logActivity('file_upload', 
                    `הועלה קובץ: ${file.name} (${this.formatFileSize(file.size)}) - סוג: ${fileType}`);
            }

            return {
                success: true,
                data: processedData,
                file: file,
                fileType: fileType,
                summary: this.generateDataSummary(processedData),
                validation: validation_result
            };

        } catch (error) {
            console.error('❌ שגיאה בהעלאת קובץ:', error);
            
            if (window.authManager) {
                window.authManager.logActivity('file_upload_error', 
                    `שגיאה בהעלאת קובץ: ${error.message}`);
            }

            return {
                success: false,
                error: error.message,
                fileType: fileType
            };
        }
    }

    // ✅ אימות קובץ מתקדם
    validateFile(file) {
        // בדיקת קיום קובץ
        if (!file) {
            return { isValid: false, error: 'לא נבחר קובץ' };
        }

        // בדיקת גודל קובץ
        if (file.size > this.maxFileSize) {
            return { 
                isValid: false, 
                error: `גודל הקובץ חורג מהמותר (מקסימום: ${this.formatFileSize(this.maxFileSize)})` 
            };
        }

        // בדיקת סוג קובץ
        const fileExtension = this.getFileExtension(file.name);
        if (!this.supportedFormats.includes(fileExtension)) {
            return { 
                isValid: false, 
                error: `סוג קובץ לא נתמך. סוגים נתמכים: ${this.supportedFormats.join(', ')}` 
            };
        }

        // בדיקת הרשאות
        if (window.authManager && !window.authManager.hasPermission('write')) {
            return { 
                isValid: false, 
                error: 'אין הרשאה להעלות קבצים' 
            };
        }

        // בדיקת שם קובץ (מניעת תווים מיוחדים)
        const invalidChars = /[<>:"/\\|?*]/;
        if (invalidChars.test(file.name)) {
            return {
                isValid: false,
                error: 'שם הקובץ מכיל תווים לא חוקיים'
            };
        }

        return { isValid: true };
    }

    // 📖 קריאת קובץ מתקדמת
    async readFile(file, progressCallback = null) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            const fileExtension = this.getFileExtension(file.name);
            
            reader.onload = (e) => {
                try {
                    if (progressCallback) {
                        progressCallback(60, 'קובץ נקרא בהצלחה, מפרסר נתונים...');
                    }
                    resolve(e.target.result);
                } catch (error) {
                    reject(new Error(`שגיאה בפרסור קובץ: ${error.message}`));
                }
            };
            
            reader.onerror = () => {
                reject(new Error('שגיאה בקריאת הקובץ'));
            };
            
            reader.onprogress = (e) => {
                if (e.lengthComputable && progressCallback) {
                    const progress = Math.round((e.loaded / e.total) * 50); // 50% מההתקדמות לקריאה
                    progressCallback(progress, 'קורא קובץ...');
                }
            };

            // בחירת שיטת קריאה לפי סוג הקובץ
            if (fileExtension === '.csv') {
                reader.readAsText(file, 'UTF-8');
            } else if (fileExtension === '.xlsx' || fileExtension === '.xls') {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file, 'UTF-8');
            }
        });
    }

    // 🔄 עיבוד נתוני קובץ מתקדם
    async processFileData(fileData, file, fileType) {
        const fileExtension = this.getFileExtension(file.name);
        
        let processedData;
        switch (fileExtension) {
            case '.csv':
                processedData = await this.processCSV(fileData, file);
                break;
            case '.xlsx':
            case '.xls':
                processedData = await this.processExcel(fileData, file, fileType);
                break;
            default:
                throw new Error('סוג קובץ לא נתמך');
        }

        // הוסף מטאדטה
        processedData.metadata = {
            fileName: file.name,
            fileSize: file.size,
            fileType: fileType,
            uploadTime: new Date(),
            fileExtension: fileExtension
        };

        return processedData;
    }

    // 📊 עיבוד קובץ Excel מתקדם
    async processExcel(excelData, file, fileType) {
        try {
            // בדוק אם XLSX זמין
            if (typeof XLSX === 'undefined') {
                throw new Error('ספריית XLSX לא נטענה. נא לטעון קובץ CSV במקום.');
            }

            console.log('📊 מעבד קובץ Excel...');
            
            const workbook = XLSX.read(excelData, { 
                type: 'array',
                cellStyles: true,
                cellFormulas: true,
                cellDates: true,
                cellNF: true,
                sheetStubs: true
            });

            console.log('📋 גיליונות זמינים:', workbook.SheetNames);

            // קביעת איזה גיליון לקרוא
            let sheetName;
            if (fileType === 'main' && workbook.SheetNames.includes('גיליון1')) {
                sheetName = 'גיליון1';
            } else if (workbook.SheetNames.length > 0) {
                sheetName = workbook.SheetNames[0];
            } else {
                throw new Error('לא נמצאו גיליונות בקובץ');
            }

            console.log(`📄 קורא גיליון: ${sheetName}`);

            const worksheet = workbook.Sheets[sheetName];
            
            // המרה ל-JSON עם שמירת הכותרות
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                header: 1,
                defval: '',
                blankrows: false
            });

            if (jsonData.length === 0) {
                throw new Error('הגיליון ריק או לא מכיל נתונים');
            }

            // הכותרות הן השורה הראשונה
            const headers = jsonData[0].map(header => 
                header ? header.toString().trim() : ''
            ).filter(header => header !== '');

            // הנתונים הם השורות הבאות
            const dataRows = jsonData.slice(1);
            
            // המרת השורות לאובייקטים
            const data = dataRows
                .filter(row => row && row.some(cell => cell !== null && cell !== ''))
                .map((row, index) => {
                    const rowObject = {};
                    headers.forEach((header, colIndex) => {
                        if (header && colIndex < row.length) {
                            let value = row[colIndex];
                            
                            // טיפול מיוחד בתאריכים של Excel
                            if (typeof value === 'number' && this.isExcelDate(value)) {
                                value = this.excelDateToJSDate(value);
                            }
                            
                            rowObject[header] = value !== null && value !== undefined ? value : '';
                        }
                    });
                    rowObject._rowIndex = index + 2; // +2 כי אנחנו מתחילים משורה 2
                    return rowObject;
                });

            console.log(`✅ עובדו ${data.length} רשומות מקובץ Excel`);

            return {
                headers: headers,
                data: data,
                rowCount: data.length,
                fileName: file.name,
                fileSize: file.size,
                fileType: 'Excel',
                sheetName: sheetName,
                availableSheets: workbook.SheetNames
            };

        } catch (error) {
            console.error('❌ שגיאה בעיבוד Excel:', error);
            throw new Error(`שגיאה בעיבוד קובץ Excel: ${error.message}`);
        }
    }

    // 📊 עיבוד קובץ CSV מתקדם
    async processCSV(csvData, file) {
        try {
            console.log('📊 מעבד קובץ CSV...');

            // ניסוי לזהות encoding
            const encoding = this.detectCSVEncoding(csvData);
            console.log(`🔤 זיהוי קידוד: ${encoding}`);

            let processedData;

            // אם Papa Parse זמין, השתמש בו
            if (typeof Papa !== 'undefined') {
                const result = Papa.parse(csvData, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    delimitersToGuess: [',', '\t', ';', '|'],
                    encoding: 'UTF-8',
                    error: function(err) {
                        console.warn('⚠️ אזהרת Papa Parse:', err);
                    }
                });

                if (result.errors && result.errors.length > 0) {
                    console.warn('⚠️ שגיאות בפרסור CSV:', result.errors);
                }

                processedData = {
                    headers: result.meta.fields || [],
                    data: result.data,
                    rowCount: result.data.length,
                    errors: result.errors
                };

            } else {
                // פרסור ידני אם Papa Parse לא זמין
                const lines = csvData.split('\n');
                const headers = this.parseCSVLine(lines[0]);
                const data = [];

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const values = this.parseCSVLine(line);
                        const row = {};
                        
                        headers.forEach((header, index) => {
                            row[header.trim()] = values[index] ? values[index].trim() : '';
                        });
                        
                        row._rowIndex = i + 1;
                        data.push(row);
                    }
                }

                processedData = {
                    headers: headers,
                    data: data,
                    rowCount: data.length
                };
            }

            console.log(`✅ עובדו ${processedData.rowCount} רשומות מקובץ CSV`);

            return {
                ...processedData,
                fileName: file.name,
                fileSize: file.size,
                fileType: 'CSV'
            };

        } catch (error) {
            console.error('❌ שגיאה בעיבוד CSV:', error);
            throw new Error(`שגיאה בעיבוד קובץ CSV: ${error.message}`);
        }
    }

    // 📅 פונקציות עזר לתאריכי Excel
    isExcelDate(value) {
        // בדוק אם זה מספר שיכול להיות תאריך Excel
        return typeof value === 'number' && 
               value > 0 && 
               value < 2958466 && // תאריך מקסימלי של Excel
               value % 1 !== 0; // לא מספר שלם
    }

    excelDateToJSDate(excelDate) {
        // Excel מחשיב תאריכים מ-1/1/1900
        const excelEpoch = new Date(1899, 11, 30); // 30/12/1899
        const jsDate = new Date(excelEpoch.getTime() + excelDate * 24 * 60 * 60 * 1000);
        return jsDate;
    }

    // 🔤 זיהוי קידוד CSV
    detectCSVEncoding(csvData) {
        // בדיקה פשוטה לתווים עבריים
        const hebrewPattern = /[\u0590-\u05FF]/;
        if (hebrewPattern.test(csvData)) {
            return 'UTF-8';
        }
        return 'UTF-8'; // ברירת מחדל
    }

    // 🔧 פיצול שורת CSV מתקדם
    parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        let quoteChar = null;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (!inQuotes) {
                if (char === '"' || char === "'") {
                    inQuotes = true;
                    quoteChar = char;
                } else if (char === ',' || char === ';' || char === '\t') {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            } else {
                if (char === quoteChar) {
                    if (i + 1 < line.length && line[i + 1] === quoteChar) {
                        // מרכאה כפולה - הוסף מרכאה אחת
                        current += quoteChar;
                        i++; // דלג על המרכאה הבאה
                    } else {
                        // סוף המחרוזת במרכאות
                        inQuotes = false;
                        quoteChar = null;
                    }
                } else {
                    current += char;
                }
            }
        }
        
        result.push(current.trim());
        return result.filter(item => item !== ''); // הסר ערכים ריקים
    }

    // ✅ אימות נתונים מעובדים
    validateProcessedData(data) {
        const warnings = [];
        const errors = [];

        // בדיקת קיום נתונים
        if (!data.data || data.data.length === 0) {
            errors.push('אין נתונים בקובץ');
        }

        // בדיקת כותרות
        if (!data.headers || data.headers.length === 0) {
            errors.push('לא נמצאו כותרות בקובץ');
        } else {
            // בדוק אם יש כותרות ריקות
            const emptyHeaders = data.headers.filter(h => !h || h.trim() === '');
            if (emptyHeaders.length > 0) {
                warnings.push(`${emptyHeaders.length} כותרות ריקות נמצאו`);
            }

            // בדוק התאמה לכותרות צפויות
            const matchingHeaders = data.headers.filter(header => 
                this.expectedHeaders.some(expected => 
                    header.includes(expected) || expected.includes(header)
                )
            );

            const matchPercentage = (matchingHeaders.length / this.expectedHeaders.length) * 100;
            if (matchPercentage < 30) {
                warnings.push(`רק ${matchPercentage.toFixed(1)}% מהכותרות מזוהות כצפויות`);
            }
        }

        // בדיקת איכות נתונים
        if (data.data && data.data.length > 0) {
            const firstRow = data.data[0];
            const emptyFields = Object.keys(firstRow).filter(key => 
                !firstRow[key] || firstRow[key].toString().trim() === ''
            ).length;
            
            if (emptyFields > Object.keys(firstRow).length * 0.5) {
                warnings.push('שיעור גבוה של שדות ריקים בנתונים');
            }

            // בדיקת שורות כפולות
            const duplicateCheck = this.findDuplicateRows(data.data);
            if (duplicateCheck.duplicates > 0) {
                warnings.push(`נמצאו ${duplicateCheck.duplicates} שורות כפולות אפשריות`);
            }
        }

        // בדיקת גודל נתונים
        if (data.rowCount > 50000) {
            warnings.push('קובץ גדול מאוד - ביצועים עלולים להיפגע');
        }

        return {
            isValid: errors.length === 0,
            errors: errors,
            warnings: warnings,
            quality: {
                headerMatch: matchingHeaders ? (matchingHeaders.length / this.expectedHeaders.length) * 100 : 0,
                dataCompleteness: this.calculateDataCompleteness(data),
                duplicateRows: duplicateCheck ? duplicateCheck.duplicates : 0
            }
        };
    }

    // 🔍 מציאת שורות כפולות
    findDuplicateRows(data) {
        const seen = new Set();
        let duplicates = 0;

        data.forEach(row => {
            // יצירת מזהה ייחודי על בסיס שדות מרכזיים
            const key = `${row['מספר זהות מושך'] || ''}_${row['סכום'] || ''}_${row['תאריך הפקדה/מסירה'] || ''}`;
            
            if (seen.has(key)) {
                duplicates++;
            } else {
                seen.add(key);
            }
        });

        return { duplicates, total: data.length };
    }

    // 📊 חישוב שלמות נתונים
    calculateDataCompleteness(data) {
        if (!data.data || data.data.length === 0) return 0;

        const importantFields = [
            'שם מושך', 'מספר זהות מושך', 'סכום', 'תאריך הפקדה/מסירה', 'סטטוס'
        ];

        let completedFields = 0;
        let totalFields = 0;

        data.data.forEach(row => {
            importantFields.forEach(field => {
                totalFields++;
                if (row[field] && row[field].toString().trim() !== '') {
                    completedFields++;
                }
            });
        });

        return totalFields > 0 ? (completedFields / totalFields) * 100 : 0;
    }

    // 📊 יצירת סיכום נתונים מתקדם
    generateDataSummary(processedData) {
        const summary = {
            basicInfo: {
                totalRows: processedData.rowCount,
                totalColumns: processedData.headers ? processedData.headers.length : 0,
                fileName: processedData.fileName,
                fileSize: this.formatFileSize(processedData.fileSize),
                fileType: processedData.fileType,
                uploadTime: new Date()
            },
            
            columnAnalysis: [],
            dataQuality: {
                completeness: this.calculateDataCompleteness(processedData),
                consistency: 0, // יחושב בהמשך
                accuracy: 0 // יחושב בהמשך
            },
            
            preview: processedData.data.slice(0, 5), // 5 שורות ראשונות
            
            insights: []
        };

        // ניתוח עמודות
        if (processedData.headers) {
            summary.columnAnalysis = processedData.headers.map(header => ({
                name: header,
                type: this.detectColumnType(processedData.data, header),
                sampleValues: this.getSampleValues(processedData.data, header),
                nullCount: this.countNullValues(processedData.data, header),
                uniqueValues: this.countUniqueValues(processedData.data, header)
            }));
        }

        // זיהוי עמודות מרכזיות
        const keyColumns = this.identifyKeyColumns(processedData);
        summary.keyColumns = keyColumns;

        // תובנות אוטומטיות
        summary.insights = this.generateAutomaticInsights(processedData, summary);

        return summary;
    }

    // 🔍 זיהוי עמודות מרכזיות
    identifyKeyColumns(data) {
        const keyColumns = {};
        
        if (data.headers) {
            // זיהוי עמודת מזהה מושך
            const payerIdColumn = data.headers.find(h => 
                h.includes('מספר זהות מושך') || h.includes('מושך') || h.includes('זהות')
            );
            if (payerIdColumn) keyColumns.payerId = payerIdColumn;

            // זיהוי עמודת סכום
            const amountColumn = data.headers.find(h => 
                h.includes('סכום') || h.includes('amount')
            );
            if (amountColumn) keyColumns.amount = amountColumn;

            // זיהוי עמודת תאריך
            const dateColumn = data.headers.find(h => 
                h.includes('תאריך') || h.includes('date') || h.includes('פקדה')
            );
            if (dateColumn) keyColumns.date = dateColumn;

            // זיהוי עמודת סטטוס
            const statusColumn = data.headers.find(h => 
                h.includes('סטטוס') || h.includes('status')
            );
            if (statusColumn) keyColumns.status = statusColumn;
        }

        return keyColumns;
    }

    // 💡 יצירת תובנות אוטומטיות
    generateAutomaticInsights(data, summary) {
        const insights = [];

        // תובנה על גודל הקובץ
        if (data.rowCount > 10000) {
            insights.push({
                type: 'size',
                message: `קובץ גדול עם ${data.rowCount.toLocaleString()} רשומות`,
                recommendation: 'מומלץ לפרק לקבצים קטנים יותר לביצועים טובים יותר'
            });
        }

        // תובנה על איכות נתונים
        if (summary.dataQuality.completeness < 80) {
            insights.push({
                type: 'quality',
                message: `איכות נתונים נמוכה: ${summary.dataQuality.completeness.toFixed(1)}% שלמות`,
                recommendation: 'מומלץ לבדוק ולהשלים נתונים חסרים'
            });
        }

        // תובנה על עמודות מרכזיות
        const missingKeyColumns = [];
        const expectedKeys = ['payerId', 'amount', 'date'];
        expectedKeys.forEach(key => {
            if (!summary.keyColumns || !summary.keyColumns[key]) {
                missingKeyColumns.push(key);
            }
        });

        if (missingKeyColumns.length > 0) {
            insights.push({
                type: 'structure',
                message: `עמודות מרכזיות חסרות: ${missingKeyColumns.join(', ')}`,
                recommendation: 'ודא שהקובץ מכיל את כל השדות הנדרשים'
            });
        }

        return insights;
    }

    // 🔧 פונקציות עזר נוספות

    detectColumnType(data, columnName) {
        if (!data || data.length === 0) return 'unknown';
        
        const sampleSize = Math.min(10, data.length);
        const samples = data.slice(0, sampleSize)
            .map(row => row[columnName])
            .filter(value => value !== null && value !== undefined && value !== '');

        if (samples.length === 0) return 'empty';

        let numberCount = 0;
        let dateCount = 0;
        let booleanCount = 0;

        samples.forEach(value => {
            const strValue = value.toString().toLowerCase();
            
            // בדיקת מספר
            if (!isNaN(value) && !isNaN(parseFloat(value))) {
                numberCount++;
            }
            
            // בדיקת תאריך
            if (!isNaN(Date.parse(value))) {
                dateCount++;
            }
            
            // בדיקת בוליאני
            if (['true', 'false', 'כן', 'לא', '1', '0'].includes(strValue)) {
                booleanCount++;
            }
        });

        const threshold = samples.length * 0.7;
        
        if (numberCount >= threshold) return 'number';
        if (dateCount >= threshold) return 'date';
        if (booleanCount >= threshold) return 'boolean';
        
        return 'text';
    }

    getSampleValues(data, columnName) {
        return data.slice(0, 3)
            .map(row => row[columnName])
            .filter(value => value !== null && value !== undefined && value !== '');
    }

    countNullValues(data, columnName) {
        return data.filter(row => 
            !row[columnName] || row[columnName].toString().trim() === ''
        ).length;
    }

    countUniqueValues(data, columnName) {
        const uniqueValues = new Set();
        data.forEach(row => {
            const value = row[columnName];
            if (value !== null && value !== undefined && value !== '') {
                uniqueValues.add(value.toString());
            }
        });
        return uniqueValues.size;
    }

    // 🎯 טיפול באירועי קלט קובץ
    async handleFileInput(event, inputType) {
        const file = event.target.files[0];
        if (!file) return;

        console.log(`📁 נבחר קובץ: ${file.name} (${inputType})`);

        // עדכון UI מתאים
        this.updateFileInputUI(inputType, 'loading', `טוען ${file.name}...`);

        try {
            const result = await this.uploadFile(file, 
                (progress, message) => this.updateProgress(inputType, progress, message), 
                inputType
            );

            if (result.success) {
                this.updateFileInputUI(inputType, 'success', `✅ ${file.name} נטען בהצלחה`);
                
                // שמור בהתאם לסוג הקובץ
                this.saveFileData(inputType, result);
                
                utils.showNotification('קובץ נטען', `${file.name} נטען בהצלחה`, 'success');
            } else {
                this.updateFileInputUI(inputType, 'error', `❌ שגיאה: ${result.error}`);
                utils.showNotification('שגיאה בטעינה', result.error, 'error');
            }

        } catch (error) {
            console.error(`❌ שגיאה בטעינת ${inputType}:`, error);
            this.updateFileInputUI(inputType, 'error', `❌ שגיאה: ${error.message}`);
            utils.showNotification('שגיאה', error.message, 'error');
        }
    }

    // 💾 שמירת נתוני קובץ
    saveFileData(inputType, result) {
        switch (inputType) {
            case 'mainExcelFile':
                window.CreditSystem.excelData.main = result.data;
                break;
            case 'scoresFile':
                window.CreditSystem.excelData.scores = result.data;
                break;
            case 'returnedFile':
                window.CreditSystem.excelData.returned = result.data;
                break;
            case 'warningsFile':
                window.CreditSystem.excelData.warnings = result.data;
                break;
        }
    }

    // 🎨 עדכון UI
    updateFileInputUI(inputType, status, message) {
        const statusMap = {
            'mainExcelFile': 'transactionsStatus',
            'scoresFile': 'returnedStatus',
            'returnedFile': 'returnedStatus', 
            'warningsFile': 'warningsStatus'
        };

        const elementId = statusMap[inputType];
        if (elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `status-${status}`;
            }
        }
    }

    updateProgress(inputType, progress, message) {
        console.log(`📊 ${inputType}: ${progress}% - ${message}`);
        // כאן ניתן להוסיף עדכון ויזואלי של התקדמות
    }

    // 🎯 טיפול ב-Drag & Drop
    handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        e.dataTransfer.dropEffect = 'copy';
    }

    handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const files = Array.from(e.dataTransfer.files);
        const uploadArea = e.target.closest('.upload-area, .excel-upload-section');
        
        if (uploadArea) {
            uploadArea.classList.remove('dragover');
            
            if (files.length > 0) {
                // טען את הקובץ הראשון
                this.handleFileInput({ target: { files: files } }, 'mainExcelFile');
            }
        }
    }

    handleDragEnter(e) {
        const uploadArea = e.target.closest('.upload-area, .excel-upload-section');
        if (uploadArea) {
            uploadArea.classList.add('dragover');
        }
    }

    handleDragLeave(e) {
        const uploadArea = e.target.closest('.upload-area, .excel-upload-section');
        if (uploadArea && !uploadArea.contains(e.relatedTarget)) {
            uploadArea.classList.remove('dragover');
        }
    }

    // 🔧 פונקציות עזר כלליות
    getFileExtension(fileName) {
        return fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
    }

    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 🔄 איפוס
    reset() {
        this.currentFile = null;
        this.uploadProgress = 0;
        window.CreditSystem.excelData = {};
    }

    // 📊 קבלת נתונים
    getCurrentData() {
        return window.CreditSystem.excelData;
    }
}

// 🌍 יצירת מופע גלובלי
window.fileLoader = new EnhancedFileLoader();

// 📤 ייצוא למודולים
if (typeof module !== 'undefined' && module.exports) {
    module.exports = EnhancedFileLoader;
}
