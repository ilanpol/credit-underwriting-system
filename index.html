<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת חיתום אשראי</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            direction: rtl; 
            color: #2c3e50;
            padding: 20px;
        }

        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }

        .header { 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px; 
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .section { 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .file-upload {
            border: 2px dashed #3498db;
            padding: 20px;
            margin: 10px 0;
            border-radius: 10px;
            text-align: center;
        }

        .file-upload input[type="file"] {
            margin: 10px 0;
            padding: 10px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        .status.empty { background: #e74c3c; color: white; }
        .status.loaded { background: #27ae60; color: white; }
        .status.loading { background: #f39c12; color: white; }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn {
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }

        .btn:hover { background: #2980b9; }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }

        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #229954; }

        .results {
            display: none;
            margin-top: 20px;
        }

        .rating-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .rating-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .rating-score {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .rating-AAA { color: #27ae60; }
        .rating-AA { color: #2ecc71; }
        .rating-A { color: #f39c12; }
        .rating-BBB { color: #e67e22; }
        .rating-BB { color: #e74c3c; }
        .rating-B { color: #c0392b; }

        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 9999;
            font-weight: bold;
        }

        .notification.success { background: #27ae60; }
        .notification.error { background: #e74c3c; }
        .notification.warning { background: #f39c12; }

        .debug {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .rating-cards { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏦 מערכת חיתום אשראי</h1>
            <p>גרסה פשוטה שעובדת</p>
        </div>

        <div class="section">
            <h2>📊 סטטוס קבצים</h2>
            <div>
                <span id="mainStatus" class="status empty">עסקאות: לא נטען</span>
                <span id="creditStatus" class="status empty">D&B: לא נטען</span>
                <span id="warningsStatus" class="status empty">ביטולים: לא נטען</span>
            </div>
        </div>

        <div class="section">
            <h2>📁 העלאת קבצים</h2>
            
            <div class="file-upload">
                <h4>📈 קובץ עסקאות ראשי</h4>
                <input type="file" id="mainFile" accept=".xlsx,.xls,.csv" onchange="loadFile('main')">
            </div>

            <div class="file-upload">
                <h4>🏢 קובץ D&B (scoreM_N)</h4>
                <input type="file" id="creditFile" accept=".xlsx,.xls" onchange="loadFile('credit')">
            </div>

            <div class="file-upload">
                <h4>⚠️ קובץ ביטולים (אופציונלי)</h4>
                <input type="file" id="warningsFile" accept=".xlsx,.xls,.csv" onchange="loadFile('warnings')">
            </div>
        </div>

        <div class="section">
            <h2>💼 פרטי עסקה</h2>
            
            <div class="form-group">
                <label>שם מושך (חברה)</label>
                <input type="text" id="payerName" placeholder="שם החברה המושכת">
            </div>

            <div class="form-group">
                <label>ח.פ. מושך</label>
                <input type="text" id="payerID" placeholder="מספר ח.פ. של החברה">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>סכום השיק (₪)</label>
                    <input type="number" id="checkAmount" placeholder="0" min="0">
                </div>
                <div class="form-group">
                    <label>ימי אשראי</label>
                    <input type="number" id="creditDays" placeholder="30" value="30" min="0">
                </div>
            </div>

            <button class="btn" onclick="calculateRating()" id="calculateBtn" disabled>
                🧮 חשב דירוג
            </button>

            <button class="btn btn-success" onclick="loadSampleData()">
                📋 טען דוגמה
            </button>
        </div>

        <div class="section results" id="results">
            <h2>📊 תוצאות</h2>
            <div class="rating-cards" id="ratingCards"></div>
            <div id="recommendation"></div>
        </div>

        <div id="debug" class="debug" style="display: none;"></div>
    </div>

    <script>
        let payersData = new Map();
        let dnbData = new Map();
        let mainFileLoaded = false;
        let creditFileLoaded = false;

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
            
            console.log(`${type.toUpperCase()}: ${message}`);
        }

        function updateDebug(message) {
            const debugDiv = document.getElementById('debug');
            debugDiv.style.display = 'block';
            debugDiv.textContent += message + '\n';
            console.log(message);
        }

        async function loadFile(type) {
            const fileInput = document.getElementById(type + 'File');
            const statusElement = document.getElementById(type + 'Status');
            
            if (!fileInput.files[0]) {
                showNotification('לא נבחר קובץ', 'warning');
                return;
            }

            const file = fileInput.files[0];
            updateDebug(`🔄 טוען קובץ ${type}: ${file.name}`);
            
            statusElement.textContent = `${getTypeName(type)}: טוען...`;
            statusElement.className = 'status loading';

            try {
                const workbook = await readExcelFile(file);
                updateDebug(`✅ קובץ נקרא: ${workbook.SheetNames.length} גיליונות`);
                
                if (type === 'main') {
                    processMainFile(workbook);
                    mainFileLoaded = true;
                    statusElement.textContent = `עסקאות: ✓ נטען`;
                    statusElement.className = 'status loaded';
                } else if (type === 'credit') {
                    processCreditFile(workbook);
                    creditFileLoaded = true;
                    statusElement.textContent = `D&B: ✓ נטען`;
                    statusElement.className = 'status loaded';
                } else if (type === 'warnings') {
                    statusElement.textContent = `ביטולים: ✓ נטען`;
                    statusElement.className = 'status loaded';
                }
                
                updateCalculateButton();
                showNotification(`קובץ ${getTypeName(type)} נטען בהצלחה`, 'success');
                
            } catch (error) {
                updateDebug(`❌ שגיאה: ${error.message}`);
                statusElement.textContent = `${getTypeName(type)}: שגיאה`;
                statusElement.className = 'status empty';
                showNotification(`שגיאה בטעינת קובץ: ${error.message}`, 'error');
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        resolve(workbook);
                    } catch (error) {
                        reject(new Error('לא הצלחתי לקרוא את הקובץ: ' + error.message));
                    }
                };
                reader.onerror = () => reject(new Error('שגיאה בקריאת הקובץ'));
                reader.readAsArrayBuffer(file);
            });
        }

        function processMainFile(workbook) {
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            updateDebug(`📊 מעבד קובץ עסקאות: ${data.length} שורות`);
            
            if (data.length < 2) {
                throw new Error('קובץ ריק או חסרות שורות נתונים');
            }
            
            const headers = data[0];
            const rows = data.slice(1);
            
            // חיפוש עמודות
            const payerNameIndex = findColumn(headers, ['שם מושך', 'חברה', 'מושך']);
            const payerIdIndex = findColumn(headers, ['ח.פ', 'זהות מושך', 'מספר זהות']);
            const amountIndex = findColumn(headers, ['סכום', 'סכום שיק']);
            
            updateDebug(`📋 נמצאו עמודות: שם=${payerNameIndex}, ח.פ=${payerIdIndex}, סכום=${amountIndex}`);
            
            payersData.clear();
            
            rows.forEach(row => {
                const payerName = payerNameIndex >= 0 ? row[payerNameIndex] : '';
                const payerId = payerIdIndex >= 0 ? row[payerIdIndex] : '';
                const amount = parseFloat(row[amountIndex]) || 0;
                
                if (payerName && amount > 0) {
                    const id = payerId || payerName;
                    if (!payersData.has(id)) {
                        payersData.set(id, {
                            name: payerName,
                            id: payerId,
                            totalAmount: 0,
                            transactionCount: 0
                        });
                    }
                    
                    const payer = payersData.get(id);
                    payer.totalAmount += amount;
                    payer.transactionCount++;
                }
            });
            
            updateDebug(`✅ עובדו ${payersData.size} חברות מושכות`);
        }

        function processCreditFile(workbook) {
            let sheetName = workbook.SheetNames.find(name => 
                name.toLowerCase().includes('score')
            ) || workbook.SheetNames[0];
            
            const worksheet = workbook.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            updateDebug(`🏢 מעבד D&B מגיליון "${sheetName}": ${data.length} שורות`);
            
            if (data.length < 2) {
                throw new Error('קובץ D&B ריק');
            }
            
            const headers = data[0];
            const rows = data.slice(1);
            
            const companyNameIndex = findColumn(headers, ['שם', 'חברה']);
            const companyIdIndex = findColumn(headers, ['ח.פ', 'זהות']);
            const scoreIndex = findColumn(headers, ['סקור']);
            
            updateDebug(`📋 עמודות D&B: שם=${companyNameIndex}, ח.פ=${companyIdIndex}, סקור=${scoreIndex}`);
            
            dnbData.clear();
            
            rows.forEach(row => {
                const name = companyNameIndex >= 0 ? row[companyNameIndex] : '';
                const id = companyIdIndex >= 0 ? row[companyIdIndex] : '';
                const score = parseFloat(row[scoreIndex]) || 0;
                
                if ((name || id) && score > 0) {
                    const record = { name, id, score };
                    if (id) dnbData.set(id, record);
                    if (name) dnbData.set(name, record);
                }
            });
            
            updateDebug(`✅ עובדו ${dnbData.size} רשומות D&B`);
        }

        function findColumn(headers, searchTerms) {
            for (let term of searchTerms) {
                const index = headers.findIndex(header => 
                    header && header.toString().toLowerCase().includes(term.toLowerCase())
                );
                if (index >= 0) return index;
            }
            return -1;
        }

        function updateCalculateButton() {
            const btn = document.getElementById('calculateBtn');
            btn.disabled = !mainFileLoaded;
        }

        function calculateRating() {
            const payerName = document.getElementById('payerName').value.trim();
            const payerId = document.getElementById('payerID').value.trim();
            const amount = parseFloat(document.getElementById('checkAmount').value) || 0;
            const days = parseInt(document.getElementById('creditDays').value) || 30;
            
            if (!payerName && !payerId) {
                showNotification('נא להזין שם או ח.פ. של המושך', 'warning');
                return;
            }
            
            if (amount <= 0) {
                showNotification('נא להזין סכום תקין', 'warning');
                return;
            }
            
            updateDebug(`🧮 מחשב דירוג עבור: ${payerName || payerId}, סכום: ${amount}`);
            
            // חיפוש החברה
            const payer = findPayer(payerName, payerId);
            const dnb = findDnbRecord(payerName, payerId);
            
            let score = 50; // ציון בסיס
            
            // ציון על בסיס היסטוריה
            if (payer) {
                if (payer.transactionCount >= 10) score += 20;
                else if (payer.transactionCount >= 5) score += 10;
                
                if (payer.totalAmount >= 1000000) score += 15;
                else if (payer.totalAmount >= 500000) score += 10;
                else if (payer.totalAmount >= 100000) score += 5;
            }
            
            // ציון D&B
            if (dnb) {
                if (dnb.score >= 80) score += 20;
                else if (dnb.score >= 60) score += 15;
                else if (dnb.score >= 40) score += 10;
                else score -= 10;
            }
            
            // התאמת ציון לגודל עסקה
            if (amount > 500000) score -= 5;
            if (days > 60) score -= 10;
            
            score = Math.max(0, Math.min(100, score));
            
            let rating = 'B';
            if (score >= 85) rating = 'AAA';
            else if (score >= 75) rating = 'AA';
            else if (score >= 65) rating = 'A';
            else if (score >= 55) rating = 'BBB';
            else if (score >= 45) rating = 'BB';
            
            displayResults({
                score: Math.round(score),
                rating,
                payer,
                dnb,
                amount,
                days
            });
        }

        function findPayer(name, id) {
            if (id && payersData.has(id)) return payersData.get(id);
            if (name && payersData.has(name)) return payersData.get(name);
            
            for (let [key, payer] of payersData.entries()) {
                if (name && payer.name && payer.name.includes(name)) return payer;
            }
            return null;
        }

        function findDnbRecord(name, id) {
            if (id && dnbData.has(id)) return dnbData.get(id);
            if (name && dnbData.has(name)) return dnbData.get(name);
            return null;
        }

        function displayResults(result) {
            const resultsDiv = document.getElementById('results');
            const cardsDiv = document.getElementById('ratingCards');
            const recommendationDiv = document.getElementById('recommendation');
            
            cardsDiv.innerHTML = `
                <div class="rating-card">
                    <div class="rating-score rating-${result.rating}">${result.rating}</div>
                    <div>דירוג אשראי</div>
                </div>
                <div class="rating-card">
                    <div class="rating-score">${result.score}</div>
                    <div>ציון כולל</div>
                </div>
                <div class="rating-card">
                    <div class="rating-score">${result.payer ? result.payer.transactionCount : 0}</div>
                    <div>עסקאות קודמות</div>
                </div>
                <div class="rating-card">
                    <div class="rating-score">${result.dnb ? result.dnb.score : 0}</div>
                    <div>ציון D&B</div>
                </div>
            `;
            
            let recommendation = '';
            if (result.score >= 75) {
                recommendation = '✅ מומלץ לאישור';
                recommendationDiv.style.background = '#27ae60';
            } else if (result.score >= 55) {
                recommendation = '⚠️ דורש בדיקה נוספת';
                recommendationDiv.style.background = '#f39c12';
            } else {
                recommendation = '❌ לא מומלץ לאישור';
                recommendationDiv.style.background = '#e74c3c';
            }
            
            recommendationDiv.innerHTML = `
                <h3>${recommendation}</h3>
                <p>עבור עסקה של ₪${result.amount.toLocaleString()} ל-${result.days} ימים</p>
            `;
            recommendationDiv.style.color = 'white';
            recommendationDiv.style.padding = '20px';
            recommendationDiv.style.borderRadius = '10px';
            recommendationDiv.style.textAlign = 'center';
            recommendationDiv.style.margin = '20px 0';
            
            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
            
            updateDebug(`✅ תוצאה: ${result.rating} (${result.score} נקודות)`);
        }

        function loadSampleData() {
            // נתוני דוגמה
            payersData.clear();
            dnbData.clear();
            
            // חברות לדוגמה
            payersData.set('123456789', {
                name: 'אבג טכנולוגיות בע"מ',
                id: '123456789',
                totalAmount: 750000,
                transactionCount: 12
            });
            
            payersData.set('987654321', {
                name: 'דפקא שירותים בע"מ',
                id: '987654321',
                totalAmount: 420000,
                transactionCount: 8
            });
            
            // נתוני D&B לדוגמה
            dnbData.set('123456789', { name: 'אבג טכנולוגיות בע"מ', id: '123456789', score: 85 });
            dnbData.set('987654321', { name: 'דפקא שירותים בע"מ', id: '987654321', score: 72 });
            
            mainFileLoaded = true;
            creditFileLoaded = true;
            
            document.getElementById('mainStatus').textContent = 'עסקאות: ✓ דוגמה';
            document.getElementById('mainStatus').className = 'status loaded';
            document.getElementById('creditStatus').textContent = 'D&B: ✓ דוגמה';
            document.getElementById('creditStatus').className = 'status loaded';
            
            updateCalculateButton();
            showNotification('נתוני דוגמה נטענו בהצלחה', 'success');
            updateDebug('✅ נטענו נתוני דוגמה');
        }

        function getTypeName(type) {
            const names = {
                'main': 'עסקאות',
                'credit': 'D&B', 
                'warnings': 'ביטולים'
            };
            return names[type] || type;
        }

        // אתחול
        document.addEventListener('DOMContentLoaded', function() {
            updateDebug('🏦 מערכת חיתום אשראי הופעלה');
            
            if (typeof XLSX === 'undefined') {
                showNotification('שגיאה: ספריית Excel לא נטענה', 'error');
                updateDebug('❌ ספריית XLSX לא זמינה');
            } else {
                updateDebug('✅ ספריית XLSX זמינה');
            }
        });
    </script>
</body>
</html>
