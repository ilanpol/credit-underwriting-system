<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×—×™×ª×•× ××©×¨××™ - ×œ×¤×™ ×”× ×•×¡×—××•×ª ×”××§×•×¨×™×•×ª</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            direction: rtl; 
        }
        .container { max-width: 1800px; margin: 0 auto; padding: 20px; }
        .header { 
            background: rgba(255, 255, 255, 0.95); 
            padding: 30px; 
            border-radius: 20px; 
            text-align: center; 
            margin-bottom: 30px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); 
        }
        .header h1 { color: #2c3e50; font-size: 2.5em; margin-bottom: 10px; }
        .header p { color: #7f8c8d; font-size: 1.2em; }
        .main-content { 
            display: grid; 
            grid-template-columns: 1fr 2fr; 
            gap: 30px; 
            margin-bottom: 30px; 
        }
        .input-section, .results-section { 
            background: rgba(255, 255, 255, 0.95); 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); 
        }
        .results-section { display: none; }
        .form-group { margin-bottom: 20px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600; 
            color: #34495e; 
            font-size: 14px; 
        }
        input, select { 
            width: 100%; 
            padding: 10px 12px; 
            border: 2px solid #e1e8ed; 
            border-radius: 8px; 
            font-size: 14px; 
            transition: all 0.3s ease; 
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: #3498db; 
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); 
        }
        .btn { 
            background: linear-gradient(135deg, #3498db, #2980b9); 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 25px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            width: 100%; 
            transition: all 0.3s ease; 
            margin-top: 15px; 
        }
        .btn:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4); 
        }
        .btn:disabled { 
            background: #bdc3c7; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }
        .file-upload { 
            background: #f8f9fa; 
            border: 2px dashed #dee2e6; 
            border-radius: 10px; 
            padding: 15px; 
            text-align: center; 
            margin-bottom: 15px; 
            transition: all 0.3s ease; 
        }
        .file-upload:hover { 
            border-color: #3498db; 
            background: #f0f8ff; 
        }
        .file-upload input { display: none; }
        .file-upload label { 
            cursor: pointer; 
            color: #3498db; 
            font-weight: 600; 
        }
        .rating-display { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .rating-card { 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            text-align: center; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
        }
        .rating-score { 
            font-size: 3em; 
            font-weight: bold; 
            margin-bottom: 10px; 
        }
        .rating-AAA { color: #27ae60; }
        .rating-AA { color: #2ecc71; }
        .rating-A { color: #f39c12; }
        .rating-BBB { color: #f1c40f; }
        .rating-BB { color: #e67e22; }
        .rating-B { color: #e74c3c; }
        .rating-CCC { color: #c0392b; }
        .rating-D { color: #8b0000; }
        .parameters-section { 
            background: white; 
            border-radius: 15px; 
            padding: 20px; 
            margin-bottom: 20px; 
        }
        .parameter-header { 
            display: grid; 
            grid-template-columns: 3fr 1fr 1fr 1fr 1fr 1fr; 
            gap: 10px; 
            padding: 12px; 
            background: #f8f9fa; 
            border-radius: 8px; 
            font-weight: bold; 
            margin-bottom: 10px; 
            font-size: 14px;
        }
        .parameter-row { 
            display: grid; 
            grid-template-columns: 3fr 1fr 1fr 1fr 1fr 1fr; 
            gap: 10px; 
            padding: 10px 12px; 
            border-bottom: 1px solid #ecf0f1; 
            align-items: center; 
            font-size: 13px;
        }
        .parameter-row:last-child { border-bottom: none; }
        .parameter-name { font-weight: 600; color: #2c3e50; }
        .parameter-description { font-size: 11px; color: #7f8c8d; margin-top: 2px; }
        .formula-display { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 8px; 
            padding: 10px; 
            margin: 5px 0; 
            font-family: 'Courier New', monospace; 
            font-size: 11px; 
            color: #495057;
        }
        .recommendation { 
            text-align: center; 
            margin: 20px 0; 
            font-size: 1.1em; 
            font-weight: 600; 
            padding: 20px;
            border-radius: 15px;
        }
        .recommendation.AAA, .recommendation.AA { background: linear-gradient(135deg, #27ae60, #229954); color: white; }
        .recommendation.A { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .recommendation.BBB, .recommendation.BB { background: linear-gradient(135deg, #e67e22, #d35400); color: white; }
        .recommendation.B, .recommendation.CCC, .recommendation.D { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .data-summary { 
            background: white; 
            border-radius: 15px; 
            padding: 20px; 
            margin-bottom: 20px; 
        }
        .summary-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 15px; 
        }
        .summary-item { 
            text-align: center; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 10px; 
        }
        .summary-value { 
            font-size: 1.8em; 
            font-weight: bold; 
            color: #2c3e50; 
        }
        .summary-label { 
            font-size: 12px; 
            color: #7f8c8d; 
            margin-top: 5px; 
        }
        @media (max-width: 1200px) { 
            .main-content { grid-template-columns: 1fr; } 
            .rating-display { grid-template-columns: repeat(2, 1fr); } 
            .parameter-header, .parameter-row { 
                grid-template-columns: 2fr 1fr 1fr; 
                font-size: 12px; 
            }
            .summary-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦ ××¢×¨×›×ª ×—×™×ª×•× ××©×¨××™ ××ª×§×“××ª</h1>
            <p>×—×™×©×•×‘ ×“×™×¨×•×’ ××©×¨××™ ×œ×¤×™ 16 ×¤×¨××˜×¨×™× - ×”× ×•×¡×—××•×ª ×”××§×•×¨×™×•×ª ××”××§×¡×œ</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2 style="margin-bottom: 20px; color: #2c3e50; font-size: 18px;">×¤×¨×˜×™ ×”×¢×¡×§×”</h2>
                
                <div class="file-upload">
                    <label for="dataFiles">ğŸ“ ×”×¢×œ×” ×§×‘×¦×™ × ×ª×•× ×™×</label>
                    <input type="file" id="dataFiles" multiple accept=".xlsx,.xls,.csv">
                    <p style="margin-top: 8px; font-size: 10px; color: #7f8c8d;">
                        ×§×‘×¦×™×: ×’×™×œ×™×•×Ÿ ×¢×¡×§××•×ª, × ×ª×•× ×™ D&B, ×©×™×§×™× ×—×•×–×¨×™×, sigma, ×”×ª×¨×¢×•×ª
                    </p>
                </div>

                <div class="form-group">
                    <label for="customerName">×©× ×œ×§×•×—</label>
                    <input type="text" id="customerName" placeholder="×”×–×Ÿ ×©× ×œ×§×•×—">
                </div>

                <div class="form-group">
                    <label for="customerID">×—.×¤./×ª.×–. ×œ×§×•×—</label>
                    <input type="text" id="customerID" placeholder="×”×–×Ÿ ××¡×¤×¨ ×–×”×•×ª ×œ×§×•×—">
                </div>

                <div class="form-group">
                    <label for="payerName">×©× ××•×©×š</label>
                    <input type="text" id="payerName" placeholder="×”×–×Ÿ ×©× ××•×©×š">
                </div>

                <div class="form-group">
                    <label for="payerID">×—.×¤./×ª.×–. ××•×©×š</label>
                    <input type="text" id="payerID" placeholder="×”×–×Ÿ ××¡×¤×¨ ×–×”×•×ª ××•×©×š">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="checkAmount">×¡×›×•× ×”×©×™×§</label>
                        <input type="number" id="checkAmount" placeholder="×¡×›×•× ×‘×©×´×—">
                    </div>
                    <div class="form-group">
                        <label for="checkDate">×ª××¨×™×š ×”×©×™×§</label>
                        <input type="date" id="checkDate">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="creditDays">×™××™ ××©×¨××™</label>
                        <input type="number" id="creditDays" placeholder="××¡×¤×¨ ×™××™ ××©×¨××™">
                    </div>
                    <div class="form-group">
                        <label for="commission">×¢××œ×”</label>
                        <input type="number" id="commission" step="0.01" placeholder="×¢××œ×” ×‘%">
                    </div>
                </div>

                <button class="btn" onclick="calculateCreditRating()" id="calculateBtn">
                    ğŸ§® ×—×©×‘ ×“×™×¨×•×’ ××©×¨××™ (16 ×¤×¨××˜×¨×™×)
                </button>

                <button class="btn" style="background: #95a5a6; margin-top: 8px;" onclick="loadExampleData()">
                    ğŸ“‹ ×˜×¢×Ÿ × ×ª×•× ×™ ×“×•×’××”
                </button>
            </div>

            <div class="results-section" id="resultsSection">
                <div class="rating-display" id="ratingDisplay"></div>
                
                <div class="data-summary">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">×¡×™×›×•× ×”× ×ª×•× ×™×</h3>
                    <div class="summary-grid" id="summaryGrid"></div>
                </div>

                <div class="parameters-section">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">×¤×™×¨×•×˜ 16 ×¤×¨××˜×¨×™ ×”×“×™×¨×•×’</h3>
                    <div class="parameter-header">
                        <div>×¤×¨××˜×¨</div>
                        <div>××©×§×œ</div>
                        <div>×¢×¨×š ×’×•×œ××™</div>
                        <div>×× ×•×¨××œ</div>
                        <div>××©×•×§×œ×œ</div>
                        <div>× ×•×¡×—×”</div>
                    </div>
                    <div id="parametersDisplay"></div>
                </div>

                <div id="recommendation" class="recommendation"></div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" style="width: auto; margin-left: 10px;" onclick="exportToExcel()">
                        ğŸ“„ ×™×¦× ×œ××§×¡×œ
                    </button>
                    <button class="btn" style="width: auto; background: #95a5a6;" onclick="resetForm()">
                        ğŸ”„ ×¢×¡×§×” ×—×“×©×”
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // × ×ª×•× ×™ ×”××¢×¨×›×ª
        let transactionsData = [];
        let dbScoreData = [];
        let returnedChecksData = [];
        let sigmaData = [];
        let warningsData = [];
        let socioEconomicData = [];

        // ×¤×¨××˜×¨×™ ×”×“×™×¨×•×’ ×œ×¤×™ ×”× ×•×¡×—××•×ª ×”××§×•×¨×™×•×ª
        const creditParameters = [
            { name: '××¡×¤×¨ ×¢×¡×§××•×ª ×§×•×“××•×ª', weight: 0.15, key: 'previousTransactions' },
            { name: '××¡×¤×¨ ×—×–×¨×•×ª ×©×™×§×™×', weight: 0.05, key: 'returnedChecks' },
            { name: '×—×¨×™×’×” ××××•×¦×¢ ×™××™ ××©×¨××™', weight: 0.10, key: 'creditDaysDeviation' },
            { name: '×“×™×¨×•×’ D&B (0-100)', weight: 0.08, key: 'dbScore' },
            { name: '×“×™×¨×•×’ ×¢× ×£', weight: 0.05, key: 'sectorScore' },
            { name: '××¡×•×›× ×ª ××”×¢× ×£ ×©×œ×”', weight: 0.08, key: 'riskierThanSector' },
            { name: '×’×™×œ ×”×—×‘×¨×” ×‘×©× ×™×', weight: 0.13, key: 'companyAge' },
            { name: '××—×–×•×¨ ×©× ×ª×™ ×‘××™×œ×™×•× ×™ ×©"×—', weight: 0.03, key: 'annualTurnover' },
            { name: '××“×“ ×¡×•×¦×™×•××§×•× ×•××™ (1-10)', weight: 0.03, key: 'socioEconomicIndex' },
            { name: '××¡×¤×¨ ×”×ª×¨×¢×•×ª', weight: 0.08, key: 'warningsCount' },
            { name: '×”××œ×¦×”', weight: 0.05, key: 'recommendation' },
            { name: '×××™×¤×” ×”×‘×¢×œ×™×', weight: 0.03, key: 'ownerOrigin' },
            { name: '×“×™×¨×•×’ ×”×¡× ×™×£', weight: 0.01, key: 'branchScore' },
            { name: '×¢×¡×§×” ×××•×¦×¢×ª ×œ××•×©×š', weight: 0.10, key: 'averageTransaction' },
            { name: '×”××•×©×š ×•×”×œ×§×•×— ×××•×ª×• ××§×•×', weight: 0.03, key: 'sameLocation' },
            { name: '×¢×¨×‘×•×ª ××•×©×š', weight: 0.00, key: 'guarantee' }
        ];

        // ×˜×¢×™× ×ª × ×ª×•× ×™ ×“×•×’××”
        function loadExampleData() {
            document.getElementById('customerName').value = '×“×•×“ ×™×©×¨××œ×™';
            document.getElementById('customerID').value = '514031970';
            document.getElementById('payerName').value = '×—×‘×¨×ª ×”×‘× ×™×™×” ×”×’×“×•×œ×” ×‘×¢"×';
            document.getElementById('payerID').value = '513456789';
            document.getElementById('checkAmount').value = '85000';
            document.getElementById('checkDate').value = '2024-09-15';
            document.getElementById('creditDays').value = '45';
            document.getElementById('commission').value = '2.5';

            // × ×ª×•× ×™ ×“×•×’××”
            transactionsData = [
                { payerID: '513456789', payerName: '×—×‘×¨×ª ×”×‘× ×™×™×” ×”×’×“×•×œ×” ×‘×¢"×', transactions: 12, totalAmount: 850000, averageAmount: 70833, creditDays: 38 },
                { payerID: '305346900', payerName: '××™×‘×¨×”×™× ×¨××‘×™', transactions: 3, totalAmount: 180000, averageAmount: 60000, creditDays: 42 }
            ];

            dbScoreData = [
                { companyID: '513456789', dbScore: 72, sectorScore: 65, age: 15, employees: 85, turnover: 45 },
                { companyID: '305346900', dbScore: 45, sectorScore: 55, age: 8, employees: 12, turnover: 5.2 }
            ];

            returnedChecksData = [
                { payerID: '513456789', returnedCount: 1 },
                { payerID: '305346900', returnedCount: 0 }
            ];

            warningsData = [
                { companyID: '513456789', warningsCount: 2 },
                { companyID: '305346900', warningsCount: 0 }
            ];

            socioEconomicData = [
                { city: '×ª×œ ××‘×™×‘', index: 8 },
                { city: '×—×™×¤×”', index: 6 },
                { city: '×™×¨×•×©×œ×™×', index: 5 }
            ];

            alert('× ×ª×•× ×™ ×“×•×’××” × ×˜×¢× ×• ×‘×”×¦×œ×—×”!');
        }

        // ×—×™×©×•×‘ ×“×™×¨×•×’ ×”××©×¨××™ ×œ×¤×™ ×”× ×•×¡×—××•×ª ×”××§×•×¨×™×•×ª
        function calculateCreditRating() {
            const payerID = document.getElementById('payerID').value;
            const checkAmount = parseFloat(document.getElementById('checkAmount').value) || 0;
            const creditDays = parseInt(document.getElementById('creditDays').value) || 0;

            if (!payerID || !checkAmount) {
                alert('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×');
                return;
            }

            // ×—×™×¤×•×© × ×ª×•× ×™ ×”××•×©×š
            const payerData = findPayerData(payerID);
            const dbData = findDBData(payerID);
            const returnedData = findReturnedChecksData(payerID);
            const warningsCount = findWarningsData(payerID);

            // ×—×™×©×•×‘ ×›×œ ×¤×¨××˜×¨ ×œ×¤×™ ×”× ×•×¡×—××•×ª ×”××§×•×¨×™×•×ª
            const parameters = calculateAllParameters(payerData, dbData, returnedData, warningsCount, checkAmount, creditDays);
            
            // ×—×™×©×•×‘ ×”×¦×™×•×Ÿ ×”×›×•×œ×œ
            const totalScore = calculateTotalScore(parameters);
            
            // ×§×‘×™×¢×ª ×“×™×¨×•×’ ×”××•×ª×™×•×ª
            const letterRating = getLetterRating(totalScore);
            
            // ×”×¦×’×ª ×”×ª×•×¦××•×ª
            displayResults(parameters, totalScore, letterRating, payerData, dbData);
            
            document.getElementById('resultsSection').style.display = 'block';
        }

        function findPayerData(payerID) {
            return transactionsData.find(p => p.payerID === payerID) || {
                payerID: payerID,
                transactions: 0,
                totalAmount: 0,
                averageAmount: 0,
                creditDays: 0
            };
        }

        function findDBData(payerID) {
            return dbScoreData.find(d => d.companyID === payerID) || {
                companyID: payerID,
                dbScore: 30,
                sectorScore: 45,
                age: 5,
                employees: 10,
                turnover: 2
            };
        }

        function findReturnedChecksData(payerID) {
            const data = returnedChecksData.find(r => r.payerID === payerID);
            return data ? data.returnedCount : 0;
        }

        function findWarningsData(payerID) {
            const data = warningsData.find(w => w.companyID === payerID);
            return data ? data.warningsCount : 0;
        }

        function calculateAllParameters(payerData, dbData, returnedCount, warningsCount, checkAmount, creditDays) {
            const parameters = [];

            // 1. ××¡×¤×¨ ×¢×¡×§××•×ª ×§×•×“××•×ª
            const transactionsRaw = payerData.transactions || 0;
            let transactionsNormalized;
            if (transactionsRaw >= 100) transactionsNormalized = 1;
            else if (transactionsRaw >= 50) transactionsNormalized = 0.8;
            else if (transactionsRaw >= 20) transactionsNormalized = 0.6;
            else if (transactionsRaw >= 10) transactionsNormalized = 0.4;
            else if (transactionsRaw >= 5) transactionsNormalized = 0.2;
            else transactionsNormalized = 0.1;
            
            if (transactionsRaw === 0) transactionsNormalized = 1; // ×œ×¤×™ ×”× ×•×¡×—×” ×”××§×•×¨×™×ª
            
            parameters.push({
                name: '××¡×¤×¨ ×¢×¡×§××•×ª ×§×•×“××•×ª',
                weight: 0.15,
                rawValue: transactionsRaw,
                normalized: transactionsNormalized,
                weighted: transactionsNormalized * 0.15,
                formula: 'MAX(IF(N2>=100,1,IF(N2>=50,0.8,IF(N2>=20,0.6,IF(N2>=10,0.4,IF(N2>=5,0.2,0.1))))),IF(N2=0,1,0.1))'
            });

            // 2. ××¡×¤×¨ ×—×–×¨×•×ª ×©×™×§×™×
            const returnedRaw = returnedCount || 0;
            const returnedNormalized = returnedRaw === 0 ? 1 : Math.max(0, 1 - returnedRaw * 0.2);
            
            parameters.push({
                name: '××¡×¤×¨ ×—×–×¨×•×ª ×©×™×§×™×',
                weight: 0.05,
                rawValue: returnedRaw,
                normalized: returnedNormalized,
                weighted: returnedNormalized * 0.05,
                formula: 'IF(N3=0, 1, -MAX(0,N3*0.2))'
            });

            // 3. ×—×¨×™×’×” ××××•×¦×¢ ×™××™ ××©×¨××™
            const avgCreditDays = payerData.creditDays || 30;
            const creditDaysDeviation = creditDays - avgCreditDays;
            let creditDaysNormalized;
            if (creditDaysDeviation <= 0) {
                creditDaysNormalized = Math.min(1, 1 - (creditDaysDeviation / 60));
            } else {
                creditDaysNormalized = 1;
            }
            
            parameters.push({
                name: '×—×¨×™×’×” ××××•×¦×¢ ×™××™ ××©×¨××™',
                weight: 0.10,
                rawValue: creditDaysDeviation,
                normalized: creditDaysNormalized,
                weighted: creditDaysNormalized * 0.10,
                formula: 'IF(N4 <= 0, MIN(0, 1 - (N4/60),1), 1)'
            });

            // 4. ×“×™×¨×•×’ D&B
            const dbScoreRaw = dbData.dbScore || 30;
            const dbScoreNormalized = dbScoreRaw >= 30 ? dbScoreRaw / 100 : Math.max(0, (dbScoreRaw / 100) - 0.3);
            
            parameters.push({
                name: '×“×™×¨×•×’ D&B (0-100)',
                weight: 0.08,
                rawValue: dbScoreRaw,
                normalized: dbScoreNormalized,
                weighted: dbScoreNormalized * 0.08,
                formula: 'IF(N5>=30, N5/100, MAX(0, (N5/100)-0.3))'
            });

            // 5. ×“×™×¨×•×’ ×¢× ×£
            const sectorScoreRaw = dbData.sectorScore || 32;
            const sectorScoreNormalized = sectorScoreRaw >= 32 ? sectorScoreRaw / 100 : Math.max(0, (sectorScoreRaw / 100) - 0.3);
            
            parameters.push({
                name: '×“×™×¨×•×’ ×¢× ×£',
                weight: 0.05,
                rawValue: sectorScoreRaw,
                normalized: sectorScoreNormalized,
                weighted: sectorScoreNormalized * 0.05,
                formula: 'IF(N6>=32, N6/100, MAX(0, (N6/100)-0.3))'
            });

            // 6. ××¡×•×›× ×ª ××”×¢× ×£ ×©×œ×”
            const riskierThanSector = dbScoreRaw < sectorScoreRaw;
            const riskNormalized = riskierThanSector ? Math.min(0, (dbScoreRaw - sectorScoreRaw) / 50) * 10 : 0;
            
            parameters.push({
                name: '××¡×•×›× ×ª ××”×¢× ×£ ×©×œ×”',
                weight: 0.08,
                rawValue: riskierThanSector ? '×›×Ÿ' : '×œ×',
                normalized: riskNormalized,
                weighted: riskNormalized * 0.08,
                formula: 'IF(N5-N6>=0, 0, MIN(0, (N5-N6)/50)) * 10'
            });

            // 7. ×’×™×œ ×”×—×‘×¨×” ×‘×©× ×™×
            const companyAgeRaw = dbData.age || 5;
            let ageNormalized;
            if (companyAgeRaw >= 30) ageNormalized = 1;
            else if (companyAgeRaw >= 20) ageNormalized = 0.8;
            else if (companyAgeRaw >= 10) ageNormalized = 0.6;
            else if (companyAgeRaw >= 5) ageNormalized = 0.4;
            else if (companyAgeRaw >= 3) ageNormalized = 0.2;
            else ageNormalized = 0.1;
            
            parameters.push({
                name: '×’×™×œ ×”×—×‘×¨×” ×‘×©× ×™×',
                weight: 0.13,
                rawValue: companyAgeRaw,
                normalized: ageNormalized,
                weighted: ageNormalized * 0.13,
                formula: 'IF(N8>=30, 1, IF(N8>=20, 0.8, IF(N8>=10, 0.6, IF(N8>=5, 0.4, IF(N8>=3, 0.2, 0.1)))))'
            });

            // 8. ××—×–×•×¨ ×©× ×ª×™ ×‘××™×œ×™×•× ×™ ×©"×—
            const turnoverRaw = dbData.turnover || 2;
            const turnoverNormalized = Math.min(turnoverRaw / 50, 1);
            
            parameters.push({
                name: '××—×–×•×¨ ×©× ×ª×™ ×‘××™×œ×™×•× ×™ ×©"×—',
                weight: 0.03,
                rawValue: turnoverRaw,
                normalized: turnoverNormalized,
                weighted: turnoverNormalized * 0.03,
                formula: 'MIN(N9/50,1)'
            });

            // 9. ××“×“ ×¡×•×¦×™×•××§×•× ×•××™ (1-10)
            const socioIndexRaw = 6; // ×‘×¨×™×¨×ª ××—×“×œ
            const socioIndexNormalized = socioIndexRaw / 10;
            
            parameters.push({
                name: '××“×“ ×¡×•×¦×™×•××§×•× ×•××™ (1-10)',
                weight: 0.03,
                rawValue: socioIndexRaw,
                normalized: socioIndexNormalized,
                weighted: socioIndexNormalized * 0.03,
                formula: 'N10/10'
            });

            // 10. ××¡×¤×¨ ×”×ª×¨×¢×•×ª
            const warningsRaw = warningsCount || 0;
            const warningsNormalized = Math.max(0, 1 - warningsRaw * 0.2);
            
            parameters.push({
                name: '××¡×¤×¨ ×”×ª×¨×¢×•×ª',
                weight: 0.08,
                rawValue: warningsRaw,
                normalized: warningsNormalized,
                weighted: warningsNormalized * 0.08,
                formula: 'MAX(0,1-N11*0.2)'
            });

            // 11. ×”××œ×¦×”
            const recommendationRaw = '×›×Ÿ'; // ×‘×¨×™×¨×ª ××—×“×œ
            const recommendationNormalized = recommendationRaw === '×›×Ÿ' ? 1 : 0;
            
            parameters.push({
                name: '×”××œ×¦×”',
                weight: 0.05,
                rawValue: recommendationRaw,
                normalized: recommendationNormalized,
                weighted: recommendationNormalized * 0.05,
                formula: 'IF(N12="×›×Ÿ",1,0)'
            });

            // 12. ×××™×¤×” ×”×‘×¢×œ×™×
            const ownerOriginRaw = 5; // ×‘×¨×™×¨×ª ××—×“×œ
            const ownerOriginNormalized = ownerOriginRaw / 10;
            
            parameters.push({
                name: '×××™×¤×” ×”×‘×¢×œ×™×',
                weight: 0.03,
                rawValue: ownerOriginRaw,
                normalized: ownerOriginNormalized,
                weighted: ownerOriginNormalized * 0.03,
                formula: 'N13/10'
            });

            // 13. ×“×™×¨×•×’ ×”×¡× ×™×£
            const branchScoreRaw = 7; // ×‘×¨×™×¨×ª ××—×“×œ
            const branchScoreNormalized = branchScoreRaw / 10;
            
            parameters.push({
                name: '×“×™×¨×•×’ ×”×¡× ×™×£',
                weight: 0.01,
                rawValue: branchScoreRaw,
                normalized: branchScoreNormalized,
                weighted: branchScoreNormalized * 0.01,
                formula: 'N14/10'
            });

            // 14. ×¢×¡×§×” ×××•×¦×¢×ª ×œ××•×©×š
            const avgTransactionRaw = payerData.averageAmount || 50000;
            let avgTransactionNormalized;
            if (checkAmount <= avgTransactionRaw) {
                avgTransactionNormalized = 1;
            } else {
                avgTransactionNormalized = Math.max(0, 1 - (checkAmount / avgTransactionRaw - 1) * 0.5);
            }
            
            parameters.push({
                name: '×¢×¡×§×” ×××•×¦×¢×ª ×œ××•×©×š',
                weight: 0.10,
                rawValue: checkAmount / avgTransactionRaw,
                normalized: avgTransactionNormalized,
                weighted: avgTransactionNormalized * 0.10,
                formula: 'IF(C6 <=F7, 1, MAX(0, 1 - (C6/F7 - 1) * 0.5))'
            });

            // 15. ×”××•×©×š ×•×”×œ×§×•×— ×××•×ª×• ××§×•×
            const sameLocationRaw = '×›×Ÿ'; // ×‘×¨×™×¨×ª ××—×“×œ
            const sameLocationNormalized = sameLocationRaw === '×›×Ÿ' ? 1 : 0;
            
            parameters.push({
                name: '×”××•×©×š ×•×”×œ×§×•×— ×××•×ª×• ××§×•×',
                weight: 0.03,
                rawValue: sameLocationRaw,
                normalized: sameLocationNormalized,
                weighted: sameLocationNormalized * 0.03,
                formula: 'IF(N16="×›×Ÿ",1,0)'
            });

            // 16. ×¢×¨×‘×•×ª ××•×©×š
            const guaranteeRaw = '×œ×'; // ×‘×¨×™×¨×ª ××—×“×œ
            const guaranteeNormalized = guaranteeRaw === '×›×Ÿ' ? 15 : 0;
            
            parameters.push({
                name: '×¢×¨×‘×•×ª ××•×©×š',
                weight: 0.00, // ××©×§×œ 0 ×œ×¤×™ ×”× ×•×¡×—×” ×”××§×•×¨×™×ª
                rawValue: guaranteeRaw,
                normalized: guaranteeNormalized,
                weighted: guaranteeNormalized * 0.00,
                formula: 'IF(N18="×›×Ÿ",15,0)'
            });

            return parameters;
        }

        function calculateTotalScore(parameters) {
            // ×—×™×©×•×‘ ×”×¦×™×•×Ÿ ×”×›×•×œ×œ ×œ×¤×™ ×”× ×•×¡×—×” ×”××§×•×¨×™×ª
            let totalWeighted = 0;
            parameters.forEach(param => {
                totalWeighted += param.weighted;
            });
            
            // ×”×›×¤×œ×” ×‘-100 ×•×”×’×‘×œ×” ×‘×™×Ÿ 0 ×œ-100
            return Math.max(0, Math.min(100, totalWeighted * 100));
        }

        function getLetterRating(score) {
            if (score >= 90) return 'AAA';
            if (score >= 80) return 'AA';
            if (score >= 70) return 'A';
            if (score >= 60) return 'BBB';
            if (score >= 50) return 'BB';
            if (score >= 40) return 'B';
            if (score >= 30) return 'CCC';
            return 'D';
        }

        function displayResults(parameters, totalScore, letterRating, payerData, dbData) {
            // ×”×¦×’×ª ×”×“×™×¨×•×’ ×”×¨××©×™
            const ratingDisplay = document.getElementById('ratingDisplay');
            ratingDisplay.innerHTML = `
                <div class="rating-card">
                    <div class="rating-score rating-${letterRating}">${letterRating}</div>
                    <div style="color: #7f8c8d; font-size: 14px;">×“×™×¨×•×’ ××©×¨××™</div>
                </div>
                <div class="rating-card">
                    <div class="rating-score" style="color: #3498db;">${totalScore.toFixed(1)}</div>
                    <div style="color: #7f8c8d; font-size: 14px;">×¦×™×•×Ÿ ××¡×¤×¨×™</div>
                </div>
                <div class="rating-card">
                    <div class="rating-score" style="color: #e67e22;">${payerData.transactions}</div>
                    <div style="color: #7f8c8d; font-size: 14px;">×¢×¡×§××•×ª ×§×•×“××•×ª</div>
                </div>
                <div class="rating-card">
                    <div class="rating-score" style="color: #27ae60;">${dbData.dbScore}</div>
                    <div style="color: #7f8c8d; font-size: 14px;">×¦×™×•×Ÿ D&B</div>
                </div>
            `;

            // ×”×¦×’×ª ×¡×™×›×•× ×”× ×ª×•× ×™×
            const summaryGrid = document.getElementById('summaryGrid');
            summaryGrid.innerHTML = `
                <div class="summary-item">
                    <div class="summary-value">${payerData.totalAmount.toLocaleString()}</div>
                    <div class="summary-label">×¡×›×•× ×›×•×œ×œ ×¢×¡×§××•×ª ×§×•×“××•×ª</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${payerData.averageAmount.toLocaleString()}</div>
                    <div class="summary-label">×¢×¡×§×” ×××•×¦×¢×ª</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${dbData.age}</div>
                    <div class="summary-label">×’×™×œ ×”×—×‘×¨×” (×©× ×™×)</div>
                </div>
            `;

            // ×”×¦×’×ª ×¤×¨×˜×™ ×”×¤×¨××˜×¨×™×
            const parametersDisplay = document.getElementById('parametersDisplay');
            let parametersHTML = '';
            
            parameters.forEach(param => {
                parametersHTML += `
                    <div class="parameter-row">
                        <div class="parameter-name">
                            ${param.name}
                            <div class="parameter-description">××©×§×œ: ${(param.weight * 100).toFixed(0)}%</div>
                        </div>
                        <div>${(param.weight * 100).toFixed(0)}%</div>
                        <div>${typeof param.rawValue === 'number' ? param.rawValue.toFixed(2) : param.rawValue}</div>
                        <div>${param.normalized.toFixed(3)}</div>
                        <div>${param.weighted.toFixed(4)}</div>
                        <div class="formula-display">${param.formula}</div>
                    </div>
                `;
            });
            
            parametersDisplay.innerHTML = parametersHTML;

            // ×”×¦×’×ª ×”××œ×¦×”
            const recommendation = document.getElementById('recommendation');
            recommendation.className = `recommendation ${letterRating}`;
            
            let recommendationText = '';
            switch (letterRating) {
                case 'AAA':
                case 'AA':
                    recommendationText = 'âœ… ××•××œ×¥ ×××•×“ - ×¡×™×›×•×Ÿ × ××•×š, ×œ×§×•×— ××™×›×•×ª×™';
                    break;
                case 'A':
                    recommendationText = 'âš ï¸ ××•××œ×¥ ×‘×”×¡×ª×™×™×’×•×ª - ×¡×™×›×•×Ÿ ×‘×™× ×•× ×™, ×™×© ×œ×¢×§×•×‘';
                    break;
                case 'BBB':
                case 'BB':
                    recommendationText = 'ğŸ” ×–×”×™×¨×•×ª - ×¡×™×›×•×Ÿ ××•×’×‘×¨, × ×“×¨×© ××¢×§×‘ ×¦××•×“';
                    break;
                case 'B':
                case 'CCC':
                    recommendationText = 'âŒ ×œ× ××•××œ×¥ - ×¡×™×›×•×Ÿ ×’×‘×•×”, ×©×§×•×œ ×“×—×™×™×”';
                    break;
                case 'D':
                    recommendationText = 'ğŸš« ×“×—×” - ×¡×™×›×•×Ÿ ×’×‘×•×” ×××•×“, ×œ× ×œ××©×¨';
                    break;
            }
            
            recommendation.textContent = recommendationText;
        }

        function exportToExcel() {
            const data = [];
            const parameters = document.querySelectorAll('.parameter-row');
            
            // ×›×•×ª×¨×•×ª
            data.push(['×¤×¨××˜×¨', '××©×§×œ', '×¢×¨×š ×’×•×œ××™', '×× ×•×¨××œ', '××©×•×§×œ×œ', '× ×•×¡×—×”']);
            
            // × ×ª×•× ×™×
            parameters.forEach(row => {
                const cells = row.querySelectorAll('div');
                if (cells.length > 0) {
                    data.push([
                        cells[0].textContent.split('\n')[0], // ×©× ×”×¤×¨××˜×¨ ×‘×œ×‘×“
                        cells[1].textContent,
                        cells[2].textContent,
                        cells[3].textContent,
                        cells[4].textContent,
                        cells[5].textContent
                    ]);
                }
            });
            
            // ×™×¦×™×¨×ª ×§×•×‘×¥ ××§×¡×œ
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "×“×™×¨×•×’ ××©×¨××™");
            
            // ×”×•×¨×“×ª ×”×§×•×‘×¥
            const fileName = `×“×™×¨×•×’_××©×¨××™_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function resetForm() {
            // ××™×¤×•×¡ ×›×œ ×”×©×“×•×ª
            document.getElementById('customerName').value = '';
            document.getElementById('customerID').value = '';
            document.getElementById('payerName').value = '';
            document.getElementById('payerID').value = '';
            document.getElementById('checkAmount').value = '';
            document.getElementById('checkDate').value = '';
            document.getElementById('creditDays').value = '';
            document.getElementById('commission').value = '';
            
            // ×”×¡×ª×¨×ª ×”×ª×•×¦××•×ª
            document.getElementById('resultsSection').style.display = 'none';
        }

        // ×˜×™×¤×•×œ ×‘×”×¢×œ××ª ×§×‘×¦×™×
        document.getElementById('dataFiles').addEventListener('change', function(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        let data;
                        if (file.name.toLowerCase().endsWith('.csv')) {
                            const text = e.target.result;
                            const parsed = Papa.parse(text, { 
                                header: true, 
                                skipEmptyLines: true,
                                encoding: 'UTF-8'
                            });
                            data = parsed.data;
                        } else {
                            const workbook = XLSX.read(e.target.result, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            data = XLSX.utils.sheet_to_json(firstSheet);
                        }

                        // ×–×™×”×•×™ ×¡×•×’ ×”×§×•×‘×¥ ×•×¢×™×‘×•×“ ××ª××™×
                        const fileName = file.name.toLowerCase();
                        if (fileName.includes('×¢×¡×§××•×ª') || fileName.includes('transactions')) {
                            processTransactionsFile(data);
                        } else if (fileName.includes('score') || fileName.includes('×“×™×¨×•×’')) {
                            processDBScoreFile(data);
                        } else if (fileName.includes('×—×•×–×¨×™×') || fileName.includes('returned')) {
                            processReturnedChecksFile(data);
                        } else if (fileName.includes('×”×ª×¨×¢×•×ª') || fileName.includes('warnings')) {
                            processWarningsFile(data);
                        }

                        console.log(`×§×•×‘×¥ ${file.name} × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”:`, data.length, '×¨×©×•××•×ª');
                    } catch (error) {
                        console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×§×•×‘×¥:', file.name, error);
                        alert(`×©×’×™××” ×‘×˜×¢×™× ×ª ×§×•×‘×¥ ${file.name}: ${error.message}`);
                    }
                };

                if (file.name.toLowerCase().endsWith('.csv')) {
                    reader.readAsText(file, 'UTF-8');
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
        });

        function processTransactionsFile(data) {
            transactionsData = [];
            const payersMap = new Map();

            data.forEach(row => {
                const payerID = row['××¡×¤×¨ ×–×”×•×ª ××•×©×š'] || row['××¡ ×–×”×•×ª ××•×©×š'] || row['payerID'];
                const payerName = row['×©× ××•×©×š'] || row['payerName'];
                const amount = parseFloat(row['×¡×›×•×'] || row['amount']) || 0;
                const creditDays = parseInt(row['×™××™ ××©×¨××™'] || row['creditDays']) || 0;

                if (payerID) {
                    if (!payersMap.has(payerID)) {
                        payersMap.set(payerID, {
                            payerID: payerID,
                            payerName: payerName || '',
                            transactions: 0,
                            totalAmount: 0,
                            averageAmount: 0,
                            creditDays: 0,
                            totalCreditDays: 0
                        });
                    }

                    const payer = payersMap.get(payerID);
                    payer.transactions++;
                    payer.totalAmount += amount;
                    payer.totalCreditDays += creditDays;
                    payer.averageAmount = payer.totalAmount / payer.transactions;
                    payer.creditDays = payer.totalCreditDays / payer.transactions;
                }
            });

            transactionsData = Array.from(payersMap.values());
        }

        function processDBScoreFile(data) {
            dbScoreData = data.map(row => ({
                companyID: row['××¡\' ×—.×¤'] || row['××¡×¤×¨ ×—×‘×¨×”'] || row['companyID'],
                dbScore: parseFloat(row['×¡×§×•×¨'] || row['score']) || 30,
                sectorScore: parseFloat(row['×¡×§×•×¨ ×¢× ×£'] || row['sectorScore']) || 45,
                age: parseInt(row['×©× ×•×ª ×•×ª×§'] || row['age']) || 5,
                employees: parseInt(row['××¡\' ××•×¢×¡×§×™×'] || row['employees']) || 10,
                turnover: parseFloat(row['××—×–×•×¨ ×‘×\' â‚ª'] || row['turnover']) || 2
            }));
        }

        function processReturnedChecksFile(data) {
            returnedChecksData = data.map(row => ({
                payerID: row['××¡×¤×¨ ×–×”×•×ª'] || row['payerID'],
                returnedCount: parseInt(row['×—×–×¨×•×ª'] || row['returned']) || 0
            }));
        }

        function processWarningsFile(data) {
            warningsData = data.map(row => ({
                companyID: row['××¡×¤×¨ ×—×‘×¨×”'] || row['companyID'],
                warningsCount: parseInt(row['×”×ª×¨×¢×•×ª'] || row['warnings']) || 0
            }));
        }

        // ××ª×—×•×œ ×”××¢×¨×›×ª
        document.addEventListener('DOMContentLoaded', function() {
            console.log('××¢×¨×›×ª ×—×™×ª×•× ××©×¨××™ ××•×›× ×” - 16 ×¤×¨××˜×¨×™×');
        });
    </script>
</body>
</html>
