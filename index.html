// פונקציית דיבוג מתקדמת לקובץ D&B
        function debugDnbFile(workbook) {
            console.log('🔧 === דיבוג מתקדם לקובץ D&B ===');
            
            // הצגת כל הגיליונות
            console.log('📊 גיליונות בקובץ:', workbook.SheetNames);
            
            workbook.SheetNames.forEach((sheetName, index) => {
                console.log(`\n📋 גיליון ${index + 1}: "${sheetName}"`);
                
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                console.log(`   - מספר שורות: ${jsonData.length}`);
                
                // הצגת 3 השורות הראשונות
                for (let i = 0; i < Math.min(3, jsonData.length); i++) {
                    console.log(`   שורה ${i + 1}:`, jsonData[i]);
                    
                    // חיפוש עמודת "סקור" בכל שורה
                    if (jsonData[i]) {
                        const scoreIndex = jsonData[i].findIndex(cell => 
                            cell && cell.toString().trim() === 'סקור'
                        );
                        if (scoreIndex >= 0) {
                            console.log(`   🎯 נמצאה עמודת "סקור" בעמודה ${scoreIndex + 1} (${String.fromCharCode(65 + scoreIndex)})`);
                            
                            // הצגת הנתונים באותה עמודה מהשורות הבאות
                            for (let j = i + 1; j < Math.min(i + 4, jsonData.length); j++) {
                                const scoreValue = jsonData[j] ? jsonData[j][scoreIndex] : 'undefined';
                                console.log(`   ערך סקור בשורה ${j + 1}:`, scoreValue, `(סוג: ${typeof scoreValue})`);
                            }
                        }
                    }
                }
                
                // בדיקה אם זה הגיליון הנכון
                if (sheetName.toLowerCase().includes('scorem') || sheetName === 'scoreM_N') {
                    console.log(`   ✅ זה נראה כמו הגיליון הנכון!`);
                }
            });
            
            console.log('🔧 === סיום דיבוג ===\n');
        }

        function processCreditFile(workbook) {
            try {
                console.log('🏢 מתחיל עיבוד קובץ D&B...');
                
                // הפעלת דיבוג מתקדם
                debugDnbFile(workbook);
                
                console.log('📊 גיליונות זמינים בקובץ:', workbook.SheetNames);
                
                // בדיקה בסיסית שיש גיליונות
                if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                    throw new Error('לא נמצאו גיליונות בקובץ');
                }
                
                // חיפוש ספציפי לגיליון "scoreM_N" - חיפוש מדויק יותר
                let targetSheetName = null;
                
                // חיפוש ראשון: גיליון בשם "scoreM_N" בדיוק
                targetSheetName = workbook.SheetNames.find(name => 
                    name && (name === 'scoreM_N' || name === 'ScoreM_N' || name === 'SCOREM_N')
                );
                
                if (targetSheetName) {
                    console.log(`✅ נמצא גיליון scoreM_N: ${targetSheetName}`);
                } else {
                    // חיפוש שני: גיליון שמכיל "scoreM" או "scorem"
                    targetSheetName = workbook.SheetNames.find(name => 
                        name && (name.toLowerCase().includes('scorem') || name.toLowerCase().includes('score_m'))
                    );
                    
                    if (targetSheetName) {
                        console.log(`✅ נמצא גיליון דומה ל-scoreM_N: ${targetSheetName}`);
                    } else {
                        // חיפוש שלישי: גיליון שמכיל "score"
                        targetSheetName = workbook.SheetNames.find(name => 
                            name && name.toLowerCase().includes('score')
                        );
                        
                        if (targetSheetName) {
                            console.log(`✅ נמצא גיליון עם "score": ${targetSheetName}`);
                        } else {
                            // אם לא מצאנו, קח את הגיליון הראשון
                            targetSheetName = workbook.SheetNames[0];
                            console.log(`⚠️ לא נמצא גיליון מתאים, משתמש בראשון: "${targetSheetName}"`);
                        }
                    }
                }
                
                // בדיקה שיש לנו גיליון תקין
                if (!targetSheetName) {
                    throw new Error('לא נמצא גיליון תקין לעיבוד');
                }
                
                console.log(`🎯 גיליון נבחר לעיבוד: "${targetSheetName}"`);
                
                const worksheet = workbook.Sheets[targetSheetName];
                if (!worksheet) {
                    throw new Error(`גיליון "${targetSheetName}" לא קיים או ריק`);
                }
                
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (!jsonData || jsonData.length === 0) {
                    throw new Error(`גיליון "${targetSheetName}" ריק או לא מכיל נתונים`);
                }
                
                console.log(`📊 נתוני גיליון "${targetSheetName}" (${jsonData.length} שורות סה"כ):`);
                console.log('🔍 מציג 5 שורות ראשונות:');
                for (let i = 0; i < Math.min(5, jsonData.length); i++) {
                    console.log(`שורה ${i + 1}:`, jsonData[i]);
                }
                
                // חיפוש תחילת הטבלה - חיפוש משופר
                let tableStartRow = -1;
                
                console.log('🔍 מחפש שורת כותרות...');
                
                // חיפוש שורה שמכילה את הכותרות - חיפוש גמיש יותר
                for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                    const row = jsonData[i];
                    if (!row || row.length < 5) continue;
                    
                    // חיפוש הכותרת "סקור" - זו הכותרת הקריטית
                    const scoreColumnIndex = row.findIndex(cell => 
                        cell && cell.toString().trim() === 'סקור'
                    );
                    
                    if (scoreColumnIndex >= 0) {
                        tableStartRow = i;
                        console.log(`✅ נמצאת שורת כותרות בשורה ${i + 1} - עמודת "סקור" באינדקס ${scoreColumnIndex} (עמודה ${String.fromCharCode(65 + scoreColumnIndex)})`);
                        console.log(`📋 כותרות מלאות:`, row);
                        
                        // הצגת דוגמה מהנתונים מתחת לכותרת
                        console.log('🔍 דוגמאות ערכי סקור:');
                        for (let j = i + 1; j < Math.min(i + 4, jsonData.length); j++) {
                            const scoreValue = jsonData[j] ? jsonData[j][scoreColumnIndex] : 'undefined';
                            const companyName = jsonData[j] ? jsonData[j][0] : 'unknown'; // נניח שהשם בעמודה הראשונה
                            console.log(`  שורה ${j + 1}: חברה="${companyName}", סקור="${scoreValue}" (סוג: ${typeof scoreValue})`);
                        }
                        
                        break;
                    }
                    
                    // חיפוש חלופי - חיפוש כותרות נוספות
                    const hasPayerName = row.some(cell => cell && (
                        cell.toString().includes('שם מושך') || 
                        cell.toString().includes('שם חברה') ||
                        cell.toString().includes('שם המושך')
                    ));
                    
                    const hasPayerId = row.some(cell => cell && (
                        cell.toString().includes('מס\' ח.פ') ||
                        cell.toString().includes('ח.פ') ||
                        cell.toString().includes('מזהה')
                    ));
                    
                    const hasScore = row.some(cell => cell && (
                        cell.toString().trim() === 'סקור' ||
                        cell.toString().includes('דירוג') ||
                        cell.toString().includes('ציון')
                    ));
                    
                    if (hasPayerName && hasPayerId && hasScore) {
                        tableStartRow = i;
                        console.log(`✅ נמצאת שורת כותרות חלופית בשורה ${i + 1}`);
                        console.log(`📋 כותרות:`, row);
                        break;
                    }
                }
                
                // אם לא מצאנו כותרות, נשתמש בשורה הראשונה
                if (tableStartRow === -1) {
                    console.log('🔍 לא נמצאו כותרות ברורות, בודק את השורה הראשונה...');
                    const firstRow = jsonData[0];
                    if (firstRow && firstRow.length >= 5) {
                        // בדוק אם יש עמודה עם "סקור"
                        const hasScoreColumn = firstRow.some(cell => 
                            cell && cell.toString().trim() === 'סקור'
                        );
                        
                        if (hasScoreColumn) {
                            tableStartRow = 0;
                            console.log(`✅ נמצאה עמודת "סקור" בשורה הראשונה`);
                        } else {
                            // כאפשרות אחרונה - שורה הראשונה
                            tableStartRow = 0;
                            console.log('⚠️ משתמש בשורה הראשונה כברירת מחדל');
                        }
                    } else {
                        throw new Error('לא נמצאו כותרות תקינות בגיליון');
                    }
                }
                
                console.log(`📊 מתחיל עיבוד מהשורה ${tableStartRow + 1}`);
                
                // חילוץ הטבלה מהשורה המתאימה
                const tableData = jsonData.slice(tableStartRow);
                
                if (tableData.length <= 1) {
                    throw new Error(`טבלה בגיליון "${targetSheetName}" ריקה או מכילה רק כותרות`);
                }
                
                console.log(`📊 נתוני טבלה לעיבוד: ${tableData.length} שורות (כולל כותרות)`);
                console.log('📋 כותרות שיעובדו:', tableData[0]);
                if (tableData[1]) {
                    console.log('📋 דוגמה לנתונים (שורה 2):', tableData[1]);
                }
                
                // בדיקה שיש עמודת "סקור"
                const headers = tableData[0];
                const scoreColumnIndex = headers ? headers.findIndex(cell => 
                    cell && cell.toString().trim() === 'סקור'
                ) : -1;
                
                if (scoreColumnIndex === -1) {
                    console.warn('⚠️ לא נמצאה עמודת "סקור" בכותרות');
                    console.log('🔍 כותרות זמינות:', headers.map((h, i) => `${String.fromCharCode(65 + i)}:${h}`));
                } else {
                    console.log(`✅ עמודת "סקור" נמצאה באינדקס ${scoreColumnIndex} (עמודה ${String.fromCharCode(65 + scoreColumnIndex)})`);
                }
                
                excelData.credit = tableData;
                processDnbData();
                
                const dataRowsCount = tableData.length - 1;
                console.log(`🏢 הושלם עיבוד טבלת scoreM_N מגיליון "${targetSheetName}": ${dataRowsCount} חברות`);
                showNotification(`✅ נטענה טבלת D&B מגיליון "${targetSheetName}" - ${dataRowsCount} חברות`, 'success');
                
            } catch (error) {
                console.error('❌ שגיאה בעיבוד קובץ D&B:', error);
                showNotification('❌ שגיאה בעיבוד קובץ D&B: ' + error.message, 'error');
                
                // הצגת מידע נוסף לדיבוג
                console.log('🔧 מידע נוסף לדיבוג:');
                console.log('- נדרש קובץ Excel עם גיליון בשם "scoreM_N"');
                console.log('- בגיליון צריכה להיות עמודה בשם "סקור"');
                console.log('- גיליונות זמינים בקובץ:', workbook.SheetNames);
                if (workbook.SheetNames && workbook.SheetNames.length > 0) {
                    console.log('- גיליון ראשון בקובץ:', workbook.SheetNames[0]);
                    
                    // בדיקה מהירה של הגיליון הראשון
                    try {
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const firstSheetData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        if (firstSheetData[0]) {
                            console.log('- כותרות בגיליון הראשון:', firstSheetData[0].map((h, i) => `${String.fromCharCode(65 + i)}:${h}`));
                        }
                    } catch (debugError) {
                        console.log('- לא ניתן לקרוא את הגיליון הראשון');
                    }
                }
                
                throw error;
            }
        }
