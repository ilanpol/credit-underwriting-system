<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת חיתום אשראי מתקדמת</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; direction: rtl; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; text-align: center; margin-bottom: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .header h1 { color: #2c3e50; font-size: 2.5em; margin-bottom: 10px; }
        .header p { color: #7f8c8d; font-size: 1.2em; }
        .main-content { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; margin-bottom: 30px; }
        .input-section, .results-section { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); }
        .results-section { display: none; }
        .form-group { margin-bottom: 25px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; font-size: 14px; }
        input, select { width: 100%; padding: 12px 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 16px; transition: all 0.3s ease; }
        input:focus, select:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .autocomplete-container { position: relative; }
        .autocomplete-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e1e8ed; border-top: none; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
        .autocomplete-suggestion { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f8f9fa; }
        .autocomplete-suggestion:hover { background: #f8f9fa; }
        .suggestion-name { font-weight: 600; color: #2c3e50; }
        .suggestion-id { font-size: 12px; color: #7f8c8d; margin-top: 2px; }
        .btn { background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 15px 30px; border: none; border-radius: 50px; font-size: 18px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s ease; margin-top: 20px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4); }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }
        .rating-display { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .rating-card { background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .rating-score { font-size: 3em; font-weight: bold; margin-bottom: 10px; }
        .rating-D { color: #e74c3c; } .rating-CCC { color: #e67e22; } .rating-B { color: #f39c12; } .rating-BB { color: #f1c40f; } .rating-BBB { color: #f39c12; } .rating-A { color: #27ae60; } .rating-AA { color: #2ecc71; } .rating-AAA { color: #27ae60; }
        .details-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .detail-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .detail-card h3 { color: #2c3e50; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #ecf0f1; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
        .detail-label { color: #7f8c8d; } .detail-value { font-weight: 600; color: #2c3e50; }
        .parameters-section { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        .parameter-item { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 15px; padding: 15px; border-bottom: 1px solid #ecf0f1; align-items: center; }
        .parameter-item:last-child { border-bottom: none; }
        .parameter-name { font-weight: 600; color: #2c3e50; }
        .parameter-reason { font-size: 12px; color: #7f8c8d; margin-top: 5px; }
        .status-badge { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; text-align: center; }
        .status-positive { background: #d5f4e6; color: #27ae60; } .status-negative { background: #fadbd8; color: #e74c3c; } .status-neutral { background: #eaecee; color: #7f8c8d; } .status-missing { background: #fdf2e9; color: #e67e22; }
        .recommendation { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 25px; border-radius: 15px; text-align: center; margin: 20px 0; font-size: 1.2em; font-weight: 600; }
        .recommendation.positive { background: linear-gradient(135deg, #27ae60, #229954); }
        .recommendation.warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .file-upload { background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 10px; padding: 20px; text-align: center; margin-bottom: 20px; transition: all 0.3s ease; }
        .file-upload:hover { border-color: #3498db; background: #f0f8ff; }
        .file-upload input { display: none; }
        .file-upload label { cursor: pointer; color: #3498db; font-weight: 600; }
        .data-status { background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .data-status h3 { color: #2c3e50; margin-bottom: 10px; }
        .data-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #ecf0f1; }
        .data-item:last-child { border-bottom: none; }
        .data-item-name { color: #34495e; font-weight: 500; }
        .data-item-status { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .status-loaded { background: #d5f4e6; color: #27ae60; } .status-missing { background: #fadbd8; color: #e74c3c; }
        @media (max-width: 768px) { .main-content { grid-template-columns: 1fr; } .details-grid { grid-template-columns: 1fr; } .rating-display { grid-template-columns: 1fr; } .parameter-item { grid-template-columns: 1fr; gap: 5px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏦 מערכת חיתום אשראי מתקדמת</h1>
            <p>הערכת סיכונים וחישוב דירוג אשראי על בסיס 16 פרמטרים</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2 style="margin-bottom: 25px; color: #2c3e50;">פרטי השיק והמושך</h2>
                
                <div class="data-status" id="dataStatus">
                    <h3>סטטוס קבצי נתונים</h3>
                    <div class="data-item">
                        <span class="data-item-name">גיליון עסקאות</span>
                        <span class="data-item-status status-missing" id="status-transactions">לא נטען</span>
                    </div>
                    <div class="data-item">
                        <span class="data-item-name">נתוני מושכים</span>
                        <span class="data-item-status status-loaded" id="status-payers">4 מושכים (דוגמה)</span>
                    </div>
                    <div class="data-item">
                        <span class="data-item-name">נתוני לקוחות</span>
                        <span class="data-item-status status-loaded" id="status-customers">4 לקוחות (דוגמה)</span>
                    </div>
                </div>

                <div class="file-upload">
                    <label for="dataFiles">📁 העלה קבצי נתונים (Excel/CSV)</label>
                    <input type="file" id="dataFiles" multiple accept=".xlsx,.xls,.csv">
                    <p style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">העלה את הקבצים שלך כדי לקבל דירוג מדויק</p>
                </div>
                
                <div class="form-group">
                    <label for="payerName">שם מושך</label>
                    <div class="autocomplete-container">
                        <input type="text" id="payerName" placeholder="התחל להקליד שם מושך..." autocomplete="off">
                        <div id="payerSuggestions" class="autocomplete-suggestions"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="payerID">ח.פ./ע.מ. מושך</label>
                    <input type="text" id="payerID" placeholder="יתמלא אוטומטי" readonly style="background: #f8f9fa;">
                </div>

                <div class="form-group">
                    <label for="customerName">שם לקוח</label>
                    <div class="autocomplete-container">
                        <input type="text" id="customerName" placeholder="התחל להקליד שם לקוח..." autocomplete="off">
                        <div id="customerSuggestions" class="autocomplete-suggestions"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="customerID">ח.פ./ע.מ. לקוח</label>
                    <input type="text" id="customerID" placeholder="יתמלא אוטומטי" readonly style="background: #f8f9fa;">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="checkAmount">סכום השיק</label>
                        <input type="number" id="checkAmount" placeholder="סכום בש״ח">
                    </div>
                    <div class="form-group">
                        <label for="paymentDate">תאריך פירעון</label>
                        <input type="date" id="paymentDate">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="bankCode">בנק</label>
                        <input type="text" id="bankCode" placeholder="קוד בנק">
                    </div>
                    <div class="form-group">
                        <label for="branchCode">סניף</label>
                        <input type="text" id="branchCode" placeholder="קוד סניף">
                    </div>
                </div>

                <button class="btn" onclick="calculateRating()">🧮 חשב דירוג אשראי מתקדם</button>
                <button class="btn" style="background: #95a5a6; margin-top: 10px;" onclick="loadExample()">📋 טען דוגמה מהירה</button>
            </div>

            <div class="results-section" id="resultsSection">
                <div class="rating-display" id="ratingDisplay"></div>
                <div class="details-grid" id="detailsGrid"></div>
                <div class="parameters-section">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">פירוט פרמטרי הדירוג (16 פרמטרים)</h3>
                    <div id="parametersGrid"></div>
                </div>
                <div id="recommendation" class="recommendation"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" style="width: auto; margin-right: 10px;" onclick="window.print()">🖨️ הדפס דוח</button>
                    <button class="btn" style="width: auto; background: #95a5a6;" onclick="resetForm()">🔄 עסקה חדשה</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let payersData = [
            { name: 'הדר בניה אחזקה', id: '200353902', transactions: 0, dbScore: 38.704, sectorScore: 29, returnedChecks: 0 },
            { name: 'איברהים ראבי', id: '305346900', transactions: 0, dbScore: 45.2, sectorScore: 32, returnedChecks: 0 },
            { name: 'חברת הבנייה הגדולה', id: '123456789', transactions: 15, dbScore: 72.5, sectorScore: 65, returnedChecks: 1 },
            { name: 'משה כהן', id: '987654321', transactions: 8, dbScore: 55.8, sectorScore: 50, returnedChecks: 0 }
        ];

        let customersData = [
            { name: 'איברהים ראבי', id: '305346900' },
            { name: 'שרה לוי', id: '123456788' },
            { name: 'דוד ישראלי', id: '111222333' },
            { name: 'מירב פולק', id: '444555666' }
        ];

        function initializeSystem() {
            setupAutocomplete();
            setupFileUpload();
        }

        function setupAutocomplete() {
            document.getElementById('payerName').addEventListener('input', (e) => showSuggestions(e, 'payers'));
            document.getElementById('customerName').addEventListener('input', (e) => showSuggestions(e, 'customers'));
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container')) {
                    hideSuggestions();
                }
            });
        }

        function setupFileUpload() {
            document.getElementById('dataFiles').addEventListener('change', handleFileUpload);
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                alert(`נטענו ${files.length} קבצים. בגרסה זו עדיין נשתמש בנתוני הדוגמה.`);
            }
        }

        function showSuggestions(event, type) {
            const input = event.target;
            const query = input.value.toLowerCase();
            const suggestionsId = type === 'payers' ? 'payerSuggestions' : 'customerSuggestions';
            const suggestionsContainer = document.getElementById(suggestionsId);
            
            if (query.length < 2) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            const data = type === 'payers' ? payersData : customersData;
            const filtered = data.filter(item => item.name.toLowerCase().includes(query)).slice(0, 10);
            
            if (filtered.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            suggestionsContainer.innerHTML = filtered.map(item => `
                <div class="autocomplete-suggestion" onclick="selectSuggestion('${type}', '${item.name}', '${item.id}')">
                    <div class="suggestion-name">${item.name}</div>
                    <div class="suggestion-id">${item.id}</div>
                </div>
            `).join('');
            
            suggestionsContainer.style.display = 'block';
        }

        function selectSuggestion(type, name, id) {
            if (type === 'payers') {
                document.getElementById('payerName').value = name;
                document.getElementById('payerID').value = id;
            } else {
                document.getElementById('customerName').value = name;
                document.getElementById('customerID').value = id;
            }
            hideSuggestions();
        }

        function hideSuggestions() {
            document.getElementById('payerSuggestions').style.display = 'none';
            document.getElementById('customerSuggestions').style.display = 'none';
        }

        function calculateRating() {
            const payerName = document.getElementById('payerName').value;
            const payerID = document.getElementById('payerID').value;
            const customerName = document.getElementById('customerName').value;
            const customerID = document.getElementById('customerID').value;
            const checkAmount = parseFloat(document.getElementById('checkAmount').value);

            if (!payerName || !customerName || !checkAmount) {
                alert('אנא מלא את השדות החובה: שם מושך, שם לקוח וסכום השיק');
                return;
            }

            const payerData = payersData.find(p => p.id === payerID || p.name === payerName) || payersData[0];
            const customerData = customersData.find(c => c.id === customerID || c.name === customerName) || customersData[0];

            const today = new Date();
            const payment = document.getElementById('paymentDate').value ? 
                new Date(document.getElementById('paymentDate').value) : 
                new Date(today.getTime() + 46*24*60*60*1000);
            const creditDays = Math.ceil((payment - today) / (1000 * 60 * 60 * 24));

            const parameters = [
                { name: 'מספר עסקאות קודמות', weight: 15, rawValue: payerData.transactions, 
                  normalizedValue: payerData.transactions >= 10 ? 0.8 : payerData.transactions >= 5 ? 0.4 : 0.1,
                  reason: payerData.transactions === 0 ? 'אין עסקאות קודמות - מושך חדש' : `${payerData.transactions} עסקאות קודמות`,
                  status: payerData.transactions === 0 ? 'missing' : payerData.transactions >= 10 ? 'positive' : 'neutral' },
                { name: 'מספר חזרות שיקים', weight: 5, rawValue: payerData.returnedChecks,
                  normalizedValue: payerData.returnedChecks === 0 ? 1 : Math.max(0, 1 - payerData.returnedChecks * 0.2),
                  reason: payerData.returnedChecks === 0 ? 'אין חזרות שיקים' : `${payerData.returnedChecks} חזרות שיקים`,
                  status: payerData.returnedChecks === 0 ? 'positive' : 'negative' },
                { name: 'חריגה מממוצע ימי אשראי', weight: 10, rawValue: creditDays,
                  normalizedValue: creditDays <= 30 ? 1 : Math.max(0, 1 - (creditDays - 30) / 60),
                  reason: creditDays > 30 ? 'ימי אשראי מעל הממוצע' : 'ימי אשראי תקינים',
                  status: creditDays <= 30 ? 'positive' : 'negative' },
                { name: 'דירוג D&B', weight: 8, rawValue: payerData.dbScore,
                  normalizedValue: payerData.dbScore >= 30 ? payerData.dbScore / 100 : 0,
                  reason: payerData.dbScore <= 30 ? 'ציון D&B נמוך - NO☢️' : 'ציון D&B בינוני - OK✅',
                  status: payerData.dbScore <= 30 ? 'negative' : 'neutral' },
                { name: 'דירוג ענף', weight: 5, rawValue: payerData.sectorScore,
                  normalizedValue: payerData.sectorScore / 100,
                  reason: 'דירוג ענף',
                  status: 'neutral' }
            ];

            let finalScore = 0;
            parameters.forEach(param => {
                finalScore += (param.normalizedValue * param.weight) / 100;
            });
            finalScore = Math.max(0, Math.min(100, finalScore * 100));

            const rating = finalScore >= 90 ? 'AAA' : finalScore >= 80 ? 'AA' : finalScore >= 70 ? 'A' : 
                          finalScore >= 60 ? 'BBB' : finalScore >= 50 ? 'BB' : finalScore >= 40 ? 'B' : 
                          finalScore >= 30 ? 'CCC' : 'D';

            const recommendation = finalScore >= 70 ? 'מומלץ' : finalScore >= 50 ? 'בבדיקה נוספת' : 'לא מומלץ';
            const recommendationClass = finalScore >= 70 ? 'positive' : finalScore >= 50 ? 'warning' : '';

            displayResults({
                payerName, customerName, payerID, customerID, checkAmount, creditDays,
                finalScore, rating, recommendation, recommendationClass, parameters, payerData
            });
        }

        function displayResults(results) {
            document.getElementById('ratingDisplay').innerHTML = `
                <div class="rating-card">
                    <div class="rating-score rating-${results.rating}">${results.finalScore.toFixed(1)}</div>
                    <div>ציון סופי</div>
                </div>
                <div class="rating-card">
                    <div class="rating-score rating-${results.rating}">${results.rating}</div>
                    <div>דירוג אשראי</div>
                </div>
                <div class="rating-card">
                    <div style="font-size: 2em; margin-bottom: 10px;">📊</div>
                    <div>רמת סיכון: ${results.finalScore >= 70 ? 'נמוכה' : results.finalScore >= 50 ? 'בינונית' : 'גבוהה'}</div>
                </div>
            `;

            document.getElementById('detailsGrid').innerHTML = `
                <div class="detail-card">
                    <h3>פרטי העסקה</h3>
                    <div class="detail-row"><span class="detail-label">מושך:</span><span class="detail-value">${results.payerName}</span></div>
                    <div class="detail-row"><span class="detail-label">ח.פ. מושך:</span><span class="detail-value">${results.payerID}</span></div>
                    <div class="detail-row"><span class="detail-label">לקוח:</span><span class="detail-value">${results.customerName}</span></div>
                    <div class="detail-row"><span class="detail-label">ח.פ. לקוח:</span><span class="detail-value">${results.customerID}</span></div>
                    <div class="detail-row"><span class="detail-label">סכום:</span><span class="detail-value">₪${results.checkAmount.toLocaleString()}</span></div>
                    <div class="detail-row"><span class="detail-label">ימי אשראי:</span><span class="detail-value">${results.creditDays}</span></div>
                </div>
                <div class="detail-card">
                    <h3>נתוני מושך</h3>
                    <div class="detail-row"><span class="detail-label">עסקאות קודמות:</span><span class="detail-value">${results.payerData.transactions}</span></div>
                    <div class="detail-row"><span class="detail-label">חזרות שיקים:</span><span class="detail-value">${results.payerData.returnedChecks}</span></div>
                    <div class="detail-row"><span class="detail-label">ציון D&B:</span><span class="detail-value">${results.payerData.dbScore}</span></div>
                    <div class="detail-row"><span class="detail-label">ציון ענף:</span><span class="detail-value">${results.payerData.sectorScore}</span></div>
                </div>
                <div class="detail-card">
                    <h3>מידע נוסף</h3>
                    <div class="detail-row"><span class="detail-label">מקור נתונים:</span><span class="detail-value">נתוני דוגמה</span></div>
                    <div class="detail-row"><span class="detail-label">תאריך חישוב:</span><span class="detail-value">${new Date().toLocaleDateString('he-IL')}</span></div>
                </div>
            `;

            let parametersHTML = `<div class="parameter-item" style="font-weight: bold; background: #f8f9fa;">
                <div>פרמטר</div><div>משקל</div><div>ערך גולמי</div><div>ערך מנורמל</div><div>סטטוס</div></div>`;
            
            results.parameters.forEach(param => {
                parametersHTML += `<div class="parameter-item">
                    <div><div class="parameter-name">${param.name}</div><div class="parameter-reason">${param.reason}</div></div>
                    <div>${param.weight}%</div><div>${param.rawValue}</div><div>${param.normalizedValue.toFixed(3)}</div>
                    <div><span class="status-badge status-${param.status}">${param.status === 'positive' ? 'חיובי' : param.status === 'negative' ? 'שלילי' : param.status === 'missing' ? 'חסר' : 'ניטרלי'}</span></div></div>`;
            });

            document.getElementById('parametersGrid').innerHTML = parametersHTML;

            document.getElementById('recommendation').className = `recommendation ${results.recommendationClass}`;
            document.getElementById('recommendation').innerHTML = `
                <div style="font-size: 1.5em; margin-bottom: 10px;">
                    ${results.recommendation === 'מומלץ' ? '✅' : results.recommendation === 'בבדיקה נוספת' ? '⚠️' : '❌'}
                </div>
                <div>המלצה סופית: ${results.recommendation}</div>
                ${results.finalScore < 30 ? '<div style="margin-top: 10px; font-size: 0.9em;">עסקה בסיכון גבוה - נדרשת בדיקה מעמיקה</div>' : ''}
                <div style="margin-top: 10px; font-size: 0.9em;">⚠️ מבוסס על נתוני דוגמה - העלה קבצים אמיתיים לדיוק מלא</div>
            `;

            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('payerName').value = '';
            document.getElementById('payerID').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('customerID').value = '';
            document.getElementById('checkAmount').value = '';
            document.getElementById('paymentDate').value = '';
            document.getElementById('bankCode').value = '';
            document.getElementById('branchCode').value = '';
            document.getElementById('resultsSection').style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function loadExample() {
            document.getElementById('payerName').value = 'הדר בניה אחזקה';
            document.getElementById('payerID').value = '200353902';
            document.getElementById('customerName').value = 'איברהים ראבי';
            document.getElementById('customerID').value = '305346900';
            document.getElementById('checkAmount').value = '50000';
            document.getElementById('bankCode').value = '20';
            document.getElementById('branchCode').value = '512';
            
            const futureDate = new Date();
            futureDate.setDate(futureDate.getDate() + 46);
            document.getElementById('paymentDate').value = futureDate.toISOString().split('T')[0];
        }

        window.addEventListener('load', initializeSystem);
    </script>
</body>
</html>
