<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×—×™×ª×•× ××©×¨××™ - ×××•×‘×˜×—×ª</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            direction: rtl; 
        }
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .login-card h1 { color: #2c3e50; margin-bottom: 30px; }
        .login-form .form-group { margin-bottom: 20px; text-align: right; }
        .login-form label { display: block; margin-bottom: 5px; font-weight: 600; color: #34495e; }
        .login-form input { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e1e8ed; 
            border-radius: 8px; 
            font-size: 14px; 
        }
        .login-form input:focus { outline: none; border-color: #3498db; }
        .login-btn { 
            background: linear-gradient(135deg, #3498db, #2980b9); 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 25px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 10px;
        }
        .login-btn:hover { background: linear-gradient(135deg, #2980b9, #1f639a); }
        .error-message { color: #e74c3c; margin-top: 10px; font-size: 14px; }
        .main-app { display: none; }
        .container { max-width: 1800px; margin: 0 auto; padding: 20px; }
        .header { 
            background: rgba(255, 255, 255, 0.95); 
            padding: 20px 30px; 
            border-radius: 20px; 
            margin-bottom: 30px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-content h1 { color: #2c3e50; font-size: 2.2em; margin-bottom: 5px; }
        .header-content p { color: #7f8c8d; font-size: 1.1em; }
        .user-info { text-align: left; }
        .user-info span { color: #2c3e50; font-weight: 600; }
        .logout-btn { 
            background: #e74c3c; 
            color: white; 
            padding: 8px 16px; 
            border: none; 
            border-radius: 15px; 
            cursor: pointer; 
            margin-top: 5px;
        }
        .main-content { 
            display: grid; 
            grid-template-columns: 1fr 2fr; 
            gap: 30px; 
            margin-bottom: 30px; 
        }
        .input-section, .results-section { 
            background: rgba(255, 255, 255, 0.95); 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); 
        }
        .results-section { display: none; }
        .form-group { margin-bottom: 20px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600; 
            color: #34495e; 
            font-size: 14px; 
        }
        input, select { 
            width: 100%; 
            padding: 10px 12px; 
            border: 2px solid #e1e8ed; 
            border-radius: 8px; 
            font-size: 14px; 
            transition: all 0.3s ease; 
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: #3498db; 
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); 
        }
        .btn { 
            background: linear-gradient(135deg, #3498db, #2980b9); 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 25px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            width: 100%; 
            transition: all 0.3s ease; 
            margin-top: 15px; 
        }
        .btn:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4); 
        }
        .btn:disabled { 
            background: #bdc3c7; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }
        .data-status { 
            background: #f8f9fa; 
            border-radius: 10px; 
            padding: 15px; 
            margin-bottom: 20px; 
        }
        .data-status h3 { color: #2c3e50; margin-bottom: 10px; }
        .status-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 0; 
            border-bottom: 1px solid #ecf0f1; 
        }
        .status-item:last-child { border-bottom: none; }
        .status-loaded { color: #27ae60; font-weight: 600; }
        .status-missing { color: #e74c3c; font-weight: 600; }
        .rating-display { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .rating-card { 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            text-align: center; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
        }
        .rating-score { 
            font-size: 3em; 
            font-weight: bold; 
            margin-bottom: 10px; 
        }
        .rating-AAA { color: #27ae60; }
        .rating-AA { color: #2ecc71; }
        .rating-A { color: #f39c12; }
        .rating-BBB { color: #f1c40f; }
        .rating-BB { color: #e67e22; }
        .rating-B { color: #e74c3c; }
        .rating-CCC { color: #c0392b; }
        .rating-D { color: #8b0000; }
        .parameters-section { 
            background: white; 
            border-radius: 15px; 
            padding: 20px; 
            margin-bottom: 20px; 
        }
        .parameter-header { 
            display: grid; 
            grid-template-columns: 3fr 1fr 1fr 1fr 1fr; 
            gap: 10px; 
            padding: 12px; 
            background: #f8f9fa; 
            border-radius: 8px; 
            font-weight: bold; 
            margin-bottom: 10px; 
            font-size: 14px;
        }
        .parameter-row { 
            display: grid; 
            grid-template-columns: 3fr 1fr 1fr 1fr 1fr; 
            gap: 10px; 
            padding: 10px 12px; 
            border-bottom: 1px solid #ecf0f1; 
            align-items: center; 
            font-size: 13px;
        }
        .parameter-row:last-child { border-bottom: none; }
        .parameter-name { font-weight: 600; color: #2c3e50; }
        .recommendation { 
            text-align: center; 
            margin: 20px 0; 
            font-size: 1.2em; 
            font-weight: 600; 
            padding: 25px;
            border-radius: 15px;
        }
        .recommendation.excellent { background: linear-gradient(135deg, #27ae60, #229954); color: white; }
        .recommendation.good { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; }
        .recommendation.average { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .recommendation.poor { background: linear-gradient(135deg, #e67e22, #d35400); color: white; }
        .recommendation.danger { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .history-section { 
            background: white; 
            border-radius: 15px; 
            padding: 20px; 
            margin-bottom: 20px; 
        }
        .history-item { 
            padding: 15px; 
            border: 1px solid #ecf0f1; 
            border-radius: 10px; 
            margin-bottom: 10px; 
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 100px;
            gap: 15px;
            align-items: center;
        }
        .history-item:last-child { margin-bottom: 0; }
        .history-rating { font-size: 1.5em; font-weight: bold; }
        @media (max-width: 1200px) { 
            .main-content { grid-template-columns: 1fr; } 
            .rating-display { grid-template-columns: repeat(2, 1fr); } 
            .parameter-header, .parameter-row { 
                grid-template-columns: 2fr 1fr 1fr; 
                font-size: 12px; 
            }
        }
    </style>
</head>
<body>
    <!-- ××¡×š ×”×ª×—×‘×¨×•×ª -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h1>ğŸ¦ ××¢×¨×›×ª ×—×™×ª×•× ××©×¨××™</h1>
            <form class="login-form" onsubmit="return login(event)">
                <div class="form-group">
                    <label for="username">×©× ××©×ª××©</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">×¡×™×¡××”</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="login-btn">×”×ª×—×‘×¨</button>
                <div id="loginError" class="error-message" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- ×”××¤×œ×™×§×¦×™×” ×”×¨××©×™×ª -->
    <div id="mainApp" class="main-app">
        <div class="container">
            <div class="header">
                <div class="header-content">
                    <h1>ğŸ¦ ××¢×¨×›×ª ×—×™×ª×•× ××©×¨××™ ××ª×§×“××ª</h1>
                    <p>×—×™×©×•×‘ ×“×™×¨×•×’ ××©×¨××™ ×œ×¤×™ 16 ×¤×¨××˜×¨×™× ××“×•×™×§×™×</p>
                </div>
                <div class="user-info">
                    <span id="currentUser"></span>
                    <br>
                    <button onclick="logout()" class="logout-btn">×”×ª× ×ª×§</button>
                </div>
            </div>

            <div class="main-content">
                <div class="input-section">
                    <h2 style="margin-bottom: 20px; color: #2c3e50; font-size: 18px;">×¤×¨×˜×™ ×”×¢×¡×§×”</h2>
                    
                    <div class="data-status">
                        <h3>×¡×˜×˜×•×¡ ×§×‘×¦×™ × ×ª×•× ×™× - OneDrive</h3>
                        <div class="status-item">
                            <span>×’×™×œ×™×•×Ÿ ×¢×¡×§××•×ª</span>
                            <span id="transactionsStatus" class="status-missing">×œ× × ×˜×¢×Ÿ</span>
                        </div>
                        <div class="status-item">
                            <span>× ×ª×•× ×™ D&B</span>
                            <span id="dbStatus" class="status-missing">×œ× × ×˜×¢×Ÿ</span>
                        </div>
                        <div class="status-item">
                            <span>×©×™×§×™× ×—×•×–×¨×™×</span>
                            <span id="returnedStatus" class="status-missing">×œ× × ×˜×¢×Ÿ</span>
                        </div>
                        <div class="status-item">
                            <span>×”×ª×¨×¢×•×ª</span>
                            <span id="warningsStatus" class="status-missing">×œ× × ×˜×¢×Ÿ</span>
                        </div>
                        <button onclick="configureOneDriveLinks()" style="width: 100%; margin-top: 10px; padding: 8px; background: #0078d4; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            âš™ï¸ ×”×’×“×¨ ×§×™×©×•×¨×™ OneDrive
                        </button>
                        <button onclick="loadDataFiles()" style="width: 100%; margin-top: 5px; padding: 8px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ğŸ”„ ×¨×¢× ×Ÿ × ×ª×•× ×™×
                        </button>
                    </div>

                    <div class="form-group">
                        <label for="customerName">×©× ×œ×§×•×—</label>
                        <input type="text" id="customerName" placeholder="×”×–×Ÿ ×©× ×œ×§×•×—">
                    </div>

                    <div class="form-group">
                        <label for="customerID">×—.×¤./×ª.×–. ×œ×§×•×—</label>
                        <input type="text" id="customerID" placeholder="×”×–×Ÿ ××¡×¤×¨ ×–×”×•×ª ×œ×§×•×—">
                    </div>

                    <div class="form-group">
                        <label for="payerName">×©× ××•×©×š</label>
                        <input type="text" id="payerName" placeholder="×”×–×Ÿ ×©× ××•×©×š">
                    </div>

                    <div class="form-group">
                        <label for="payerID">×—.×¤./×ª.×–. ××•×©×š</label>
                        <input type="text" id="payerID" placeholder="×”×–×Ÿ ××¡×¤×¨ ×–×”×•×ª ××•×©×š">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="checkAmount">×¡×›×•× ×”×©×™×§</label>
                            <input type="number" id="checkAmount" placeholder="×¡×›×•× ×‘×©×´×—">
                        </div>
                        <div class="form-group">
                            <label for="checkDate">×ª××¨×™×š ×”×©×™×§</label>
                            <input type="date" id="checkDate">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="creditDays">×™××™ ××©×¨××™</label>
                            <input type="number" id="creditDays" placeholder="××¡×¤×¨ ×™××™ ××©×¨××™">
                        </div>
                        <div class="form-group">
                            <label for="commission">×¢××œ×”</label>
                            <input type="number" id="commission" step="0.01" placeholder="×¢××œ×” ×‘%">
                        </div>
                    </div>

                    <button class="btn" onclick="calculateCreditRating()" id="calculateBtn">
                        ğŸ§® ×—×©×‘ ×“×™×¨×•×’ ××©×¨××™
                    </button>

                    <button class="btn" style="background: #95a5a6; margin-top: 8px;" onclick="loadExampleData()">
                        ğŸ“‹ ×˜×¢×Ÿ × ×ª×•× ×™ ×“×•×’××”
                    </button>
                </div>

                <div class="results-section" id="resultsSection">
                    <div class="rating-display" id="ratingDisplay"></div>
                    
                    <div class="parameters-section">
                        <h3 style="margin-bottom: 15px; color: #2c3e50;">×¤×™×¨×•×˜ 16 ×¤×¨××˜×¨×™ ×”×“×™×¨×•×’</h3>
                        <div class="parameter-header">
                            <div>×¤×¨××˜×¨</div>
                            <div>××©×§×œ</div>
                            <div>×¢×¨×š ×’×•×œ××™</div>
                            <div>×× ×•×¨××œ</div>
                            <div>××©×•×§×œ×œ</div>
                        </div>
                        <div id="parametersDisplay"></div>
                    </div>

                    <div id="recommendation" class="recommendation"></div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" style="width: auto; margin-left: 10px;" onclick="saveToHistory()">
                            ğŸ’¾ ×©××•×¨ ×œ×”×™×¡×˜×•×¨×™×”
                        </button>
                        <button class="btn" style="width: auto; margin-left: 10px;" onclick="exportToExcel()">
                            ğŸ“„ ×™×¦× ×œ××§×¡×œ
                        </button>
                        <button class="btn" style="width: auto; background: #95a5a6;" onclick="resetForm()">
                            ğŸ”„ ×¢×¡×§×” ×—×“×©×”
                        </button>
                    </div>
                </div>
            </div>

            <!-- ×”×™×¡×˜×•×¨×™×™×ª ×‘×“×™×§×•×ª -->
            <div class="history-section" id="historySection">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">×”×™×¡×˜×•×¨×™×™×ª ×‘×“×™×§×•×ª ××©×¨××™</h3>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <script>
        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        let currentUser = null;
        let transactionsData = [];
        let dbScoreData = [];
        let returnedChecksData = [];
        let warningsData = [];
        let lastRatingResult = null;

        // × ×ª×•× ×™ ××©×ª××©×™× (×‘×¡×‘×™×‘×” ×××™×ª×™×ª ×–×” ×™×”×™×” ×‘×©×¨×ª)
        const users = {
            'admin': 'admin123',
            'manager': 'manager456',
            'analyst': 'analyst789'
        };

        // ×”×ª×—×‘×¨×•×ª
        function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            if (users[username] && users[username] === password) {
                currentUser = username;
                document.getElementById('currentUser').textContent = `××©×ª××©: ${username}`;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                // ×‘×“×™×§×” ×× ×™×© ×”×’×“×¨×•×ª OneDrive ×©××•×¨×•×ª
                if (loadSavedOneDriveConfig()) {
                    loadDataFiles();
                } else {
                    // ×× ××™×Ÿ ×”×’×“×¨×•×ª, ×”×¦×’ ×”×•×“×¢×”
                    setTimeout(() => {
                        alert('×‘×¨×•×š ×”×‘×! ×× × ×”×’×“×¨ ×ª×—×™×œ×” ××ª ×§×™×©×•×¨×™ OneDrive ×¢×œ ×™×“×™ ×œ×—×™×¦×” ×¢×œ "×”×’×“×¨ ×§×™×©×•×¨×™ OneDrive"');
                    }, 1000);
                }
                loadHistoryFromStorage();
            } else {
                errorDiv.textContent = '×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×';
                errorDiv.style.display = 'block';
            }
        }

        // ×”×ª× ×ª×§×•×ª
        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            resetForm();
        }

        // ×”×’×“×¨×•×ª OneDrive - ×™×© ×œ×”×—×œ×™×£ ×‘×§×™×©×•×¨×™× ×”×××™×ª×™×™× ×©×œ×š
        const oneDriveConfig = {
            transactions: 'https://1drv.ms/x/c/YOUR_SHARE_LINK_1/transactions.xlsx?download=1',
            db_scores: 'https://1drv.ms/x/c/YOUR_SHARE_LINK_2/db_scores.xlsx?download=1',
            returned_checks: 'https://1drv.ms/x/c/YOUR_SHARE_LINK_3/returned_checks.xlsx?download=1',
            warnings: 'https://1drv.ms/x/c/YOUR_SHARE_LINK_4/warnings.xlsx?download=1'
        };

        // ×˜×¢×™× ×ª ×§×‘×¦×™ × ×ª×•× ×™× ×-OneDrive - ××©×•×¤×¨ ×œ×˜×™×¤×•×œ ×‘×§×‘×¦×™× ××¨×•×‘×™×
        async function loadDataFiles() {
            updateDataStatus('loading', '×˜×•×¢×Ÿ × ×ª×•× ×™× ×-OneDrive...');
            
            const dataFiles = [
                { url: oneDriveConfig.transactions, type: 'transactions', name: '×’×™×œ×™×•×Ÿ ×¢×¡×§××•×ª' },
                { url: oneDriveConfig.db_scores, type: 'db', name: '× ×ª×•× ×™ D&B' },
                { url: oneDriveConfig.returned_checks, type: 'returned', name: '×©×™×§×™× ×—×•×–×¨×™×' },
                { url: oneDriveConfig.warnings, type: 'warnings', name: '×”×ª×¨×¢×•×ª' }
            ];

            // ×”×•×¡×¤×ª ×§×‘×¦×™× × ×•×¡×¤×™× ×× ×§×™×™××™×
            if (oneDriveConfig.additional && oneDriveConfig.additional.length > 0) {
                oneDriveConfig.additional.forEach((url, index) => {
                    dataFiles.push({
                        url: url,
                        type: 'additional_' + index,
                        name: `×§×•×‘×¥ × ×•×¡×£ ${index + 1}`
                    });
                });
            }

            let loadedFiles = 0;
            let totalFiles = dataFiles.filter(file => file.url).length;

            for (const file of dataFiles) {
                if (!file.url) {
                    updateDataStatus(file.type, 'âš ï¸ ×œ× ×”×•×’×“×¨');
                    continue;
                }

                try {
                    updateDataStatus(file.type, 'â³ ×˜×•×¢×Ÿ...');
                    
                    // ×©×™××•×© ×‘××¡×¤×¨ proxy services ×œ×—×•×¡×Ÿ
                    const proxyUrls = [
                        `https://api.allorigins.win/raw?url=${encodeURIComponent(file.url)}`,
                        `https://cors-anywhere.herokuapp.com/${file.url}`,
                        file.url // × ×™×¡×™×•×Ÿ ×™×©×™×¨ ×›×’×™×‘×•×™
                    ];
                    
                    let success = false;
                    
                    for (const proxyUrl of proxyUrls) {
                        try {
                            const response = await fetch(proxyUrl, {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,*/*'
                                }
                            });
                            
                            if (response.ok) {
                                const arrayBuffer = await response.arrayBuffer();
                                
                                // ×‘×“×™×§×” ×©×”×ª×§×‘×œ ××›×Ÿ ×§×•×‘×¥ Excel
                                if (arrayBuffer.byteLength > 0) {
                                    const workbook = XLSX.read(arrayBuffer, { 
                                        type: 'array',
                                        cellDates: true,
                                        cellStyles: true 
                                    });
                                    
                                    // ×—×™×¤×•×© ×”×’×™×œ×™×•×Ÿ ×”××ª××™×
                                    const sheetName = findBestSheet(workbook, file.type);
                                    const worksheet = workbook.Sheets[sheetName];
                                    const data = XLSX.utils.sheet_to_json(worksheet, { 
                                        header: 1,
                                        defval: '',
                                        blankrows: false 
                                    });
                                    
                                    // ×”××¨×” ×œ×¤×•×¨××˜ ××•×‘×™×™×§×˜×™×
                                    const processedData = convertToObjects(data);
                                    
                                    if (processedData.length > 0) {
                                        processDataFile(processedData, file.type);
                                        updateDataStatus(file.type, `âœ“ × ×˜×¢×Ÿ (${processedData.length} ×¨×©×•××•×ª)`);
                                        loadedFiles++;
                                        success = true;
                                        
                                        console.log(`${file.name} × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”:`, {
                                            rows: processedData.length,
                                            columns: Object.keys(processedData[0] || {}).length,
                                            sheets: workbook.SheetNames
                                        });
                                        break;
                                    }
                                }
                            }
                        } catch (proxyError) {
                            console.warn(`× ×›×©×œ proxy ${proxyUrl}:`, proxyError.message);
                            continue;
                        }
                    }
                    
                    if (!success) {
                        updateDataStatus(file.type, 'âœ— ×©×’×™××ª ×’×™×©×”');
                        console.error(`× ×›×©×œ×” ×˜×¢×™× ×ª ${file.name}`);
                    }
                    
                } catch (error) {
                    console.error(`×©×’×™××” ×‘×˜×¢×™× ×ª ${file.name}:`, error);
                    updateDataStatus(file.type, 'âœ— ×©×’×™××ª ×§×¨×™××”');
                }
                
                // ×”×©×”×™×™×” ×§×˜× ×” ×‘×™×Ÿ ×§×‘×¦×™×
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            // ×¡×™×›×•× ×˜×¢×™× ×”
            if (loadedFiles > 0) {
                console.log(`×¡×™×•× ×˜×¢×™× ×”: ${loadedFiles}/${totalFiles} ×§×‘×¦×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×”`);
                
                // ×”×¦×’×ª ×¡×˜×˜×™×¡×˜×™×§×•×ª
                const stats = {
                    transactions: transactionsData.length,
                    companies: dbScoreData.length,
                    returned: returnedChecksData.length,
                    warnings: warningsData.length
                };
                
                console.log('×¡×˜×˜×™×¡×˜×™×§×•×ª × ×ª×•× ×™×:', stats);
            } else {
                alert('×œ× ×”×¦×œ×™×— ×œ×˜×¢×•×Ÿ ××£ ×§×•×‘×¥. ×× × ×‘×“×•×§ ××ª ×”×§×™×©×•×¨×™× ×•×”×”×¨×©××•×ª.');
            }
        }

        // ×—×™×¤×•×© ×”×’×™×œ×™×•×Ÿ ×”×˜×•×‘ ×‘×™×•×ª×¨ ×œ×¤×™ ×¡×•×’ ×”× ×ª×•× ×™×
        function findBestSheet(workbook, dataType) {
            const sheetNames = workbook.SheetNames;
            
            // ××™×œ×•×ª ××¤×ª×— ×œ×›×œ ×¡×•×’ × ×ª×•× ×™×
            const keywords = {
                'transactions': ['×¢×¡×§', 'transaction', 'deals', '× ×ª×•× ×™×', '×›×œ'],
                'db': ['×—×™×ª×•×', '××©×¨××™', 'score', '×“×™×¨×•×’', 'db'],
                'returned': ['×—×•×–×¨', 'returned', 'bounce', '×©×™×§'],
                'warnings': ['×”×ª×¨×¢', 'warning', 'alert', 'sigma']
            };
            
            const relevantKeywords = keywords[dataType] || [];
            
            // ×—×™×¤×•×© ×’×™×œ×™×•×Ÿ ×¢× ×©× ×¨×œ×•×•× ×˜×™
            for (const keyword of relevantKeywords) {
                const matchingSheet = sheetNames.find(name => 
                    name.toLowerCase().includes(keyword.toLowerCase())
                );
                if (matchingSheet) {
                    return matchingSheet;
                }
            }
            
            // ×× ×œ× × ××¦×, ×”×—×–×¨ ××ª ×”×’×™×œ×™×•×Ÿ ×”×¨××©×•×Ÿ
            return sheetNames[0];
        }

        // ×”××¨×ª × ×ª×•× ×™ ××¢×¨×š ×œ××•×‘×™×™×§×˜×™× ×¢× ×›×•×ª×¨×•×ª
        function convertToObjects(data) {
            if (!data || data.length < 2) return [];
            
            const headers = data[0];
            const rows = data.slice(1);
            
            return rows.map(row => {
                const obj = {};
                headers.forEach((header, index) => {
                    if (header && header.toString().trim()) {
                        obj[header.toString().trim()] = row[index] || '';
                    }
                });
                return obj;
            }).filter(obj => Object.keys(obj).length > 0);
        }

        // ×¤×•× ×§×¦×™×” ×œ×”×’×“×¨×ª ×§×™×©×•×¨×™ OneDrive - ××•×¨×—×‘×ª ×œ×ª××™×›×” ×‘××‘× ×” ××•×¨×›×‘
        function configureOneDriveLinks() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.8); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto;">
                    <h2 style="margin-bottom: 20px; text-align: center;">×”×’×“×¨×ª ×§×™×©×•×¨×™ OneDrive</h2>
                    <p style="margin-bottom: 20px; color: #666; text-align: center;">
                        ×”×–×Ÿ ××ª ×§×™×©×•×¨×™ ×”×©×™×ª×•×£ ×©×œ ×”×§×‘×¦×™× ×-OneDrive ×©×œ×š<br>
                        <small>×ª×•××š ×‘×§×‘×¦×™× ×‘×ª×™×§×™×•×ª ×•×ª×ª×™-×ª×™×§×™×•×ª</small>
                    </p>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ğŸ“Š ×’×™×œ×™×•×Ÿ ×¢×¡×§××•×ª (transactions/deals):</label>
                        <input type="text" id="linkTransactions" placeholder="×”×–×Ÿ ×§×™×©×•×¨ ×œ×§×•×‘×¥ ×”×¢×¡×§××•×ª..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        <small style="color: #888;">×œ×“×•×’××”: ×›×œ×”× ×ª×•× ×™×6.11.22.xlsx ××• ×§×•×‘×¥ ××—×¨ ×¢× × ×ª×•× ×™ ×¢×¡×§××•×ª</small>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ğŸ¢ × ×ª×•× ×™ D&B ×•×—×™×ª×•× ××©×¨××™:</label>
                        <input type="text" id="linkDB" placeholder="×”×–×Ÿ ×§×™×©×•×¨ ×œ×§×•×‘×¥ ×”×“×™×¨×•×’×™×..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        <small style="color: #888;">×œ×“×•×’××”: ×—×™×ª×•× ××©×¨××™.xlsx ××• ×§×•×‘×¥ ×¢× ×“×™×¨×•×’×™ D&B</small>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ğŸ’° ×©×™×§×™× ×—×•×–×¨×™×:</label>
                        <input type="text" id="linkReturned" placeholder="×”×–×Ÿ ×§×™×©×•×¨ ×œ×§×•×‘×¥ ×”×©×™×§×™× ×”×—×•×–×¨×™×..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        <small style="color: #888;">×§×•×‘×¥ ×¢× × ×ª×•× ×™ ×©×™×§×™× ×©×—×–×¨×• ××”×‘× ×§</small>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">âš ï¸ ×”×ª×¨×¢×•×ª ×•-Sigma:</label>
                        <input type="text" id="linkWarnings" placeholder="×”×–×Ÿ ×§×™×©×•×¨ ×œ×§×•×‘×¥ ×”×”×ª×¨×¢×•×ª..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        <small style="color: #888;">×§×•×‘×¥ ×¢× ×”×ª×¨×¢×•×ª, sigma ××• × ×ª×•× ×™ ×¡×™×›×•× ×™×</small>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ğŸ”„ ××§×•×¨×•×ª × ×ª×•× ×™× × ×•×¡×¤×™× (××•×¤×¦×™×•× ×œ×™):</label>
                        <textarea id="additionalSources" placeholder="×”×–×Ÿ ×§×™×©×•×¨×™× × ×•×¡×¤×™× ×œ×§×‘×¦×™× ×¨×œ×•×•× ×˜×™×™×, ×›×œ ×§×™×©×•×¨ ×‘×©×•×¨×” × ×¤×¨×“×ª..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; height: 80px; resize: vertical;"></textarea>
                        <small style="color: #888;">×§×‘×¦×™× × ×•×¡×¤×™× ×©×¢×©×•×™×™× ×œ×”×›×™×œ × ×ª×•× ×™× ×¨×œ×•×•× ×˜×™×™×</small>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <button onclick="saveOneDriveLinks()" style="background: #0078d4; color: white; padding: 12px 25px; border: none; border-radius: 8px; margin-left: 10px; cursor: pointer; font-size: 16px;">ğŸ’¾ ×©××•×¨ ×”×’×“×¨×•×ª</button>
                        <button onclick="testOneDriveConnection()" style="background: #28a745; color: white; padding: 12px 25px; border: none; border-radius: 8px; margin-left: 10px; cursor: pointer; font-size: 16px;">ğŸ” ×‘×“×•×§ ×—×™×‘×•×¨</button>
                        <button onclick="closeModal()" style="background: #666; color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">âŒ ×‘×™×˜×•×œ</button>
                    </div>
                    
                    <div style="background: #f0f8ff; border: 1px solid #b3d9ff; border-radius: 8px; padding: 15px; margin-top: 20px;">
                        <h4 style="margin-bottom: 10px; color: #0066cc;">ğŸ“‹ ×”×•×¨××•×ª ×©×œ×‘-××—×¨-×©×œ×‘:</h4>
                        <ol style="margin: 0; padding-right: 20px; line-height: 1.6;">
                            <li><strong>×¤×ª×— ××ª ×”×§×•×‘×¥ ×‘-OneDrive</strong> (×œ×—×¥ ×¢×œ×™×•)</li>
                            <li><strong>×œ×—×¥ ×¢×œ "×©×ª×£"</strong> ×‘×¡×¨×’×œ ×”×¢×œ×™×•×Ÿ</li>
                            <li><strong>×‘×—×¨ "×›×œ ××™ ×©×™×© ×œ×• ××ª ×”×§×™×©×•×¨ ×™×›×•×œ ×œ×¦×¤×•×ª"</strong></li>
                            <li><strong>×œ×—×¥ "×”×¢×ª×§ ×§×™×©×•×¨"</strong></li>
                            <li><strong>×”×“×‘×§ ×›××Ÿ ×‘×©×“×” ×”××ª××™×</strong></li>
                        </ol>
                        
                        <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
                            <strong>ğŸ’¡ ×˜×™×¤:</strong> ×× ×”×§×•×‘×¥ × ××¦× ×‘×ª×™×§×™×™×”, ×¤×ª×— ××•×ª×• ×™×©×™×¨×•×ª ×•×œ× ××ª ×”×ª×™×§×™×™×”
                        </div>
                        
                        <div style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 5px;">
                            <strong>ğŸ”§ ×œ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª:</strong> ×× ×”×§×™×©×•×¨ ×œ× ×¢×•×‘×“, × ×¡×” ×œ×”×•×¨×™×“ ××ª ×”×§×•×‘×¥ ×•×œ×”×¢×œ×•×ª ××•×ª×• ×©×•×‘ ×œ×ª×™×§×™×™×” ×”×¨××©×™×ª
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ×˜×¢×™× ×ª ×§×™×©×•×¨×™× ×©××•×¨×™×
            const savedLinks = JSON.parse(localStorage.getItem('oneDriveLinks') || '{}');
            if (savedLinks.transactions) document.getElementById('linkTransactions').value = savedLinks.transactions;
            if (savedLinks.db_scores) document.getElementById('linkDB').value = savedLinks.db_scores;
            if (savedLinks.returned_checks) document.getElementById('linkReturned').value = savedLinks.returned_checks;
            if (savedLinks.warnings) document.getElementById('linkWarnings').value = savedLinks.warnings;
            if (savedLinks.additional) document.getElementById('additionalSources').value = savedLinks.additional.join('\n');
            
            window.saveOneDriveLinks = function() {
                const links = {
                    transactions: document.getElementById('linkTransactions').value.trim(),
                    db_scores: document.getElementById('linkDB').value.trim(),
                    returned_checks: document.getElementById('linkReturned').value.trim(),
                    warnings: document.getElementById('linkWarnings').value.trim(),
                    additional: document.getElementById('additionalSources').value.split('\n').filter(link => link.trim())
                };
                
                // ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×”×§×™×©×•×¨×™×
                let hasValidLinks = false;
                Object.keys(links).forEach(key => {
                    if (key !== 'additional' && links[key]) {
                        if (isValidOneDriveLink(links[key])) {
                            links[key] = convertToDirectDownload(links[key]);
                            hasValidLinks = true;
                        } else {
                            alert(`×”×§×™×©×•×¨ ×¢×‘×•×¨ ${getFieldName(key)} ××™× ×• ×ª×§×™×Ÿ. ×× × ×‘×“×•×§ ×©×–×” ×§×™×©×•×¨ OneDrive ×ª×§×™×Ÿ.`);
                            return;
                        }
                    }
                });
                
                if (!hasValidLinks) {
                    alert('× ×“×¨×© ×œ×¤×—×•×ª ×§×™×©×•×¨ ××—×“ ×ª×§×™×Ÿ ×œ×¤× ×™ ×”×©××™×¨×”');
                    return;
                }
                
                // ×”××¨×ª ×§×™×©×•×¨×™× × ×•×¡×¤×™×
                if (links.additional) {
                    links.additional = links.additional.map(link => {
                        if (isValidOneDriveLink(link)) {
                            return convertToDirectDownload(link);
                        }
                        return null;
                    }).filter(link => link);
                }
                
                localStorage.setItem('oneDriveLinks', JSON.stringify(links));
                Object.assign(oneDriveConfig, links);
                
                document.body.removeChild(modal);
                alert('×§×™×©×•×¨×™ OneDrive × ×©××¨×• ×‘×”×¦×œ×—×”! ×˜×•×¢×Ÿ × ×ª×•× ×™×...');
                loadDataFiles();
            };
            
            window.testOneDriveConnection = async function() {
                const transactionsLink = document.getElementById('linkTransactions').value.trim();
                
                if (!transactionsLink) {
                    alert('×”×–×Ÿ ×§×™×©×•×¨ ×œ×’×™×œ×™×•×Ÿ ×”×¢×¡×§××•×ª ×œ×‘×“×™×§×”');
                    return;
                }
                
                if (!isValidOneDriveLink(transactionsLink)) {
                    alert('×”×§×™×©×•×¨ ×œ× × ×¨××” ×›××• ×§×™×©×•×¨ OneDrive ×ª×§×™×Ÿ');
                    return;
                }
                
                try {
                    updateDataStatus('transactions', 'ğŸ” ×‘×•×“×§ ×—×™×‘×•×¨...');
                    const directLink = convertToDirectDownload(transactionsLink);
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(directLink)}`;
                    
                    const response = await fetch(proxyUrl);
                    
                    if (response.ok) {
                        const arrayBuffer = await response.arrayBuffer();
                        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const data = XLSX.utils.sheet_to_json(firstSheet);
                        
                        alert(`âœ… ×”×—×™×‘×•×¨ ×ª×§×™×Ÿ!\n\n× ××¦××• ${data.length} ×¨×©×•××•×ª\n×’×™×œ×™×•× ×•×ª: ${workbook.SheetNames.join(', ')}\n×¢××•×“×•×ª: ${Object.keys(data[0] || {}).join(', ')}`);
                        updateDataStatus('transactions', `âœ“ ×—×™×‘×•×¨ ×ª×§×™×Ÿ (${data.length} ×¨×©×•××•×ª)`);
                    } else {
                        alert('âŒ ×©×’×™××” ×‘×—×™×‘×•×¨. ×‘×“×•×§ ××ª ×”×§×™×©×•×¨ ×•×”×”×¨×©××•×ª');
                        updateDataStatus('transactions', 'âœ— ×©×’×™××ª ×—×™×‘×•×¨');
                    }
                } catch (error) {
                    alert('âŒ ×©×’×™××” ×‘×¨×©×ª ××• ×‘×§×™×©×•×¨: ' + error.message);
                    updateDataStatus('transactions', 'âœ— ×©×’×™××”');
                }
            };
            
            window.closeModal = function() {
                document.body.removeChild(modal);
            };
        }
        
        // ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×§×™×©×•×¨ OneDrive
        function isValidOneDriveLink(link) {
            return link && (
                link.includes('1drv.ms') || 
                link.includes('onedrive.live.com') || 
                link.includes('sharepoint.com') ||
                link.includes('office.com')
            );
        }
        
        // ×”××¨×ª ×©××•×ª ×©×“×•×ª ×œ×¢×‘×¨×™×ª
        function getFieldName(key) {
            const names = {
                'transactions': '×’×™×œ×™×•×Ÿ ×¢×¡×§××•×ª',
                'db_scores': '× ×ª×•× ×™ D&B',
                'returned_checks': '×©×™×§×™× ×—×•×–×¨×™×',
                'warnings': '×”×ª×¨×¢×•×ª'
            };
            return names[key] || key;
        }

        // ×”××¨×ª ×§×™×©×•×¨ OneDrive ×œ×§×™×©×•×¨ ×”×•×¨×“×” ×™×©×™×¨×”
        function convertToDirectDownload(shareLink) {
            if (shareLink.includes('1drv.ms')) {
                // ×”××¨×” ××§×™×©×•×¨ ×§×¦×¨ ×œ×§×™×©×•×¨ ×”×•×¨×“×”
                return shareLink.replace(/\?.*$/, '?download=1');
            } else if (shareLink.includes('onedrive.live.com')) {
                // ×”××¨×” ××§×™×©×•×¨ ×¨×’×™×œ ×œ×§×™×©×•×¨ ×”×•×¨×“×”
                return shareLink.replace('view.aspx', 'download.aspx');
            }
            return shareLink;
        }

        // ×˜×¢×™× ×ª ×”×’×“×¨×•×ª OneDrive ×©××•×¨×•×ª
        function loadSavedOneDriveConfig() {
            const savedLinks = JSON.parse(localStorage.getItem('oneDriveLinks') || '{}');
            if (Object.keys(savedLinks).length > 0) {
                Object.assign(oneDriveConfig, savedLinks);
                return true;
            }
            return false;
        }

        function updateDataStatus(type, status) {
            const statusElements = {
                'transactions': 'transactionsStatus',
                'db': 'dbStatus',
                'returned': 'returnedStatus',
                'warnings': 'warningsStatus'
            };
            
            const element = document.getElementById(statusElements[type]);
            if (element) {
                element.textContent = status;
                element.className = status.includes('âœ“') ? 'status-loaded' : 'status-missing';
            }
        }

        function processDataFile(data, type) {
            switch (type) {
                case 'transactions':
                    processTransactionsData(data);
                    break;
                case 'db':
                    processDBData(data);
                    break;
                case 'returned':
                    processReturnedChecksData(data);
                    break;
                case 'warnings':
                    processWarningsData(data);
                    break;
            }
        }

        // ×¢×™×‘×•×“ × ×ª×•× ×™ ×¢×¡×§××•×ª - ××©×•×¤×¨ ×œ×–×™×”×•×™ ××•×˜×•××˜×™ ×©×œ ×¢××•×“×•×ª
        function processTransactionsData(data) {
            const payersMap = new Map();

            // ×–×™×”×•×™ ××•×˜×•××˜×™ ×©×œ ×¢××•×“×•×ª
            const columnMapping = detectColumns(data[0] || {}, {
                payerID: ['××¡×¤×¨ ×–×”×•×ª ××•×©×š', '××¡ ×–×”×•×ª ××•×©×š', '××¡\' ×–×”×•×ª ××•×©×š', '×ª.×– ××•×©×š', '×—.×¤ ××•×©×š', 'payerID', 'payer_id'],
                payerName: ['×©× ××•×©×š', '×©×_××•×©×š', '××•×©×š', 'payerName', 'payer_name'],
                customerID: ['××¡×¤×¨ ×–×”×•×ª ×œ×§×•×—', '××¡ ×–×”×•×ª ×œ×§×•×—', '×ª.×– ×œ×§×•×—', '×—.×¤ ×œ×§×•×—', '×.×–×”×•×ª', 'customerID'],
                customerName: ['×©× ×œ×§×•×—', '×©×_×œ×§×•×—', '×œ×§×•×—', 'customerName', 'customer_name'],
                amount: ['×¡×›×•×', '×¡×›×•× ×¢×¡×§×”', '×¡×›×•× ×”×©×™×§', 'amount', 'sum'],
                creditDays: ['×™××™ ××©×¨××™', '×™××™_××©×¨××™', '××©×¨××™', 'creditDays', 'credit_days'],
                date: ['×ª××¨×™×š', '×ª××¨×™×š ×¢×¡×§×”', '×ª××¨×™×š ×”×©×™×§', 'date', 'transaction_date']
            });

            console.log('×–×•×”×• ×¢××•×“×•×ª:', columnMapping);

            data.forEach(row => {
                const payerID = getValueFromRow(row, columnMapping.payerID);
                const payerName = getValueFromRow(row, columnMapping.payerName);
                const amount = parseFloat(getValueFromRow(row, columnMapping.amount)) || 0;
                const creditDays = parseInt(getValueFromRow(row, columnMapping.creditDays)) || 30;

                if (payerID && payerID.toString().trim()) {
                    const id = payerID.toString().trim();
                    
                    if (!payersMap.has(id)) {
                        payersMap.set(id, {
                            payerID: id,
                            payerName: payerName || '',
                            transactions: 0,
                            totalAmount: 0,
                            averageAmount: 0,
                            creditDays: 0,
                            totalCreditDays: 0
                        });
                    }

                    const payer = payersMap.get(id);
                    payer.transactions++;
                    payer.totalAmount += amount;
                    payer.totalCreditDays += creditDays;
                    payer.averageAmount = payer.totalAmount / payer.transactions;
                    payer.creditDays = payer.totalCreditDays / payer.transactions;
                }
            });

            transactionsData = Array.from(payersMap.values());
            console.log(`×¢×•×‘×“×• ${transactionsData.length} ××•×©×›×™× ××ª×•×š ${data.length} ×¢×¡×§××•×ª`);
        }

        // ×¢×™×‘×•×“ × ×ª×•× ×™ D&B - ××©×•×¤×¨
        function processDBData(data) {
            const columnMapping = detectColumns(data[0] || {}, {
                companyID: ['××¡\' ×—.×¤', '××¡×¤×¨ ×—.×¤', '×—.×¤', '××¡×¤×¨ ×—×‘×¨×”', 'companyID', 'company_id'],
                dbScore: ['×¡×§×•×¨', '×“×™×¨×•×’', '×¦×™×•×Ÿ', 'score', 'rating'],
                sectorScore: ['×¡×§×•×¨ ×¢× ×£', '×“×™×¨×•×’ ×¢× ×£', '×¢× ×£', 'sectorScore', 'sector_score'],
                age: ['×©× ×•×ª ×•×ª×§', '×•×ª×§', '×’×™×œ ×—×‘×¨×”', 'age', 'years'],
                employees: ['××¡\' ××•×¢×¡×§×™×', '×¢×•×‘×“×™×', '××•×¢×¡×§×™×', 'employees', 'workers'],
                turnover: ['××—×–×•×¨ ×‘×\' â‚ª', '××—×–×•×¨', '×”×›× ×¡×•×ª', 'turnover', 'revenue']
            });

            dbScoreData = data.map(row => ({
                companyID: getValueFromRow(row, columnMapping.companyID),
                dbScore: parseFloat(getValueFromRow(row, columnMapping.dbScore)) || 30,
                sectorScore: parseFloat(getValueFromRow(row, columnMapping.sectorScore)) || 45,
                age: parseInt(getValueFromRow(row, columnMapping.age)) || 5,
                employees: parseInt(getValueFromRow(row, columnMapping.employees)) || 10,
                turnover: parseFloat(getValueFromRow(row, columnMapping.turnover)) || 2
            })).filter(item => item.companyID);

            console.log(`×¢×•×‘×“×• ${dbScoreData.length} ×—×‘×¨×•×ª ×‘× ×ª×•× ×™ D&B`);
        }

        // ×¢×™×‘×•×“ × ×ª×•× ×™ ×©×™×§×™× ×—×•×–×¨×™× - ××©×•×¤×¨
        function processReturnedChecksData(data) {
            const columnMapping = detectColumns(data[0] || {}, {
                payerID: ['××¡×¤×¨ ×–×”×•×ª', '×—.×¤', '×ª.×–', '××–×”×•×ª', 'payerID', 'payer_id'],
                returnedCount: ['×—×–×¨×•×ª', '×©×™×§×™× ×—×•×–×¨×™×', '××¡×¤×¨ ×—×–×¨×•×ª', 'returned', 'bounced']
            });

            returnedChecksData = data.map(row => ({
                payerID: getValueFromRow(row, columnMapping.payerID),
                returnedCount: parseInt(getValueFromRow(row, columnMapping.returnedCount)) || 0
            })).filter(item => item.payerID);

            console.log(`×¢×•×‘×“×• ${returnedChecksData.length} ×¨×©×•××•×ª ×©×™×§×™× ×—×•×–×¨×™×`);
        }

        // ×¢×™×‘×•×“ × ×ª×•× ×™ ×”×ª×¨×¢×•×ª - ××©×•×¤×¨
        function processWarningsData(data) {
            const columnMapping = detectColumns(data[0] || {}, {
                companyID: ['××¡×¤×¨ ×—×‘×¨×”', '×—.×¤', '××–×”×•×ª', 'companyID', 'company_id'],
                warningsCount: ['×”×ª×¨×¢×•×ª', '××¡×¤×¨ ×”×ª×¨×¢×•×ª', '××–×”×¨×•×ª', 'warnings', 'alerts']
            });

            warningsData = data.map(row => ({
                companyID: getValueFromRow(row, columnMapping.companyID),
                warningsCount: parseInt(getValueFromRow(row, columnMapping.warningsCount)) || 0
            })).filter(item => item.companyID);

            console.log(`×¢×•×‘×“×• ${warningsData.length} ×¨×©×•××•×ª ×”×ª×¨×¢×•×ª`);
        }

        // ×–×™×”×•×™ ××•×˜×•××˜×™ ×©×œ ×¢××•×“×•×ª
        function detectColumns(sampleRow, mapping) {
            const result = {};
            const availableColumns = Object.keys(sampleRow);
            
            Object.keys(mapping).forEach(field => {
                const possibleNames = mapping[field];
                
                // ×—×™×¤×•×© ×”×ª×××” ××“×•×™×§×ª
                let foundColumn = availableColumns.find(col => 
                    possibleNames.some(name => 
                        col.toLowerCase().trim() === name.toLowerCase().trim()
                    )
                );
                
                // ×× ×œ× × ××¦×, ×—×™×¤×•×© ×”×ª×××” ×—×œ×§×™×ª
                if (!foundColumn) {
                    foundColumn = availableColumns.find(col => 
                        possibleNames.some(name => 
                            col.toLowerCase().includes(name.toLowerCase()) ||
                            name.toLowerCase().includes(col.toLowerCase())
                        )
                    );
                }
                
                result[field] = foundColumn;
            });
            
            return result;
        }

        // ×§×‘×œ×ª ×¢×¨×š ××”×©×•×¨×” ×œ×¤×™ ×©× ×”×¢××•×“×”
        function getValueFromRow(row, columnName) {
            if (!columnName || !row) return '';
            
            const value = row[columnName];
            if (value === null || value === undefined) return '';
            
            return value.toString().trim();
        }

        // ×¢×™×‘×•×“ ×§×‘×¦×™× × ×•×¡×¤×™× ×× × ××¦××•
        function processAdditionalFile(data, fileIndex) {
            console.log(`×¢×™×‘×•×“ ×§×•×‘×¥ × ×•×¡×£ ${fileIndex + 1}:`, {
                rows: data.length,
                columns: Object.keys(data[0] || {})
            });
            
            // × ×™×¡×™×•×Ÿ ×œ×–×”×•×ª ××ª ×¡×•×’ ×”×§×•×‘×¥ ×œ×¤×™ ×”×¢××•×“×•×ª
            const columns = Object.keys(data[0] || {}).join(' ').toLowerCase();
            
            if (columns.includes('××•×©×š') || columns.includes('×¢×¡×§')) {
                console.log('×–×•×”×” ×›×§×•×‘×¥ ×¢×¡×§××•×ª × ×•×¡×£');
                processTransactionsData(data);
            } else if (columns.includes('×¡×§×•×¨') || columns.includes('×“×™×¨×•×’')) {
                console.log('×–×•×”×” ×›×§×•×‘×¥ ×“×™×¨×•×’×™× × ×•×¡×£');
                processDBData(data);
            } else if (columns.includes('×—×–×¨') || columns.includes('×©×™×§')) {
                console.log('×–×•×”×” ×›×§×•×‘×¥ ×©×™×§×™× ×—×•×–×¨×™× × ×•×¡×£');
                processReturnedChecksData(data);
            } else if (columns.includes('×”×ª×¨×¢') || columns.includes('×¡×™×’××”')) {
                console.log('×–×•×”×” ×›×§×•×‘×¥ ×”×ª×¨×¢×•×ª × ×•×¡×£');
                processWarningsData(data);
            } else {
                console.log('×œ× ×–×•×”×” ×¡×•×’ ×”×§×•×‘×¥, ××ª×¢×œ×');
            }
        }

        // ×˜×¢×™× ×ª × ×ª×•× ×™ ×“×•×’××”
        function loadExampleData() {
            document.getElementById('customerName').value = '×“×•×“ ×™×©×¨××œ×™';
            document.getElementById('customerID').value = '514031970';
            document.getElementById('payerName').value = '×—×‘×¨×ª ×”×‘× ×™×™×” ×”×’×“×•×œ×” ×‘×¢"×';
            document.getElementById('payerID').value = '513456789';
            document.getElementById('checkAmount').value = '85000';
            document.getElementById('checkDate').value = '2024-09-15';
            document.getElementById('creditDays').value = '45';
            document.getElementById('commission').value = '2.5';

            // × ×ª×•× ×™ ×“×•×’××”
            transactionsData = [
                { payerID: '513456789', payerName: '×—×‘×¨×ª ×”×‘× ×™×™×” ×”×’×“×•×œ×” ×‘×¢"×', transactions: 12, totalAmount: 850000, averageAmount: 70833, creditDays: 38 },
                { payerID: '305346900', payerName: '××™×‘×¨×”×™× ×¨××‘×™', transactions: 3, totalAmount: 180000, averageAmount: 60000, creditDays: 42 }
            ];

            dbScoreData = [
                { companyID: '513456789', dbScore: 72, sectorScore: 65, age: 15, employees: 85, turnover: 45 },
                { companyID: '305346900', dbScore: 45, sectorScore: 55, age: 8, employees: 12, turnover: 5.2 }
            ];

            returnedChecksData = [
                { payerID: '513456789', returnedCount: 1 },
                { payerID: '305346900', returnedCount: 0 }
            ];

            warningsData = [
                { companyID: '513456789', warningsCount: 2 },
                { companyID: '305346900', warningsCount: 0 }
            ];

            updateDataStatus('transactions', 'âœ“ × ×ª×•× ×™ ×“×•×’××” (2 ×¨×©×•××•×ª)');
            updateDataStatus('db', 'âœ“ × ×ª×•× ×™ ×“×•×’××” (2 ×¨×©×•××•×ª)');
            updateDataStatus('returned', 'âœ“ × ×ª×•× ×™ ×“×•×’××” (2 ×¨×©×•××•×ª)');
            updateDataStatus('warnings', 'âœ“ × ×ª×•× ×™ ×“×•×’××” (2 ×¨×©×•××•×ª)');

            alert('× ×ª×•× ×™ ×“×•×’××” × ×˜×¢× ×• ×‘×”×¦×œ×—×”!');
        }

        // ×—×™×©×•×‘ ×“×™×¨×•×’ ×”××©×¨××™
        function calculateCreditRating() {
            const payerID = document.getElementById('payerID').value;
            const checkAmount = parseFloat(document.getElementById('checkAmount').value) || 0;
            const creditDays = parseInt(document.getElementById('creditDays').value) || 0;

            if (!payerID || !checkAmount) {
                alert('×× × ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™×');
                return;
            }

            // ×—×™×¤×•×© × ×ª×•× ×™ ×”××•×©×š
            const payerData = findPayerData(payerID);
            const dbData = findDBData(payerID);
            const returnedCount = findReturnedChecksData(payerID);
            const warningsCount = findWarningsData(payerID);

            // ×—×™×©×•×‘ ×›×œ ×¤×¨××˜×¨ ×œ×¤×™ ×”× ×•×¡×—××•×ª ×”××§×•×¨×™×•×ª
            const parameters = calculateAllParameters(payerData, dbData, returnedCount, warningsCount, checkAmount, creditDays);
            
            // ×—×™×©×•×‘ ×”×¦×™×•×Ÿ ×”×›×•×œ×œ
            const totalScore = calculateTotalScore(parameters);
            
            // ×§×‘×™×¢×ª ×“×™×¨×•×’ ×”××•×ª×™×•×ª
            const letterRating = getLetterRating(totalScore);
            
            // ×©××™×¨×ª ×”×ª×•×¦××”
            lastRatingResult = {
                payerName: document.getElementById('payerName').value,
                payerID: payerID,
                checkAmount: checkAmount,
                totalScore: totalScore,
                letterRating: letterRating,
                parameters: parameters,
                date: new Date().toLocaleString('he-IL')
            };
            
            // ×”×¦×’×ª ×”×ª×•×¦××•×ª
            displayResults(parameters, totalScore, letterRating, payerData, dbData);
            
            document.getElementById('resultsSection').style.display = 'block';
        }

        function findPayerData(payerID) {
            return transactionsData.find(p => p.payerID === payerID) || {
                payerID: payerID,
                transactions: 0,
                totalAmount: 0,
                averageAmount: 0,
                creditDays: 0
            };
        }

        function findDBData(payerID) {
            return dbScoreData.find(d => d.companyID === payerID) || {
                companyID: payerID,
                dbScore: 30,
                sectorScore: 45,
                age: 5,
                employees: 10,
                turnover: 2
            };
        }

        function findReturnedChecksData(payerID) {
            const data = returnedChecksData.find(r => r.payerID === payerID);
            return data ? data.returnedCount : 0;
        }

        function findWarningsData(payerID) {
            const data = warningsData.find(w => w.companyID === payerID);
            return data ? data.warningsCount : 0;
        }

        function calculateAllParameters(payerData, dbData, returnedCount, warningsCount, checkAmount, creditDays) {
            const parameters = [];

            // 1. ××¡×¤×¨ ×¢×¡×§××•×ª ×§×•×“××•×ª
            const transactionsRaw = payerData.transactions || 0;
            let transactionsNormalized;
            if (transactionsRaw === 0) transactionsNormalized = 1;
            else if (transactionsRaw >= 100) transactionsNormalized = 1;
            else if (transactionsRaw >= 50) transactionsNormalized = 0.8;
            else if (transactionsRaw >= 20) transactionsNormalized = 0.6;
            else if (transactionsRaw >= 10) transactionsNormalized = 0.4;
            else if (transactionsRaw >= 5) transactionsNormalized = 0.2;
            else transactionsNormalized = 0.1;
            
            parameters.push({
                name: '××¡×¤×¨ ×¢×¡×§××•×ª ×§×•×“××•×ª',
                weight: 0.15,
                rawValue: transactionsRaw,
                normalized: transactionsNormalized,
                weighted: transactionsNormalized * 0.15
            });

            // 2. ××¡×¤×¨ ×—×–×¨×•×ª ×©×™×§×™×
            const returnedRaw = returnedCount || 0;
            const returnedNormalized = returnedRaw === 0 ? 1 : Math.max(0, 1 - returnedRaw * 0.2);
            
            parameters.push({
                name: '××¡×¤×¨ ×—×–×¨×•×ª ×©×™×§×™×',
                weight: 0.05,
                rawValue: returnedRaw,
                normalized: returnedNormalized,
                weighted: returnedNormalized * 0.05
            });

            // 3. ×—×¨×™×’×” ××××•×¦×¢ ×™××™ ××©×¨××™
            const avgCreditDays = payerData.creditDays || 30;
            const creditDaysDeviation = creditDays - avgCreditDays;
            let creditDaysNormalized;
            if (creditDaysDeviation <= 0) {
                creditDaysNormalized = Math.min(1, 1 - (Math.abs(creditDaysDeviation) / 60));
            } else {
                creditDaysNormalized = Math.max(0, 1 - (creditDaysDeviation / 60));
            }
            
            parameters.push({
                name: '×—×¨×™×’×” ××××•×¦×¢ ×™××™ ××©×¨××™',
                weight: 0.10,
                rawValue: creditDaysDeviation,
                normalized: creditDaysNormalized,
                weighted: creditDaysNormalized * 0.10
            });

            // 4. ×“×™×¨×•×’ D&B
            const dbScoreRaw = dbData.dbScore || 30;
            const dbScoreNormalized = dbScoreRaw >= 30 ? dbScoreRaw / 100 : Math.max(0, (dbScoreRaw / 100) - 0.3);
            
            parameters.push({
                name: '×“×™×¨×•×’ D&B',
                weight: 0.08,
                rawValue: dbScoreRaw,
                normalized: dbScoreNormalized,
                weighted: dbScoreNormalized * 0.08
            });

            // 5. ×“×™×¨×•×’ ×¢× ×£
            const sectorScoreRaw = dbData.sectorScore || 32;
            const sectorScoreNormalized = sectorScoreRaw >= 32 ? sectorScoreRaw / 100 : Math.max(0, (sectorScoreRaw / 100) - 0.3);
            
            parameters.push({
                name: '×“×™×¨×•×’ ×¢× ×£',
                weight: 0.05,
                rawValue: sectorScoreRaw,
                normalized: sectorScoreNormalized,
                weighted: sectorScoreNormalized * 0.05
            });

            // 6. ××¡×•×›× ×ª ××”×¢× ×£ ×©×œ×”
            const riskierThanSector = dbScoreRaw < sectorScoreRaw;
            const riskNormalized = riskierThanSector ? Math.max(-0.2, (dbScoreRaw - sectorScoreRaw) / 500) : 0;
            
            parameters.push({
                name: '××¡×•×›× ×ª ××”×¢× ×£',
                weight: 0.08,
                rawValue: riskierThanSector ? '×›×Ÿ' : '×œ×',
                normalized: riskNormalized,
                weighted: riskNormalized * 0.08
            });

            // 7. ×’×™×œ ×”×—×‘×¨×” ×‘×©× ×™×
            const companyAgeRaw = dbData.age || 5;
            let ageNormalized;
            if (companyAgeRaw >= 30) ageNormalized = 1;
            else if (companyAgeRaw >= 20) ageNormalized = 0.8;
            else if (companyAgeRaw >= 10) ageNormalized = 0.6;
            else if (companyAgeRaw >= 5) ageNormalized = 0.4;
            else if (companyAgeRaw >= 3) ageNormalized = 0.2;
            else ageNormalized = 0.1;
            
            parameters.push({
                name: '×’×™×œ ×”×—×‘×¨×”',
                weight: 0.13,
                rawValue: companyAgeRaw,
                normalized: ageNormalized,
                weighted: ageNormalized * 0.13
            });

            // 8-16. ×©××¨ ×”×¤×¨××˜×¨×™×
            const otherParams = [
                { name: '××—×–×•×¨ ×©× ×ª×™', weight: 0.03, raw: dbData.turnover || 2, normalized: Math.min((dbData.turnover || 2) / 50, 1) },
                { name: '××“×“ ×¡×•×¦×™×•××§×•× ×•××™', weight: 0.03, raw: 6, normalized: 0.6 },
                { name: '××¡×¤×¨ ×”×ª×¨×¢×•×ª', weight: 0.08, raw: warningsCount, normalized: Math.max(0, 1 - warningsCount * 0.2) },
                { name: '×”××œ×¦×”', weight: 0.05, raw: '×›×Ÿ', normalized: 1 },
                { name: '×××™×¤×” ×”×‘×¢×œ×™×', weight: 0.03, raw: 5, normalized: 0.5 },
                { name: '×“×™×¨×•×’ ×”×¡× ×™×£', weight: 0.01, raw: 7, normalized: 0.7 },
                { name: '×¢×¡×§×” ×××•×¦×¢×ª ×œ××•×©×š', weight: 0.10, raw: checkAmount / (payerData.averageAmount || 50000), normalized: checkAmount <= (payerData.averageAmount || 50000) ? 1 : Math.max(0, 1 - (checkAmount / (payerData.averageAmount || 50000) - 1) * 0.5) },
                { name: '××™×§×•× ×–×”×”', weight: 0.03, raw: '×›×Ÿ', normalized: 1 },
                { name: '×¢×¨×‘×•×ª ××•×©×š', weight: 0.00, raw: '×œ×', normalized: 0 }
            ];

            otherParams.forEach(param => {
                parameters.push({
                    name: param.name,
                    weight: param.weight,
                    rawValue: param.raw,
                    normalized: param.normalized,
                    weighted: param.normalized * param.weight
                });
            });

            return parameters;
        }

        function calculateTotalScore(parameters) {
            let totalWeighted = 0;
            parameters.forEach(param => {
                totalWeighted += param.weighted;
            });
            
            return Math.max(0, Math.min(100, totalWeighted * 100));
        }

        function getLetterRating(score) {
            if (score >= 90) return 'AAA';
            if (score >= 80) return 'AA';
            if (score >= 70) return 'A';
            if (score >= 60) return 'BBB';
            if (score >= 50) return 'BB';
            if (score >= 40) return 'B';
            if (score >= 30) return 'CCC';
            return 'D';
        }

        function displayResults(parameters, totalScore, letterRating, payerData, dbData) {
            // ×”×¦×’×ª ×”×“×™×¨×•×’ ×”×¨××©×™
            const ratingDisplay = document.getElementById('ratingDisplay');
            ratingDisplay.innerHTML = `
                <div class="rating-card">
                    <div class="rating-score rating-${letterRating}">${letterRating}</div>
                    <div style="color: #7f8c8d; font-size: 14px;">×“×™×¨×•×’ ××©×¨××™</div>
                </div>
                <div class="rating-card">
                    <div class="rating-score" style="color: #3498db;">${totalScore.toFixed(1)}</div>
                    <div style="color: #7f8c8d; font-size: 14px;">×¦×™×•×Ÿ ××¡×¤×¨×™</div>
                </div>
                <div class="rating-card">
                    <div class="rating-score" style="color: #e67e22;">${payerData.transactions}</div>
                    <div style="color: #7f8c8d; font-size: 14px;">×¢×¡×§××•×ª ×§×•×“××•×ª</div>
                </div>
                <div class="rating-card">
                    <div class="rating-score" style="color: #27ae60;">${dbData.dbScore}</div>
                    <div style="color: #7f8c8d; font-size: 14px;">×¦×™×•×Ÿ D&B</div>
                </div>
            `;

            // ×”×¦×’×ª ×¤×¨×˜×™ ×”×¤×¨××˜×¨×™×
            const parametersDisplay = document.getElementById('parametersDisplay');
            let parametersHTML = '';
            
            parameters.forEach(param => {
                parametersHTML += `
                    <div class="parameter-row">
                        <div class="parameter-name">${param.name}</div>
                        <div>${(param.weight * 100).toFixed(0)}%</div>
                        <div>${typeof param.rawValue === 'number' ? param.rawValue.toFixed(2) : param.rawValue}</div>
                        <div>${param.normalized.toFixed(3)}</div>
                        <div>${param.weighted.toFixed(4)}</div>
                    </div>
                `;
            });
            
            parametersDisplay.innerHTML = parametersHTML;

            // ×”×¦×’×ª ×”××œ×¦×” ××ª×•×§× ×ª
            const recommendation = document.getElementById('recommendation');
            let recommendationClass, recommendationText;
            
            if (totalScore >= 85) {
                recommendationClass = 'excellent';
                recommendationText = 'âœ… ××•××œ×¥ ×××•×“ - ×¡×™×›×•×Ÿ × ××•×š, ×œ×§×•×— ××™×›×•×ª×™ ×¢× ×¦×™×•×Ÿ ×’×‘×•×”';
            } else if (totalScore >= 75) {
                recommendationClass = 'good';
                recommendationText = 'ğŸ‘ ××•××œ×¥ - ×¡×™×›×•×Ÿ × ××•×š-×‘×™× ×•× ×™, ×œ×§×•×— ×˜×•×‘';
            } else if (totalScore >= 65) {
                recommendationClass = 'average';
                recommendationText = 'âš ï¸ ××•××œ×¥ ×‘×”×¡×ª×™×™×’×•×ª - ×¡×™×›×•×Ÿ ×‘×™× ×•× ×™, × ×“×¨×© ××¢×§×‘';
            } else if (totalScore >= 50) {
                recommendationClass = 'poor';
                recommendationText = 'ğŸ” ×–×”×™×¨×•×ª - ×¡×™×›×•×Ÿ ××•×’×‘×¨, ×©×§×•×œ ×“×¨×™×©×•×ª × ×•×¡×¤×•×ª';
            } else {
                recommendationClass = 'danger';
                recommendationText = 'âŒ ×œ× ××•××œ×¥ - ×¡×™×›×•×Ÿ ×’×‘×•×”, ×©×§×•×œ ×“×—×™×™×”';
            }
            
            recommendation.className = `recommendation ${recommendationClass}`;
            recommendation.textContent = recommendationText;
        }

        // ×©××™×¨×” ×œ×”×™×¡×˜×•×¨×™×”
        function saveToHistory() {
            if (!lastRatingResult) {
                alert('××™×Ÿ ×ª×•×¦××” ×œ×©××™×¨×”');
                return;
            }

            const history = getHistoryFromStorage();
            history.unshift(lastRatingResult);
            
            // ×©××™×¨×” ×©×œ 50 ×”×‘×“×™×§×•×ª ×”××—×¨×•× ×•×ª
            if (history.length > 50) {
                history.splice(50);
            }
            
            localStorage.setItem('creditHistory', JSON.stringify(history));
            displayHistory();
            alert('×”×ª×•×¦××” × ×©××¨×” ×œ×”×™×¡×˜×•×¨×™×”');
        }

        function getHistoryFromStorage() {
            try {
                return JSON.parse(localStorage.getItem('creditHistory') || '[]');
            } catch (e) {
                return [];
            }
        }

        function loadHistoryFromStorage() {
            displayHistory();
        }

        function displayHistory() {
            const history = getHistoryFromStorage();
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #7f8c8d;">××™×Ÿ ×”×™×¡×˜×•×¨×™×™×ª ×‘×“×™×§×•×ª</p>';
                return;
            }

            let historyHTML = '';
            history.slice(0, 10).forEach((item, index) => {
                historyHTML += `
                    <div class="history-item">
                        <div>
                            <strong>${item.payerName}</strong><br>
                            <small style="color: #7f8c8d;">${item.payerID}</small>
                        </div>
                        <div>
                            ×¡×›×•×: ${item.checkAmount.toLocaleString()} ×©×´×—<br>
                            <small style="color: #7f8c8d;">${item.date}</small>
                        </div>
                        <div>
                            <div class="history-rating rating-${item.letterRating}">${item.letterRating}</div>
                            <small>×¦×™×•×Ÿ: ${item.totalScore.toFixed(1)}</small>
                        </div>
                        <div>
                            <button onclick="deleteHistoryItem(${index})" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">××—×§</button>
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = historyHTML;
        }

        function deleteHistoryItem(index) {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×¤×¨×™×˜ ×–×”?')) {
                const history = getHistoryFromStorage();
                history.splice(index, 1);
                localStorage.setItem('creditHistory', JSON.stringify(history));
                displayHistory();
            }
        }

        function exportToExcel() {
            if (!lastRatingResult) {
                alert('××™×Ÿ ×ª×•×¦××” ×œ×™×™×¦×•×');
                return;
            }

            const data = [];
            data.push(['×“×•×— ×“×™×¨×•×’ ××©×¨××™']);
            data.push(['×©× ××•×©×š:', lastRatingResult.payerName]);
            data.push(['××¡×¤×¨ ×–×”×•×ª:', lastRatingResult.payerID]);
            data.push(['×¡×›×•× ×”×©×™×§:', lastRatingResult.checkAmount]);
            data.push(['×“×™×¨×•×’:', lastRatingResult.letterRating]);
            data.push(['×¦×™×•×Ÿ:', lastRatingResult.totalScore.toFixed(1)]);
            data.push(['×ª××¨×™×š:', lastRatingResult.date]);
            data.push([]);
            data.push(['×¤×¨××˜×¨', '××©×§×œ', '×¢×¨×š ×’×•×œ××™', '×× ×•×¨××œ', '××©×•×§×œ×œ']);
            
            lastRatingResult.parameters.forEach(param => {
                data.push([
                    param.name,
                    (param.weight * 100).toFixed(0) + '%',
                    typeof param.rawValue === 'number' ? param.rawValue.toFixed(2) : param.rawValue,
                    param.normalized.toFixed(3),
                    param.weighted.toFixed(4)
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "×“×™×¨×•×’ ××©×¨××™");
            
            const fileName = `×“×™×¨×•×’_××©×¨××™_${lastRatingResult.payerID}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function resetForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('customerID').value = '';
            document.getElementById('payerName').value = '';
            document.getElementById('payerID').value = '';
            document.getElementById('checkAmount').value = '';
            document.getElementById('checkDate').value = '';
            document.getElementById('creditDays').value = '';
            document.getElementById('commission').value = '';
            
            document.getElementById('resultsSection').style.display = 'none';
            lastRatingResult = null;
        }

        // ××ª×—×•×œ ×”××¢×¨×›×ª
        document.addEventListener('DOMContentLoaded', function() {
            console.log('××¢×¨×›×ª ×—×™×ª×•× ××©×¨××™ ××•×›× ×” ×œ×¤×¢×•×œ×”');
        });
    </script>
</body>
</html>
