// הסתרת הצעות
        function hideSuggestions() {
            document.getElementById('payerSuggestions').style.display = 'none';
            document.getElementById('customerSuggestions').style.display = 'none';
        }

        // רענון autocomplete
        function refreshAutocomplete() {
            // עדכון רשימות ההצעות
            console.log('Autocomplete מעודכן:', payersData.length, 'מושכים,', customersData.length, 'לקוחות');
        }

        // חישוב דירוג אשראי
        function calculateRating() {
            const payerName = document.getElementById('payerName').value;
            const payerID = document.getElementById('payerID').value;
            const customerName = document.getElementById('customerName').value;
            const customerID = document.getElementById('customerID').value;
            const checkAmount = parseFloat(document.getElementById('checkAmount').value);
            const paymentDate = document.getElementById('paymentDate').value;
            const bankCode = document.getElementById('bankCode').value;
            const branchCode = document.getElementById('branchCode').value;

            // בדיקת שדות חובה
            if (!payerName || !customerName || !checkAmount) {
                alert('אנא מלא את השדות החובה: שם מושך, שם לקוח וסכום השיק');
                return;
            }

            // קבלת נתוני מושך מהמאגר
            const payerData = findPayerData(payerID || payerName);
            const customerData = findCustomerData(customerID || customerName);
            const dbRecord = findDBData(payerID);

            // חישוב ימי אשראי
            const today = new Date();
            const payment = paymentDate ? new Date(paymentDate) : new Date(today.getTime() + 46*24*60*60*1000);
            const creditDays = Math.ceil((payment - today) / (1000 * 60 * 60 * 24));

            // חישוב פרמטרי הדירוג עם נתונים אמיתיים
            const parameters = calculateAllParameters(payerData, customerData, dbRecord, checkAmount, creditDays);

            // חישוב ציון סופי
            let finalScore = 0;
            parameters.forEach(param => {
                finalScore += (param.normalizedValue * param.weight) / 100;
            });

            // הגבלת הציון בין 0-100
            finalScore = Math.max(0, Math.min(100, finalScore * 100));

            // קביעת דירוג
            const rating = getRatingFromScore(finalScore);

            // קביעת המלצה
            const { recommendation, recommendationClass } = getRecommendation(finalScore);

            // הצגת התוצאות
            displayResults({
                payerName,
                customerName,
                payerID,
                customerID,
                checkAmount,
                creditDays,
                finalScore,
                rating,
                recommendation,
                recommendationClass,
                parameters,
                payerData,
                customerData,
                dbRecord,
                bankCode,
                branchCode
            });
        }

        // חיפוש נתוני מושך
        function findPayerData(identifier) {
            if (!identifier) return getDefaultPayerData();
            
            let payer = payersData.find(p => p.id === identifier || p.name === identifier);
            
            if (!payer) {
                // חיפוש במקורות נוספים
                payer = transactionsData.find(t => 
                    t['מספר זהות מושך'] === identifier || t['שם מושך'] === identifier
                );
                
                if (payer) {
                    payer = {
                        name: payer['שם מושך'],
                        id: payer['מספר זהות מושך'],
                        transactions: countPayerTransactions(payer['מספר זהות מושך']),
                        totalAmount: sumPayerTransactions(payer['מספר זהות מושך']),
                        returnedChecks: countReturnedChecks(payer['מספר זהות מושך'])
                    };
                }
            }
            
            return payer || getDefaultPayerData();
        }

        // חיפוש נתוני לקוח
        function findCustomerData(identifier) {
            if (!identifier) return getDefaultCustomerData();
            
            let customer = customersData.find(c => c.id === identifier || c.name === identifier);
            
            if (!customer) {
                customer = transactionsData.find(t => 
                    t['מ.זהות'] === identifier || t['שם לקוח'] === identifier
                );
                
                if (customer) {
                    customer = {
                        name: customer['שם לקוח'],
                        id: customer['מ.זהות'],
                        transactions: countCustomerTransactions(customer['מ.זהות']),
                        totalAmount: sumCustomerTransactions(customer['מ.זהות'])
                    };
                }
            }
            
            return customer || getDefaultCustomerData();
        }

        // חיפוש נתוני D&B
        function findDBData(payerID) {
            if (!payerID || dbData.length === 0) {
                return getDefaultDBData();
            }
            
            const dbRecord = dbData.find(record => 
                record['מס\' ח.פ'] === payerID || record['מספר זהות'] === payerID
            );
            
            return dbRecord || getDefaultDBData();
        }

        // חישוב כל הפרמטרים
        function calculateAllParameters(payerData, customerData, dbRecord, checkAmount, creditDays) {
            const dbScore = parseFloat(dbRecord?.['סקור']) || payerData.dbScore || 38.704;
            const sectorScore = parseFloat(dbRecord?.['סקור ענף']) || payerData.sectorScore || 29;
            const companyAge = parseInt(dbRecord?.['שנות ותק']) || payerData.companyAge || 0;
            const employeeCount = parseInt(dbRecord?.['מס\' מועסקים']) || payerData.employeeCount || 0;
            const annualTurnover = parseFloat(dbRecord?.['מחזור בא\' ₪']) || payerData.annualTurnover || 0;

            return [
                {
                    name: 'מספר עסקאות קודמות',
                    weight: 15,
                    rawValue: payerData.transactions || 0,
                    normalizedValue: calculateTransactionsScore(payerData.transactions || 0),
                    reason: getTransactionsReason(payerData.transactions || 0),
                    status: getTransactionsStatus(payerData.transactions || 0)
                },
                {
                    name: 'מספר חזרות שיקים',
                    weight: 5,
                    rawValue: payerData.returnedChecks || 0,
                    normalizedValue: calculateReturnedChecksScore(payerData.returnedChecks || 0),
                    reason: getReturnedChecksReason(payerData.returnedChecks || 0),
                    status: getReturnedChecksStatus(payerData.returnedChecks || 0)
                },
                {
                    name: 'חריגה מממוצע ימי אשראי',
                    weight: 10,
                    rawValue: creditDays,
                    normalizedValue: calculateCreditDaysScore(creditDays),
                    reason: getCreditDaysReason(creditDays),
                    status: getCreditDaysStatus(creditDays)
                },
                {
                    name: 'דירוג D&B',
                    weight: 8,
                    rawValue: dbScore,
                    normalizedValue: calculateDBScore(dbScore),
                    reason: getDBReason(dbScore),
                    status: getDBStatus(dbScore)
                },
                {
                    name: 'דירוג ענף',
                    weight: 5,
                    rawValue: sectorScore,
                    normalizedValue: calculateSectorScore(sectorScore),
                    reason: getSectorReason(sectorScore),
                    status: getSectorStatus(sectorScore)
                },
                {
                    name: 'מסוכנת מהענף',
                    weight: 8,
                    rawValue: dbScore - sectorScore,
                    normalizedValue: calculateSectorRiskScore(dbScore, sectorScore),
                    reason: getSectorRiskReason(dbScore, sectorScore),
                    status: getSectorRiskStatus(dbScore, sectorScore)
                },
                {
                    name: 'גיל החברה',
                    weight: 13,
                    rawValue: companyAge,
                    normalizedValue: calculateCompanyAgeScore(companyAge),
                    reason: getCompanyAgeReason(companyAge),
                    status: getCompanyAgeStatus(companyAge)
                },
                {
                    name: 'מחזור שנתי',
                    weight: 3,
                    rawValue: annualTurnover,
                    normalizedValue: calculateTurnoverScore(annualTurnover),
                    reason: getTurnoverReason(annualTurnover),
                    status: getTurnoverStatus(annualTurnover)
                }
            ];
        }

        // פונקציות חישוב ציונים
        function calculateTransactionsScore(count) {
            if (count >= 100) return 1;
            if (count >= 50) return 0.8;
            if (count >= 20) return 0.6;
            if (count >= 10) return 0.4;
            if (count >= 5) return 0.2;
            return count === 0 ? 0 : 0.1;
        }

        function calculateReturnedChecksScore(count) {
            return count === 0 ? 1 : Math.max(0, 1 - count * 0.2);
        }

        function calculateCreditDaysScore(days) {
            return days <= 30 ? 1 : Math.max(0, 1 - (days - 30) / 60);
        }

        function calculateDBScore(score) {
            return score >= 30 ? score / 100 : Math.max(0, (score / 100) - 0.3);
        }

        function calculateSectorScore(score) {
            return score >= 32 ? score / 100 : Math.max(0, (score / 100) - 0.3);
        }

        function calculateSectorRiskScore(dbScore, sectorScore) {
            return dbScore >= sectorScore ? 0 : Math.min(0, (dbScore - sectorScore) / 50) * 10;
        }

        function calculateCompanyAgeScore(age) {
            if (age >= 30) return 1;
            if (age >= 20) return 0.8;
            if (age >= 10) return 0.6;
            if (age >= 5) return 0.4;
            if (age >= 3) return 0.2;
            return 0.1;
        }

        function calculateTurnoverScore(turnover) {
            return Math.min(turnover / 50000000, 1);
        }

        // פונקציות קבלת סיבות
        function getTransactionsReason(count) {
            if (count === 0) return 'אין עסקאות קודמות - מושך חדש';
            if (count >= 50) return `${count} עסקאות - מושך מנוסה`;
            if (count >= 10) return `${count} עסקאות - מושך פעיל`;
            return `${count} עסקאות - מושך חדש יחסית`;
        }

        function getReturnedChecksReason(count) {
            if (count === 0) return 'אין חזרות שיקים - נקי';
            if (count <= 2) return `${count} חזרות - בסדר`;
            return `${count} חזרות שיקים - בעייתי`;
        }

        function getCreditDaysReason(days) {
            if (days <= 30) return 'ימי אשראי תקינים';
            if (days <= 60) return 'ימי אשראי גבוהים מהממוצע';
            return 'ימי אשראי גבוהים מאוד - תנאי אשראי קשים';
        }

        function getDBReason(score) {
            if (score <= 20) return 'ציון D&B נמוך מאוד - BAD❌';
            if (score <= 30) return 'ציון D&B נמוך - NO☢️';
            if (score <= 50) return 'ציון D&B בינוני - OK✅';
            if (score <= 75) return 'ציון D&B טוב - GOOD😊';
            return 'ציון D&B מעולה - VERY GOOD😀';
        }

        function getSectorReason(score) {
            if (score <= 25) return 'דירוג ענף נמוך מאוד';
            if (score <= 35) return 'דירוג ענף נמוך';
            if (score <= 50) return 'דירוג ענף בינוני';
            return 'דירוג ענף טוב';
        }

        function getSectorRiskReason(dbScore, sectorScore) {
            if (dbScore < sectorScore) return 'מסוכנת מהענף שלה - ציון D&B נמוך מהענף';
            if (dbScore === sectorScore) return 'מדורגת כמו הענף';
            return 'חברה מדורגת מעל הענף';
        }

        function getCompanyAgeReason(age) {
            if (age === 0) return 'חברה חדשה - להזהר';
            if (age >= 30) return 'חברה ותיקה';
            if (age >= 10) return 'חברה בשלה';
            if (age >= 5) return 'חברה מתפתחת';
            return 'חברה צעירה';
        }

        function getTurnoverReason(turnover) {
            if (turnover === 0) return 'אין נתוני מחזורים';
            if (turnover >= 50000000) return `מחזור גבוה: ₪${turnover.toLocaleString()}`;
            if (turnover >= 10000000) return `מחזור בינוני: ₪${turnover.toLocaleString()}`;
            return `מחזור נמוך: ₪${turnover.toLocaleString()}`;
        }

        // פונקציות קבלת סטטוס
        function getTransactionsStatus(count) {
            if (count === 0) return 'missing';
            if (count >= 10) return 'positive';
            return 'neutral';
        }

        function getReturnedChecksStatus(count) {
            if (count === 0) return 'positive';
            if (count <= 2) return 'neutral';
            return 'negative';
        }

        function getCreditDaysStatus(days) {
            if (days <= 30) return 'positive';
            if (days <= 60) return 'neutral';
            return 'negative';
        }

        function getDBStatus(score) {
            if (score <= 30) return 'negative';
            if (score >= 50) return 'positive';
            return 'neutral';
        }

        function getSectorStatus(score) {
            if (score >= 40) return 'positive';
            if (score >= 30) return 'neutral';
            return 'negative';
        }

        function getSectorRiskStatus(dbScore, sectorScore) {
            if (dbScore < sectorScore) return 'negative';
            return 'neutral';
        }

        function getCompanyAgeStatus(age) {
            if (age === 0) return 'negative';
            if (age >= 10) return 'positive';
            return 'neutral';
        }

        function getTurnoverStatus(turnover) {
            if (turnover === 0) return 'missing';
            if (turnover >= 10000000) return 'positive';
            return 'neutral';
        }

        // פונקציות עזר לחישובי היסטוריה
        function countPayerTransactions(payerID) {
            return transactionsData.filter(t => t['מספר זהות מושך'] === payerID).length;
        }

        function sumPayerTransactions(payerID) {
            return transactionsData
                .filter(t => t['מספר זהות מושך'] === payerID)
                .reduce((sum, t) => sum + (parseFloat(t['סכום']) || 0), 0);
        }

        function countReturnedChecks(payerID) {
            return transactionsData.filter(t => 
                t['מספר זהות מושך'] === payerID && 
                (t['סטטוס'] === 'שיק שחזר' || t['סטטוס'] === 'הושב ללקוח')
            ).length;
        }

        function countCustomerTransactions(customerID) {
            return transactionsData.filter(t => t['מ.זהות'] === customerID).length;
        }

        function sumCustomerTransactions(customerID) {
            return transactionsData
                .filter(t => t['מ.זהות'] === customerID)
                .reduce((sum, t) => sum + (parseFloat(t['סכום']) || 0), 0);
        }

        // נתוני ברירת מחדל
        function getDefaultPayerData() {
            return {
                name: '',
                id: '',
                transactions: 0,
                totalAmount: 0,
                returnedChecks: 0,
                dbScore: 38.704,
                sectorScore: 29,
                companyAge: 0,
                employeeCount: 0,
                annualTurnover: 0
            };
        }

        function getDefaultCustomerData() {
            return {
                name: '',
                id: '',
                transactions: 0,
                totalAmount: 0
            };
        }

        function getDefaultDBData() {
            return {
                'סקור': 38.704,
                'סקור ענף': 29,
                'שנות ותק': 0,
                'מס\' מועסקים': 0,
                'מחזור בא\' ₪': 0
            };
        }

        // קבלת דירוג מציון
        function getRatingFromScore(score) {
            if (score >= 90) return 'AAA';
            if (score >= 80) return 'AA';
            if (score >= 70) return 'A';
            if (score >= 60) return 'BBB';
            if (score >= 50) return 'BB';
            if (score >= 40) return 'B';
            if (score >= 30) return 'CCC';
            return 'D';
        }

        // קבלת המלצה
        function getRecommendation(score) {
            if (score >= 70) {
                return { recommendation: 'מומלץ', recommendationClass: 'positive' };
            } else if (score >= 50) {
                return { recommendation: 'בבדיקה נוספת', recommendationClass: 'warning' };
            } else {
                return { recommendation: 'לא מומלץ', recommendationClass: '' };
            }
        }

        // הצגת תוצאות (כמו בגרסה הקודמת)
        function displayResults(results) {
            const resultsSection = document.getElementById('resultsSection');
            const ratingDisplay = document.getElementById('ratingDisplay');
            const detailsGrid = document.getElementById('detailsGrid');
            const parametersGrid = document.getElementById('parametersGrid');
            const recommendationDiv = document.getElementById('recommendation');

            // הצגת דירוג ראשי
            ratingDisplay.innerHTML = `
                <div class="rating-card">
                    <div class="rating-score rating-${results.rating}">${results.finalScore.toFixed(1)}</div>
                    <div>ציון סופי</div>
                </div>
                <div class="rating-card">
                    <div class="rating-score rating-${results.rating}">${results.rating}</div>
                    <div>דירוג אשראי</div>
                </div>
                <div class="rating-card">
                    <div style="font-size: 2em; margin-bottom: 10px;">📊</div>
                    <div>רמת סיכון: ${results.finalScore >= 70 ? 'נמוכה' : results.finalScore >= 50 ? 'בינונית' : 'גבוהה'}</div>
                </div>
            `;

            // הצגת פרטים
            detailsGrid.innerHTML = `
                <div class="detail-card">
                    <h3>פרטי העסקה</h3>
                    <div class="detail-row">
                        <span class="detail-label">מושך:</span>
                        <span class="detail-value">${results.payerName}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ח.פ. מושך:</span>
                        <span class="detail-value">${results.payerID}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">לקוח:</span>
                        <span class="detail-value">${results.customerName}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ח.פ. לקוח:</span>
                        <span class="detail-value">${results.customerID}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">סכום:</span>
                        <span class="detail-value">₪${results.checkAmount.toLocaleString()}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ימי אשראי:</span>
                        <span class="detail-value">${results.creditDays}</span>
                    </div>
                </div>
                <div class="detail-card">
                    <h3>נתוני מושך (מהמאגר)</h3>
                    <div class="detail-row">
                        <span class="detail-label">עסקאות קודמות:</span>
                        <span class="detail-value">${results.payerData.transactions || 0}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">סכום כולל:</span>
                        <span class="detail-value">₪${(results.payerData.totalAmount || 0).toLocaleString()}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">חזרות שיקים:</span>
                        <span class="detail-value">${results.payerData.returnedChecks || 0}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ציון D&B:</span>
                        <span class="detail-value">${results.dbRecord?.['סקור'] || results.payerData.dbScore || 38.704}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ציון ענף:</span>
                        <span class="detail-value">${results.dbRecord?.['סקור ענף'] || results.payerData.sectorScore || 29}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">גיל חברה:</span>
                        <span class="detail-value">${results.dbRecord?.['שנות ותק'] || results.payerData.companyAge || 0} שנים</span>
                    </div>
                </div>
                <div class="detail-card">
                    <h3>נתוני לקוח (מהמאגר)</h3>
                    <div class="detail-row">
                        <span class="detail-label">עסקאות קודמות:</span>
                        <span class="detail-value">${results.customerData.transactions || 0}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">סכום כולל:</span>
                        <span class="detail-value">₪${(results.customerData.totalAmount || 0).toLocaleString()}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">מספר עובדים:</span>
                        <span class="detail-value">${results.dbRecord?.['מס\' מועסקים'] || 'לא ידוע'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">מחזור שנתי:</span>
                        <span class="detail-value">${results.dbRecord?.['מחזור בא\' ₪'] ? '₪' + parseInt(results.dbRecord['מחזור בא\' ₪']).toLocaleString() : 'לא ידוע'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">מקור נתונים:</span>
                        <span class="detail-value">${transactionsData.length > 0 ? 'קבצים אמיתיים' : 'נתוני דוגמה'}</span>
                    </div>
                </div>
            `;

            // הצגת פרמטרים
            let parametersHTML = `
                <div class="parameter-item" style="font-weight: bold; background: #f8f9fa;">
                    <div>פרמטר</div>
                    <div>משקל</div>
                    <div>ערך גולמי</div>
                    <div>ערך מנורמל</div>
                    <div>סטטוס</div>
                </div>
            `;
            
            results.parameters.forEach(param => {
                parametersHTML += `
                    <div class="parameter-item">
                        <div>
                            <div class="parameter-name">${param.name}</div>
                            <div class="parameter-reason">${param.reason}</div>
                        </div>
                        <div>${param.weight}%</div>
                        <div>${param.rawValue}</div>
                        <div>${param.normalizedValue.toFixed(3)}</div>
                        <div>
                            <span class="status-badge status-${param.status}">
                                ${param.status === 'positive' ? 'חיובי' : 
                                  param.status === 'negative' ? 'שלילי' : 
                                  param.status === 'missing' ? 'חסר' : 'ניטרלי'}
                            </span>
                        </div>
                    </div>
                `;
            });

            parametersGrid.innerHTML = parametersHTML;

            // הצגת המלצה
            recommendationDiv.className = `recommendation ${results.recommendationClass}`;
            recommendationDiv.innerHTML = `
                <div style="font-size: 1.5em; margin-bottom: 10px;">
                    ${results.recommendation === 'מומלץ' ? '✅' : results.recommendation === 'בבדיקה נוספת' ? '⚠️' : '❌'}
                </div>
                <div>המלצה סופית: ${results.recommendation}</div>
                ${results.finalScore < 30 ? '<div style="margin-top: 10px; font-size: 0.9em;">עסקה בסיכון גבוה - נדרשת בדיקה מעמיקה</div>' : ''}
                ${transactionsData.length > 0 ? '<div style="margin-top: 10px; font-size: 0.9em;">✅ מבוסס על נתונים אמיתיים מהמאגר</div>' : '<div style="margin-top: 10px; font-size: 0.9em;">⚠️ מבוסס על נתוני דוגמה</div>'}
            `;

            // הצגת תוצאות
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // איפוס הטופס
        function resetForm() {
            document.getElementById('payerName').value = '';
            document.getElementById('payerID').value = '';
            document.getElementById('customerName').value = '';
            document.getElementById('customerID').value = '';
            document.getElementById('checkAmount').value = '';
            document.getElementById('paymentDate').value = '';
            document.getElementById('bankCode').value = '';
            document.getElementById('branchCode').value = '';
            document.getElementById('accountNumber').value = '';
            
            document.getElementById('resultsSection').style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // טעינת דוגמה
        function loadExample() {
            document.getElementById('payerName').value = 'הדר בניה אחזקה';
            document.getElementById('payerID').value = '200353902';
            document.getElementById('customerName').value = 'איברהים ראבי';
            document.getElementById('customerID').value = '305346900';
            document.getElementById('checkAmount').value = '50000';
            document.getElementById('bankCode').value = '20';
            document.getElementById('branchCode').value = '512';
            
            const futureDate = new Date();
            futureDate.setDate(futureDate.getDate() + 46);
            document.getElementById('paymentDate').value = futureDate.toISOString().split('T')[0];
        }

        // אתחול המערכת
        window.addEventListener('load', initializeSystem);
    </script>
</body>
</html>
    </script><!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת חיתום אשראי מתקדמת</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .input-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .results-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: none;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e1e8ed;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-suggestion {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
        }

        .autocomplete-suggestion:hover {
            background: #f8f9fa;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        .suggestion-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .suggestion-id {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 2px;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .rating-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .rating-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .rating-score {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .rating-D { color: #e74c3c; }
        .rating-CCC { color: #e67e22; }
        .rating-B { color: #f39c12; }
        .rating-BB { color: #f1c40f; }
        .rating-BBB { color: #f39c12; }
        .rating-A { color: #27ae60; }
        .rating-AA { color: #2ecc71; }
        .rating-AAA { color: #27ae60; }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .detail-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .detail-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .detail-label {
            color: #7f8c8d;
        }

        .detail-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .parameters-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .parameter-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            align-items: center;
        }

        .parameter-item:last-child {
            border-bottom: none;
        }

        .parameter-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .parameter-reason {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
        }

        .status-positive { background: #d5f4e6; color: #27ae60; }
        .status-negative { background: #fadbd8; color: #e74c3c; }
        .status-neutral { background: #eaecee; color: #7f8c8d; }
        .status-missing { background: #fdf2e9; color: #e67e22; }

        .recommendation {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            font-size: 1.2em;
            font-weight: 600;
        }

        .recommendation.positive {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .recommendation.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .file-upload {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .file-upload input {
            display: none;
        }

        .file-upload label {
            cursor: pointer;
            color: #3498db;
            font-weight: 600;
        }

        .data-status {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .data-status h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .data-item:last-child {
            border-bottom: none;
        }

        .data-item-name {
            color: #34495e;
            font-weight: 500;
        }

        .data-item-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-loaded { background: #d5f4e6; color: #27ae60; }
        .status-missing { background: #fadbd8; color: #e74c3c; }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .details-grid {
                grid-template-columns: 1fr;
            }
            
            .rating-display {
                grid-template-columns: 1fr;
            }
            
            .parameter-item {
                grid-template-columns: 1fr;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏦 מערכת חיתום אשראי מתקדמת</h1>
            <p>הערכת סיכונים וחישוב דירוג אשראי על בסיס 16 פרמטרים</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2 style="margin-bottom: 25px; color: #2c3e50;">פרטי השיק והמושך</h2>
                
                <div class="data-status" id="dataStatus">
                    <h3>סטטוס קבצי נתונים</h3>
                    <div class="data-item">
                        <span class="data-item-name">גיליון עסקאות</span>
                        <span class="data-item-status status-missing" id="status-transactions">לא נטען</span>
                    </div>
                    <div class="data-item">
                        <span class="data-item-name">נתוני מושכים</span>
                        <span class="data-item-status status-missing" id="status-payers">לא נטען</span>
                    </div>
                    <div class="data-item">
                        <span class="data-item-name">נתוני לקוחות</span>
                        <span class="data-item-status status-missing" id="status-customers">לא נטען</span>
                    </div>
                    <div class="data-item">
                        <span class="data-item-name">נתוני D&B</span>
                        <span class="data-item-status status-missing" id="status-db">לא נטען</span>
                    </div>
                    <div class="data-item">
                        <span class="data-item-name">נתוני בנקים</span>
                        <span class="data-item-status status-missing" id="status-banks">לא נטען</span>
                    </div>
                </div>

                <div class="file-upload">
                    <label for="dataFiles">📁 העלה קבצי נתונים (Excel/CSV)</label>
                    <input type="file" id="dataFiles" multiple accept=".xlsx,.xls,.csv">
                    <p style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">
                        קבצים נדרשים: כלהנתונים6.11.22.xlsx, חיתום אשראי.xlsx, קבצי שיקים חוזרים
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="payerName">שם מושך</label>
                    <div class="autocomplete-container">
                        <input type="text" id="payerName" placeholder="התחל להקליד שם מושך..." autocomplete="off">
                        <div id="payerSuggestions" class="autocomplete-suggestions"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="payerID">ח.פ./ע.מ. מושך</label>
                    <input type="text" id="payerID" placeholder="יתמלא אוטומטי" readonly style="background: #f8f9fa;">
                </div>

                <div class="form-group">
                    <label for="customerName">שם לקוח</label>
                    <div class="autocomplete-container">
                        <input type="text" id="customerName" placeholder="התחל להקליד שם לקוח..." autocomplete="off">
                        <div id="customerSuggestions" class="autocomplete-suggestions"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="customerID">ח.פ./ע.מ. לקוח</label>
                    <input type="text" id="customerID" placeholder="יתמלא אוטומטי" readonly style="background: #f8f9fa;">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="checkAmount">סכום השיק</label>
                        <input type="number" id="checkAmount" placeholder="סכום בש״ח">
                    </div>
                    <div class="form-group">
                        <label for="paymentDate">תאריך פירעון</label>
                        <input type="date" id="paymentDate">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="bankCode">בנק</label>
                        <input type="text" id="bankCode" placeholder="קוד בנק">
                    </div>
                    <div class="form-group">
                        <label for="branchCode">סניף</label>
                        <input type="text" id="branchCode" placeholder="קוד סניף">
                    </div>
                </div>

                <div class="form-group">
                    <label for="accountNumber">מספר חשבון</label>
                    <input type="text" id="accountNumber" placeholder="מספר חשבון">
                </div>

                <button class="btn" onclick="calculateRating()">
                    🧮 חשב דירוג אשראי מתקדם
                </button>

                <button class="btn" style="background: #95a5a6; margin-top: 10px;" onclick="loadExample()">
                    📋 טען דוגמה מהירה
                </button>
            </div>

            <div class="results-section" id="resultsSection">
                <div class="rating-display" id="ratingDisplay">
                    <!-- תוצאות יוצגו כאן -->
                </div>

                <div class="details-grid" id="detailsGrid">
                    <!-- פרטים יוצגו כאן -->
                </div>

                <div class="parameters-section">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">פירוט פרמטרי הדירוג (16 פרמטרים)</h3>
                    <div id="parametersGrid">
                        <!-- פרמטרים יוצגו כאן -->
                    </div>
                </div>

                <div id="recommendation" class="recommendation">
                    <!-- המלצה תוצג כאן -->
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" style="width: auto; margin-right: 10px;" onclick="window.print()">
                        🖨️ הדפס דוח
                    </button>
                    <button class="btn" style="width: auto; background: #95a5a6;" onclick="resetForm()">
                        🔄 עסקה חדשה
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // משתנים גלובליים לאחסון הנתונים
        let transactionsData = [];
        let payersData = [];
        let customersData = [];
        let dbData = [];
        let banksData = [];

        // נתוני דוגמה ראשוניים
        const sampleData = {
            payers: [
                { name: 'הדר בניה אחזקה', id: '200353902', dbScore: 38.704, sectorScore: 29 },
                { name: 'איברהים ראבי', id: '305346900', dbScore: 45.2, sectorScore: 32 },
                { name: 'חברת הבנייה הגדולה', id: '123456789', dbScore: 72.5, sectorScore: 65 },
                { name: 'משה כהן', id: '987654321', dbScore: 55.8, sectorScore: 50 }
            ],
            customers: [
                { name: 'איברהים ראבי', id: '305346900' },
                { name: 'שרה לוי', id: '123456788' },
                { name: 'דוד ישראלי', id: '111222333' },
                { name: 'מירב פולק', id: '444555666' }
            ]
        };

        // אתחול המערכת
        function initializeSystem() {
            setupFileUpload();
            setupAutocomplete();
            loadSampleData();
        }

        // הגדרת העלאת קבצים
        function setupFileUpload() {
            document.getElementById('dataFiles').addEventListener('change', handleFileUpload);
        }

        // טיפול בהעלאת קבצים
        async function handleFileUpload(event) {
            const files = event.target.files;
            
            for (let file of files) {
                try {
                    const fileName = file.name.toLowerCase();
                    
                    if (fileName.includes('כלהנתונים') || fileName.includes('גיליון1')) {
                        await loadTransactionsFile(file);
                        updateDataStatus('transactions', 'נטען בהצלחה');
                    } 
                    else if (fileName.includes('חיתום אשראי') || fileName.includes('score')) {
                        await loadDBFile(file);
                        updateDataStatus('db', 'נטען בהצלחה');
                    }
                    else if (fileName.includes('שיקים') && fileName.includes('חוזרים')) {
                        await loadReturnedChecksFile(file);
                    }
                    else if (fileName.includes('sigma')) {
                        await loadSigmaFile(file);
                    }
                    
                } catch (error) {
                    console.error('שגיאה בטעינת קובץ:', file.name, error);
                    alert(`שגיאה בטעינת קובץ ${file.name}: ${error.message}`);
                }
            }
        }

        // טעינת קובץ עסקאות
        async function loadTransactionsFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        // עיבוד הנתונים
                        processTransactionsData(jsonData);
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // עיבוד נתוני עסקאות
        function processTransactionsData(rawData) {
            const headers = rawData[0];
            transactionsData = [];
            payersData = [];
            customersData = [];
            
            for (let i = 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (!row || row.length === 0) continue;
                
                const transaction = {};
                headers.forEach((header, index) => {
                    transaction[header] = row[index];
                });
                
                transactionsData.push(transaction);
                
                // איסוף מושכים ולקוחות
                if (transaction['שם מושך'] && transaction['מספר זהות מושך']) {
                    const existingPayer = payersData.find(p => p.id === transaction['מספר זהות מושך']);
                    if (!existingPayer) {
                        payersData.push({
                            name: transaction['שם מושך'],
                            id: transaction['מספר זהות מושך'],
                            transactions: 1,
                            totalAmount: parseFloat(transaction['סכום']) || 0
                        });
                    } else {
                        existingPayer.transactions++;
                        existingPayer.totalAmount += parseFloat(transaction['סכום']) || 0;
                    }
                }
                
                if (transaction['שם לקוח'] && transaction['מ.זהות']) {
                    const existingCustomer = customersData.find(c => c.id === transaction['מ.זהות']);
                    if (!existingCustomer) {
                        customersData.push({
                            name: transaction['שם לקוח'],
                            id: transaction['מ.זהות']
                        });
                    }
                }
            }
            
            updateDataStatus('payers', `${payersData.length} מושכים`);
            updateDataStatus('customers', `${customersData.length} לקוחות`);
            refreshAutocomplete();
        }

        // טעינת קובץ D&B
        async function loadDBFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // חיפוש גיליון scoreM_N
                        const scoreMNSheet = workbook.Sheets['scoreM_N'] || workbook.Sheets[workbook.SheetNames[0]];
                        if (scoreMNSheet) {
                            const jsonData = XLSX.utils.sheet_to_json(scoreMNSheet, { header: 1 });
                            processDBData(jsonData);
                        }
                        
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // עיבוד נתוני D&B
        function processDBData(rawData) {
            const headers = rawData[0];
            dbData = [];
            
            for (let i = 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (!row || row.length === 0) continue;
                
                const dbRecord = {};
                headers.forEach((header, index) => {
                    dbRecord[header] = row[index];
                });
                
                dbData.push(dbRecord);
            }
        }

        // טעינת נתוני דוגמה
        function loadSampleData() {
            payersData = [...sampleData.payers];
            customersData = [...sampleData.customers];
            
            updateDataStatus('payers', `${payersData.length} מושכים (דוגמה)`);
            updateDataStatus('customers', `${customersData.length} לקוחות (דוגמה)`);
            refreshAutocomplete();
        }

        // עדכון סטטוס נתונים
        function updateDataStatus(type, status) {
            const statusElement = document.getElementById(`status-${type}`);
            if (statusElement) {
                statusElement.textContent = status;
                statusElement.className = 'data-item-status status-loaded';
            }
        }

        // הגדרת autocomplete
        function setupAutocomplete() {
            const payerInput = document.getElementById('payerName');
            const customerInput = document.getElementById('customerName');
            
            payerInput.addEventListener('input', (e) => showSuggestions(e, 'payers'));
            customerInput.addEventListener('input', (e) => showSuggestions(e, 'customers'));
            
            // סגירת suggestions בעת לחיצה בחוץ
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container')) {
                    hideSuggestions();
                }
            });
        }

        // הצגת הצעות
        function showSuggestions(event, type) {
            const input = event.target;
            const query = input.value.toLowerCase();
            const suggestionsId = type === 'payers' ? 'payerSuggestions' : 'customerSuggestions';
            const suggestionsContainer = document.getElementById(suggestionsId);
            
            if (query.length < 2) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            const data = type === 'payers' ? payersData : customersData;
            const filtered = data.filter(item => 
                item.name.toLowerCase().includes(query)
            ).slice(0, 10);
            
            if (filtered.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            suggestionsContainer.innerHTML = filtered.map(item => `
                <div class="autocomplete-suggestion" onclick="selectSuggestion('${type}', '${item.name}', '${item.id}')">
                    <div class="suggestion-name">${item.name}</div>
                    <div class="suggestion-id">${item.id}</div>
                </div>
            `).join('');
            
            suggestionsContainer.style.display = 'block';
        }

        // בחירת הצעה
        function selectSuggestion(type, name, id) {
            if (type === 'payers') {
                document.getElementById('payerName').value = name;
                document.getElementById('payerID').value = id;
            } else {
                document.getElementById('customerName').value = name;
                document.getElementById('customerID').value = id;
            }
            
            hideSuggestions();
        }

        // הסתרת הצעות
        function hideSuggestions() {
            document.getElementById('payerSuggestions').style.display = 'none';
            document.getElementById('customerSuggestions').
