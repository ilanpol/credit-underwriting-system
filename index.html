<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת חיתום אשראי - לפי הנוסחאות המקוריות</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            direction: rtl; 
        }
        .container { max-width: 1800px; margin: 0 auto; padding: 20px; }
        .header { 
            background: rgba(255, 255, 255, 0.95); 
            padding: 30px; 
            border-radius: 20px; 
            text-align: center; 
            margin-bottom: 30px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); 
        }
        .header h1 { color: #2c3e50; font-size: 2.5em; margin-bottom: 10px; }
        .header p { color: #7f8c8d; font-size: 1.2em; }
        .main-content { 
            display: grid; 
            grid-template-columns: 1fr 2fr; 
            gap: 30px; 
            margin-bottom: 30px; 
        }
        .input-section, .results-section { 
            background: rgba(255, 255, 255, 0.95); 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); 
        }
        .results-section { display: none; }
        .form-group { margin-bottom: 20px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600; 
            color: #34495e; 
            font-size: 14px; 
        }
        input, select { 
            width: 100%; 
            padding: 10px 12px; 
            border: 2px solid #e1e8ed; 
            border-radius: 8px; 
            font-size: 14px; 
            transition: all 0.3s ease; 
        }
        input:focus, select:focus { 
            outline: none; 
            border-color: #3498db; 
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); 
        }
        .btn { 
            background: linear-gradient(135deg, #3498db, #2980b9); 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 25px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            width: 100%; 
            transition: all 0.3s ease; 
            margin-top: 15px; 
        }
        .btn:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4); 
        }
        .btn:disabled { 
            background: #bdc3c7; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }
        .file-upload { 
            background: #f8f9fa; 
            border: 2px dashed #dee2e6; 
            border-radius: 10px; 
            padding: 15px; 
            text-align: center; 
            margin-bottom: 15px; 
            transition: all 0.3s ease; 
        }
        .file-upload:hover { 
            border-color: #3498db; 
            background: #f0f8ff; 
        }
        .file-upload input { display: none; }
        .file-upload label { 
            cursor: pointer; 
            color: #3498db; 
            font-weight: 600; 
        }
        .rating-display { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .rating-card { 
            background: white; 
            padding: 20px; 
            border-radius: 15px; 
            text-align: center; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
        }
        .rating-score { 
            font-size: 3em; 
            font-weight: bold; 
            margin-bottom: 10px; 
        }
        .rating-AAA { color: #27ae60; }
        .rating-AA { color: #2ecc71; }
        .rating-A { color: #f39c12; }
        .rating-BBB { color: #f1c40f; }
        .rating-BB { color: #e67e22; }
        .rating-B { color: #e74c3c; }
        .rating-CCC { color: #c0392b; }
        .rating-D { color: #8b0000; }
        .parameters-section { 
            background: white; 
            border-radius: 15px; 
            padding: 20px; 
            margin-bottom: 20px; 
        }
        .parameter-header { 
            display: grid; 
            grid-template-columns: 3fr 1fr 1fr 1fr 1fr 1fr; 
            gap: 10px; 
            padding: 12px; 
            background: #f8f9fa; 
            border-radius: 8px; 
            font-weight: bold; 
            margin-bottom: 10px; 
            font-size: 14px;
        }
        .parameter-row { 
            display: grid; 
            grid-template-columns: 3fr 1fr 1fr 1fr 1fr 1fr; 
            gap: 10px; 
            padding: 10px 12px; 
            border-bottom: 1px solid #ecf0f1; 
            align-items: center; 
            font-size: 13px;
        }
        .parameter-row:last-child { border-bottom: none; }
        .parameter-name { font-weight: 600; color: #2c3e50; }
        .parameter-description { font-size: 11px; color: #7f8c8d; margin-top: 2px; }
        .formula-display { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 8px; 
            padding: 10px; 
            margin: 5px 0; 
            font-family: 'Courier New', monospace; 
            font-size: 11px; 
            color: #495057;
        }
        .recommendation { 
            text-align: center; 
            margin: 20px 0; 
            font-size: 1.1em; 
            font-weight: 600; 
            padding: 20px;
            border-radius: 15px;
        }
        .recommendation.AAA, .recommendation.AA { background: linear-gradient(135deg, #27ae60, #229954); color: white; }
        .recommendation.A { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .recommendation.BBB, .recommendation.BB { background: linear-gradient(135deg, #e67e22, #d35400); color: white; }
        .recommendation.B, .recommendation.CCC, .recommendation.D { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .data-summary { 
            background: white; 
            border-radius: 15px; 
            padding: 20px; 
            margin-bottom: 20px; 
        }
        .summary-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 15px; 
        }
        .summary-item { 
            text-align: center; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 10px; 
        }
        .summary-value { 
            font-size: 1.8em; 
            font-weight: bold; 
            color: #2c3e50; 
        }
        .summary-label { 
            font-size: 12px; 
            color: #7f8c8d; 
            margin-top: 5px; 
        }
        @media (max-width: 1200px) { 
            .main-content { grid-template-columns: 1fr; } 
            .rating-display { grid-template-columns: repeat(2, 1fr); } 
            .parameter-header, .parameter-row { 
                grid-template-columns: 2fr 1fr 1fr; 
                font-size: 12px; 
            }
            .summary-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏦 מערכת חיתום אשראי מתקדמת</h1>
            <p>חישוב דירוג אשראי לפי 16 פרמטרים - הנוסחאות המקוריות מהאקסל</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2 style="margin-bottom: 20px; color: #2c3e50; font-size: 18px;">פרטי העסקה</h2>
                
                <div class="file-upload">
                    <label for="dataFiles">📁 העלה קבצי נתונים</label>
                    <input type="file" id="dataFiles" multiple accept=".xlsx,.xls,.csv">
                    <p style="margin-top: 8px; font-size: 10px; color: #7f8c8d;">
                        קבצים: גיליון עסקאות, נתוני D&B, שיקים חוזרים, sigma, התרעות
                    </p>
                </div>

                <div class="form-group">
                    <label for="customerName">שם לקוח</label>
                    <input type="text" id="customerName" placeholder="הזן שם לקוח">
                </div>

                <div class="form-group">
                    <label for="customerID">ח.פ./ת.ז. לקוח</label>
                    <input type="text" id="customerID" placeholder="הזן מספר זהות לקוח">
                </div>

                <div class="form-group">
                    <label for="payerName">שם מושך</label>
                    <input type="text" id="payerName" placeholder="הזן שם מושך">
                </div>

                <div class="form-group">
                    <label for="payerID">ח.פ./ת.ז. מושך</label>
                    <input type="text" id="payerID" placeholder="הזן מספר זהות מושך">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="checkAmount">סכום השיק</label>
                        <input type="number" id="checkAmount" placeholder="סכום בש״ח">
                    </div>
                    <div class="form-group">
                        <label for="checkDate">תאריך השיק</label>
                        <input type="date" id="checkDate">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="creditDays">ימי אשראי</label>
                        <input type="number" id="creditDays" placeholder="מספר ימי אשראי">
                    </div>
                    <div class="form-group">
                        <label for="commission">עמלה</label>
                        <input type="number" id="commission" step="0.01" placeholder="עמלה ב%">
                    </div>
                </div>

                <button class="btn" onclick="calculateCreditRating()" id="calculateBtn">
                    🧮 חשב דירוג אשראי (16 פרמטרים)
                </button>

                <button class="btn" style="background: #95a5a6; margin-top: 8px;" onclick="loadExampleData()">
                    📋 טען נתוני דוגמה
                </button>
            </div>

            <div class="results-section" id="resultsSection">
                <div class="rating-display" id="ratingDisplay"></div>
                
                <div class="data-summary">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">סיכום הנתונים</h3>
                    <div class="summary-grid" id="summaryGrid"></div>
                </div>

                <div class="parameters-section">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">פירוט 16 פרמטרי הדירוג</h3>
                    <div class="parameter-header">
                        <div>פרמטר</div>
                        <div>משקל</div>
                        <div>ערך גולמי</div>
                        <div>מנורמל</div>
                        <div>משוקלל</div>
                        <div>נוסחה</div>
                    </div>
                    <div id="parametersDisplay"></div>
                </div>

                <div id="recommendation" class="recommendation"></div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" style="width: auto; margin-left: 10px;" onclick="exportToExcel()">
                        📄 יצא לאקסל
                    </button>
                    <button class="btn" style="width: auto; background: #95a5a6;" onclick="resetForm()">
                        🔄 עסקה חדשה
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // נתוני המערכת
        let transactionsData = [];
        let dbScoreData = [];
        let returnedChecksData = [];
        let sigmaData = [];
        let warningsData = [];
        let socioEconomicData = [];

        // פרמטרי הדירוג לפי הנוסחאות המקוריות
        const creditParameters = [
            { name: 'מספר עסקאות קודמות', weight: 0.15, key: 'previousTransactions' },
            { name: 'מספר חזרות שיקים', weight: 0.05, key: 'returnedChecks' },
            { name: 'חריגה מממוצע ימי אשראי', weight: 0.10, key: 'creditDaysDeviation' },
            { name: 'דירוג D&B (0-100)', weight: 0.08, key: 'dbScore' },
            { name: 'דירוג ענף', weight: 0.05, key: 'sectorScore' },
            { name: 'מסוכנת מהענף שלה', weight: 0.08, key: 'riskierThanSector' },
            { name: 'גיל החברה בשנים', weight: 0.13, key: 'companyAge' },
            { name: 'מחזור שנתי במיליוני ש"ח', weight: 0.03, key: 'annualTurnover' },
            { name: 'מדד סוציואקונומי (1-10)', weight: 0.03, key: 'socioEconomicIndex' },
            { name: 'מספר התרעות', weight: 0.08, key: 'warningsCount' },
            { name: 'המלצה', weight: 0.05, key: 'recommendation' },
            { name: 'מאיפה הבעלים', weight: 0.03, key: 'ownerOrigin' },
            { name: 'דירוג הסניף', weight: 0.01, key: 'branchScore' },
            { name: 'עסקה ממוצעת למושך', weight: 0.10, key: 'averageTransaction' },
            { name: 'המושך והלקוח מאותו מקום', weight: 0.03, key: 'sameLocation' },
            { name: 'ערבות מושך', weight: 0.00, key: 'guarantee' }
        ];

        // טעינת נתוני דוגמה
        function loadExampleData() {
            document.getElementById('customerName').value = 'דוד ישראלי';
            document.getElementById('customerID').value = '514031970';
            document.getElementById('payerName').value = 'חברת הבנייה הגדולה בע"מ';
            document.getElementById('payerID').value = '513456789';
            document.getElementById('checkAmount').value = '85000';
            document.getElementById('checkDate').value = '2024-09-15';
            document.getElementById('creditDays').value = '45';
            document.getElementById('commission').value = '2.5';

            // נתוני דוגמה
            transactionsData = [
                { payerID: '513456789', payerName: 'חברת הבנייה הגדולה בע"מ', transactions: 12, totalAmount: 850000, averageAmount: 70833, creditDays: 38 },
                { payerID: '305346900', payerName: 'איברהים ראבי', transactions: 3, totalAmount: 180000, averageAmount: 60000, creditDays: 42 }
            ];

            dbScoreData = [
                { companyID: '513456789', dbScore: 72, sectorScore: 65, age: 15, employees: 85, turnover: 45 },
                { companyID: '305346900', dbScore: 45, sectorScore: 55, age: 8, employees: 12, turnover: 5.2 }
            ];

            returnedChecksData = [
                { payerID: '513456789', returnedCount: 1 },
                { payerID: '305346900', returnedCount: 0 }
            ];

            warningsData = [
                { companyID: '513456789', warningsCount: 2 },
                { companyID: '305346900', warningsCount: 0 }
            ];

            socioEconomicData = [
                { city: 'תל אביב', index: 8 },
                { city: 'חיפה', index: 6 },
                { city: 'ירושלים', index: 5 }
            ];

            alert('נתוני דוגמה נטענו בהצלחה!');
        }

        // חישוב דירוג האשראי לפי הנוסחאות המקוריות
        function calculateCreditRating() {
            const payerID = document.getElementById('payerID').value;
            const checkAmount = parseFloat(document.getElementById('checkAmount').value) || 0;
            const creditDays = parseInt(document.getElementById('creditDays').value) || 0;

            if (!payerID || !checkAmount) {
                alert('אנא מלא את כל השדות הנדרשים');
                return;
            }

            // חיפוש נתוני המושך
            const payerData = findPayerData(payerID);
            const dbData = findDBData(payerID);
            const returnedData = findReturnedChecksData(payerID);
            const warningsCount = findWarningsData(payerID);

            // חישוב כל פרמטר לפי הנוסחאות המקוריות
            const parameters = calculateAllParameters(payerData, dbData, returnedData, warningsCount, checkAmount, creditDays);
            
            // חישוב הציון הכולל
            const totalScore = calculateTotalScore(parameters);
            
            // קביעת דירוג האותיות
            const letterRating = getLetterRating(totalScore);
            
            // הצגת התוצאות
            displayResults(parameters, totalScore, letterRating, payerData, dbData);
            
            document.getElementById('resultsSection').style.display = 'block';
        }

        function findPayerData(payerID) {
            return transactionsData.find(p => p.payerID === payerID) || {
                payerID: payerID,
                transactions: 0,
                totalAmount: 0,
                averageAmount: 0,
                creditDays: 0
            };
        }

        function findDBData(payerID) {
            return dbScoreData.find(d => d.companyID === payerID) || {
                companyID: payerID,
                dbScore: 30,
                sectorScore: 45,
                age: 5,
                employees: 10,
                turnover: 2
            };
        }

        function findReturnedChecksData(payerID) {
            const data = returnedChecksData.find(r => r.payerID === payerID);
            return data ? data.returnedCount : 0;
        }

        function findWarningsData(payerID) {
            const data = warningsData.find(w => w.companyID === payerID);
            return data ? data.warningsCount : 0;
        }

        function calculateAllParameters(payerData, dbData, returnedCount, warningsCount, checkAmount, creditDays) {
            const parameters = [];

            // 1. מספר עסקאות קודמות
            const transactionsRaw = payerData.transactions || 0;
            let transactionsNormalized;
            if (transactionsRaw >= 100) transactionsNormalized = 1;
            else if (transactionsRaw >= 50) transactionsNormalized = 0.8;
            else if (transactionsRaw >= 20) transactionsNormalized = 0.6;
            else if (transactionsRaw >= 10) transactionsNormalized = 0.4;
            else if (transactionsRaw >= 5) transactionsNormalized = 0.2;
            else transactionsNormalized = 0.1;
            
            if (transactionsRaw === 0) transactionsNormalized = 1; // לפי הנוסחה המקורית
            
            parameters.push({
                name: 'מספר עסקאות קודמות',
                weight: 0.15,
                rawValue: transactionsRaw,
                normalized: transactionsNormalized,
                weighted: transactionsNormalized * 0.15,
                formula: 'MAX(IF(N2>=100,1,IF(N2>=50,0.8,IF(N2>=20,0.6,IF(N2>=10,0.4,IF(N2>=5,0.2,0.1))))),IF(N2=0,1,0.1))'
            });

            // 2. מספר חזרות שיקים
            const returnedRaw = returnedCount || 0;
            const returnedNormalized = returnedRaw === 0 ? 1 : Math.max(0, 1 - returnedRaw * 0.2);
            
            parameters.push({
                name: 'מספר חזרות שיקים',
                weight: 0.05,
                rawValue: returnedRaw,
                normalized: returnedNormalized,
                weighted: returnedNormalized * 0.05,
                formula: 'IF(N3=0, 1, -MAX(0,N3*0.2))'
            });

            // 3. חריגה מממוצע ימי אשראי
            const avgCreditDays = payerData.creditDays || 30;
            const creditDaysDeviation = creditDays - avgCreditDays;
            let creditDaysNormalized;
            if (creditDaysDeviation <= 0) {
                creditDaysNormalized = Math.min(1, 1 - (creditDaysDeviation / 60));
            } else {
                creditDaysNormalized = 1;
            }
            
            parameters.push({
                name: 'חריגה מממוצע ימי אשראי',
                weight: 0.10,
                rawValue: creditDaysDeviation,
                normalized: creditDaysNormalized,
                weighted: creditDaysNormalized * 0.10,
                formula: 'IF(N4 <= 0, MIN(0, 1 - (N4/60),1), 1)'
            });

            // 4. דירוג D&B
            const dbScoreRaw = dbData.dbScore || 30;
            const dbScoreNormalized = dbScoreRaw >= 30 ? dbScoreRaw / 100 : Math.max(0, (dbScoreRaw / 100) - 0.3);
            
            parameters.push({
                name: 'דירוג D&B (0-100)',
                weight: 0.08,
                rawValue: dbScoreRaw,
                normalized: dbScoreNormalized,
                weighted: dbScoreNormalized * 0.08,
                formula: 'IF(N5>=30, N5/100, MAX(0, (N5/100)-0.3))'
            });

            // 5. דירוג ענף
            const sectorScoreRaw = dbData.sectorScore || 32;
            const sectorScoreNormalized = sectorScoreRaw >= 32 ? sectorScoreRaw / 100 : Math.max(0, (sectorScoreRaw / 100) - 0.3);
            
            parameters.push({
                name: 'דירוג ענף',
                weight: 0.05,
                rawValue: sectorScoreRaw,
                normalized: sectorScoreNormalized,
                weighted: sectorScoreNormalized * 0.05,
                formula: 'IF(N6>=32, N6/100, MAX(0, (N6/100)-0.3))'
            });

            // 6. מסוכנת מהענף שלה
            const riskierThanSector = dbScoreRaw < sectorScoreRaw;
            const riskNormalized = riskierThanSector ? Math.min(0, (dbScoreRaw - sectorScoreRaw) / 50) * 10 : 0;
            
            parameters.push({
                name: 'מסוכנת מהענף שלה',
                weight: 0.08,
                rawValue: riskierThanSector ? 'כן' : 'לא',
                normalized: riskNormalized,
                weighted: riskNormalized * 0.08,
                formula: 'IF(N5-N6>=0, 0, MIN(0, (N5-N6)/50)) * 10'
            });

            // 7. גיל החברה בשנים
            const companyAgeRaw = dbData.age || 5;
            let ageNormalized;
            if (companyAgeRaw >= 30) ageNormalized = 1;
            else if (companyAgeRaw >= 20) ageNormalized = 0.8;
            else if (companyAgeRaw >= 10) ageNormalized = 0.6;
            else if (companyAgeRaw >= 5) ageNormalized = 0.4;
            else if (companyAgeRaw >= 3) ageNormalized = 0.2;
            else ageNormalized = 0.1;
            
            parameters.push({
                name: 'גיל החברה בשנים',
                weight: 0.13,
                rawValue: companyAgeRaw,
                normalized: ageNormalized,
                weighted: ageNormalized * 0.13,
                formula: 'IF(N8>=30, 1, IF(N8>=20, 0.8, IF(N8>=10, 0.6, IF(N8>=5, 0.4, IF(N8>=3, 0.2, 0.1)))))'
            });

            // 8. מחזור שנתי במיליוני ש"ח
            const turnoverRaw = dbData.turnover || 2;
            const turnoverNormalized = Math.min(turnoverRaw / 50, 1);
            
            parameters.push({
                name: 'מחזור שנתי במיליוני ש"ח',
                weight: 0.03,
                rawValue: turnoverRaw,
                normalized: turnoverNormalized,
                weighted: turnoverNormalized * 0.03,
                formula: 'MIN(N9/50,1)'
            });

            // 9. מדד סוציואקונומי (1-10)
            const socioIndexRaw = 6; // ברירת מחדל
            const socioIndexNormalized = socioIndexRaw / 10;
            
            parameters.push({
                name: 'מדד סוציואקונומי (1-10)',
                weight: 0.03,
                rawValue: socioIndexRaw,
                normalized: socioIndexNormalized,
                weighted: socioIndexNormalized * 0.03,
                formula: 'N10/10'
            });

            // 10. מספר התרעות
            const warningsRaw = warningsCount || 0;
            const warningsNormalized = Math.max(0, 1 - warningsRaw * 0.2);
            
            parameters.push({
                name: 'מספר התרעות',
                weight: 0.08,
                rawValue: warningsRaw,
                normalized: warningsNormalized,
                weighted: warningsNormalized * 0.08,
                formula: 'MAX(0,1-N11*0.2)'
            });

            // 11. המלצה
            const recommendationRaw = 'כן'; // ברירת מחדל
            const recommendationNormalized = recommendationRaw === 'כן' ? 1 : 0;
            
            parameters.push({
                name: 'המלצה',
                weight: 0.05,
                rawValue: recommendationRaw,
                normalized: recommendationNormalized,
                weighted: recommendationNormalized * 0.05,
                formula: 'IF(N12="כן",1,0)'
            });

            // 12. מאיפה הבעלים
            const ownerOriginRaw = 5; // ברירת מחדל
            const ownerOriginNormalized = ownerOriginRaw / 10;
            
            parameters.push({
                name: 'מאיפה הבעלים',
                weight: 0.03,
                rawValue: ownerOriginRaw,
                normalized: ownerOriginNormalized,
                weighted: ownerOriginNormalized * 0.03,
                formula: 'N13/10'
            });

            // 13. דירוג הסניף
            const branchScoreRaw = 7; // ברירת מחדל
            const branchScoreNormalized = branchScoreRaw / 10;
            
            parameters.push({
                name: 'דירוג הסניף',
                weight: 0.01,
                rawValue: branchScoreRaw,
                normalized: branchScoreNormalized,
                weighted: branchScoreNormalized * 0.01,
                formula: 'N14/10'
            });

            // 14. עסקה ממוצעת למושך
            const avgTransactionRaw = payerData.averageAmount || 50000;
            let avgTransactionNormalized;
            if (checkAmount <= avgTransactionRaw) {
                avgTransactionNormalized = 1;
            } else {
                avgTransactionNormalized = Math.max(0, 1 - (checkAmount / avgTransactionRaw - 1) * 0.5);
            }
            
            parameters.push({
                name: 'עסקה ממוצעת למושך',
                weight: 0.10,
                rawValue: checkAmount / avgTransactionRaw,
                normalized: avgTransactionNormalized,
                weighted: avgTransactionNormalized * 0.10,
                formula: 'IF(C6 <=F7, 1, MAX(0, 1 - (C6/F7 - 1) * 0.5))'
            });

            // 15. המושך והלקוח מאותו מקום
            const sameLocationRaw = 'כן'; // ברירת מחדל
            const sameLocationNormalized = sameLocationRaw === 'כן' ? 1 : 0;
            
            parameters.push({
                name: 'המושך והלקוח מאותו מקום',
                weight: 0.03,
                rawValue: sameLocationRaw,
                normalized: sameLocationNormalized,
                weighted: sameLocationNormalized * 0.03,
                formula: 'IF(N16="כן",1,0)'
            });

            // 16. ערבות מושך
            const guaranteeRaw = 'לא'; // ברירת מחדל
            const guaranteeNormalized = guaranteeRaw === 'כן' ? 15 : 0;
            
            parameters.push({
                name: 'ערבות מושך',
                weight: 0.00, // משקל 0 לפי הנוסחה המקורית
                rawValue: guaranteeRaw,
                normalized: guaranteeNormalized,
                weighted: guaranteeNormalized * 0.00,
                formula: 'IF(N18="כן",15,0)'
            });

            return parameters;
        }

        function calculateTotalScore(parameters) {
            // חישוב הציון הכולל לפי הנוסחה המקורית
            let totalWeighted = 0;
            parameters.forEach(param => {
                totalWeighted += param.weighted;
            });
            
            // הכפלה ב-100 והגבלה בין 0 ל-100
            return Math.max(0, Math.min(100, totalWeighted * 100));
        }

        function getLetterRating(score) {
            if (score >= 90) return 'AAA';
            if (score >= 80) return 'AA';
            if (score >= 70) return 'A';
            if (score >= 60) return 'BBB';
            if (score >= 50) return 'BB';
            if (score >= 40) return 'B';
            if (score >= 30) return 'CCC';
            return 'D';
        }

        function displayResults(parameters, totalScore, letterRating, payerData, dbData) {
            // הצגת הדירוג הראשי
            const ratingDisplay = document.getElementById('ratingDisplay');
            ratingDisplay.innerHTML = `
                <div class="rating-card">
                    <div class="rating-score rating-${letterRating}">${letterRating}</div>
                    <div style="color: #7f8c8d; font-size: 14px;">דירוג אשראי</div>
                </div>
                <div class="rating-card">
                    <div class="rating-score" style="color: #3498db;">${totalScore.toFixed(1)}</div>
                    <div style="color: #7f8c8d; font-size: 14px;">ציון מספרי</div>
                </div>
                <div class="rating-card">
                    <div class="rating-score" style="color: #e67e22;">${payerData.transactions}</div>
                    <div style="color: #7f8c8d; font-size: 14px;">עסקאות קודמות</div>
                </div>
                <div class="rating-card">
                    <div class="rating-score" style="color: #27ae60;">${dbData.dbScore}</div>
                    <div style="color: #7f8c8d; font-size: 14px;">ציון D&B</div>
                </div>
            `;

            // הצגת סיכום הנתונים
            const summaryGrid = document.getElementById('summaryGrid');
            summaryGrid.innerHTML = `
                <div class="summary-item">
                    <div class="summary-value">${payerData.totalAmount.toLocaleString()}</div>
                    <div class="summary-label">סכום כולל עסקאות קודמות</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${payerData.averageAmount.toLocaleString()}</div>
                    <div class="summary-label">עסקה ממוצעת</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value">${dbData.age}</div>
                    <div class="summary-label">גיל החברה (שנים)</div>
                </div>
            `;

            // הצגת פרטי הפרמטרים
            const parametersDisplay = document.getElementById('parametersDisplay');
            let parametersHTML = '';
            
            parameters.forEach(param => {
                parametersHTML += `
                    <div class="parameter-row">
                        <div class="parameter-name">
                            ${param.name}
                            <div class="parameter-description">משקל: ${(param.weight * 100).toFixed(0)}%</div>
                        </div>
                        <div>${(param.weight * 100).toFixed(0)}%</div>
                        <div>${typeof param.rawValue === 'number' ? param.rawValue.toFixed(2) : param.rawValue}</div>
                        <div>${param.normalized.toFixed(3)}</div>
                        <div>${param.weighted.toFixed(4)}</div>
                        <div class="formula-display">${param.formula}</div>
                    </div>
                `;
            });
            
            parametersDisplay.innerHTML = parametersHTML;

            // הצגת המלצה
            const recommendation = document.getElementById('recommendation');
            recommendation.className = `recommendation ${letterRating}`;
            
            let recommendationText = '';
            switch (letterRating) {
                case 'AAA':
                case 'AA':
                    recommendationText = '✅ מומלץ מאוד - סיכון נמוך, לקוח איכותי';
                    break;
                case 'A':
                    recommendationText = '⚠️ מומלץ בהסתייגות - סיכון בינוני, יש לעקוב';
                    break;
                case 'BBB':
                case 'BB':
                    recommendationText = '🔍 זהירות - סיכון מוגבר, נדרש מעקב צמוד';
                    break;
                case 'B':
                case 'CCC':
                    recommendationText = '❌ לא מומלץ - סיכון גבוה, שקול דחייה';
                    break;
                case 'D':
                    recommendationText = '🚫 דחה - סיכון גבוה מאוד, לא לאשר';
                    break;
            }
            
            recommendation.textContent = recommendationText;
        }

        function exportToExcel() {
            const data = [];
            const parameters = document.querySelectorAll('.parameter-row');
            
            // כותרות
            data.push(['פרמטר', 'משקל', 'ערך גולמי', 'מנורמל', 'משוקלל', 'נוסחה']);
            
            // נתונים
            parameters.forEach(row => {
                const cells = row.querySelectorAll('div');
                if (cells.length > 0) {
                    data.push([
                        cells[0].textContent.split('\n')[0], // שם הפרמטר בלבד
                        cells[1].textContent,
                        cells[2].textContent,
                        cells[3].textContent,
                        cells[4].textContent,
                        cells[5].textContent
                    ]);
                }
            });
            
            // יצירת קובץ אקסל
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "דירוג אשראי");
            
            // הורדת הקובץ
            const fileName = `דירוג_אשראי_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function resetForm() {
            // איפוס כל השדות
            document.getElementById('customerName').value = '';
            document.getElementById('customerID').value = '';
            document.getElementById('payerName').value = '';
            document.getElementById('payerID').value = '';
            document.getElementById('checkAmount').value = '';
            document.getElementById('checkDate').value = '';
            document.getElementById('creditDays').value = '';
            document.getElementById('commission').value = '';
            
            // הסתרת התוצאות
            document.getElementById('resultsSection').style.display = 'none';
        }

        // טיפול בהעלאת קבצים
        document.getElementById('dataFiles').addEventListener('change', function(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        let data;
                        if (file.name.toLowerCase().endsWith('.csv')) {
                            const text = e.target.result;
                            const parsed = Papa.parse(text, { 
                                header: true, 
                                skipEmptyLines: true,
                                encoding: 'UTF-8'
                            });
                            data = parsed.data;
                        } else {
                            const workbook = XLSX.read(e.target.result, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            data = XLSX.utils.sheet_to_json(firstSheet);
                        }

                        // זיהוי סוג הקובץ ועיבוד מתאים
                        const fileName = file.name.toLowerCase();
                        if (fileName.includes('עסקאות') || fileName.includes('transactions')) {
                            processTransactionsFile(data);
                        } else if (fileName.includes('score') || fileName.includes('דירוג')) {
                            processDBScoreFile(data);
                        } else if (fileName.includes('חוזרים') || fileName.includes('returned')) {
                            processReturnedChecksFile(data);
                        } else if (fileName.includes('התרעות') || fileName.includes('warnings')) {
                            processWarningsFile(data);
                        }

                        console.log(`קובץ ${file.name} נטען בהצלחה:`, data.length, 'רשומות');
                    } catch (error) {
                        console.error('שגיאה בטעינת קובץ:', file.name, error);
                        alert(`שגיאה בטעינת קובץ ${file.name}: ${error.message}`);
                    }
                };

                if (file.name.toLowerCase().endsWith('.csv')) {
                    reader.readAsText(file, 'UTF-8');
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
        });

        function processTransactionsFile(data) {
            transactionsData = [];
            const payersMap = new Map();

            data.forEach(row => {
                const payerID = row['מספר זהות מושך'] || row['מס זהות מושך'] || row['payerID'];
                const payerName = row['שם מושך'] || row['payerName'];
                const amount = parseFloat(row['סכום'] || row['amount']) || 0;
                const creditDays = parseInt(row['ימי אשראי'] || row['creditDays']) || 0;

                if (payerID) {
                    if (!payersMap.has(payerID)) {
                        payersMap.set(payerID, {
                            payerID: payerID,
                            payerName: payerName || '',
                            transactions: 0,
                            totalAmount: 0,
                            averageAmount: 0,
                            creditDays: 0,
                            totalCreditDays: 0
                        });
                    }

                    const payer = payersMap.get(payerID);
                    payer.transactions++;
                    payer.totalAmount += amount;
                    payer.totalCreditDays += creditDays;
                    payer.averageAmount = payer.totalAmount / payer.transactions;
                    payer.creditDays = payer.totalCreditDays / payer.transactions;
                }
            });

            transactionsData = Array.from(payersMap.values());
        }

        function processDBScoreFile(data) {
            dbScoreData = data.map(row => ({
                companyID: row['מס\' ח.פ'] || row['מספר חברה'] || row['companyID'],
                dbScore: parseFloat(row['סקור'] || row['score']) || 30,
                sectorScore: parseFloat(row['סקור ענף'] || row['sectorScore']) || 45,
                age: parseInt(row['שנות ותק'] || row['age']) || 5,
                employees: parseInt(row['מס\' מועסקים'] || row['employees']) || 10,
                turnover: parseFloat(row['מחזור בא\' ₪'] || row['turnover']) || 2
            }));
        }

        function processReturnedChecksFile(data) {
            returnedChecksData = data.map(row => ({
                payerID: row['מספר זהות'] || row['payerID'],
                returnedCount: parseInt(row['חזרות'] || row['returned']) || 0
            }));
        }

        function processWarningsFile(data) {
            warningsData = data.map(row => ({
                companyID: row['מספר חברה'] || row['companyID'],
                warningsCount: parseInt(row['התרעות'] || row['warnings']) || 0
            }));
        }

        // אתחול המערכת
        document.addEventListener('DOMContentLoaded', function() {
            console.log('מערכת חיתום אשראי מוכנה - 16 פרמטרים');
        });
    </script>
</body>
</html>
